var app=app||{};var SearchCodesModel=Backbone.Model.extend({defaults:{label:'',dbs:'',code:''}});var SearchCodesCollection=Backbone.Collection.extend({model:SearchCodesModel})
var AdvOptionFieldsModel=Backbone.Model.extend({defaults:{label:'',code:'',mask:0}});var AdvOptionsCollection=Backbone.Collection.extend({comparator:'label',model:AdvOptionFieldsModel});var DocumentTypes=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Journal article',code:'JA',mask:14689347}),new AdvOptionFieldsModel({label:'Conference article',code:'CA',mask:2106371}),new AdvOptionFieldsModel({label:'Conference proceedings',code:'conference-proceedings',mask:12582912}),new AdvOptionFieldsModel({label:'Conference proceeding',code:'CP',mask:2097155}),new AdvOptionFieldsModel({label:'Book chapter',code:'CH',mask:3413027}),new AdvOptionFieldsModel({label:'Book',code:'BK',mask:16003363}),new AdvOptionFieldsModel({label:'Report chapter',code:'RC',mask:2098179}),new AdvOptionFieldsModel({label:'Standard',code:'ST',mask:3}),new AdvOptionFieldsModel({label:'Report review',code:'RR',mask:2098179}),new AdvOptionFieldsModel({label:'Dissertation',code:'DS',mask:2098179}),new AdvOptionFieldsModel({label:'Map',code:'MP',mask:2097152}),new AdvOptionFieldsModel({label:'In Process',code:'GI',mask:2097152}),new AdvOptionFieldsModel({label:'Abstract',code:'AB',mask:1024}),new AdvOptionFieldsModel({label:'Unpublished paper',code:'UP',mask:2}),new AdvOptionFieldsModel({label:'Editorial',code:'ED',mask:1}),new AdvOptionFieldsModel({label:'Erratum',code:'ER',mask:1}),new AdvOptionFieldsModel({label:'Note',code:'NO',mask:1}),new AdvOptionFieldsModel({label:'Patents (before 1970)',code:'PA',mask:1}),new AdvOptionFieldsModel({label:'Patents (before 1977)',code:'PA',mask:2}),new AdvOptionFieldsModel({label:'Patents',code:'PA',mask:64}),new AdvOptionFieldsModel({label:'Article in Press',code:'IP',mask:1}),new AdvOptionFieldsModel({label:'Conferences',code:'(CA or CP)',mask:64}),new AdvOptionFieldsModel({label:'Other documents',code:'MC or MR or RC or RR or DS or UP',mask:64}),new AdvOptionFieldsModel({label:'European Applications',code:'EA',mask:16384}),new AdvOptionFieldsModel({label:'European Granted',code:'EG',mask:16384}),new AdvOptionFieldsModel({label:'US Applications',code:'UA',mask:32768}),new AdvOptionFieldsModel({label:'US Granted',code:'UG',mask:32768}),new AdvOptionFieldsModel({label:'Journal article',code:'Journal	',mask:256}),new AdvOptionFieldsModel({label:'Advertisement',code:'Advertizement',mask:256}),new AdvOptionFieldsModel({label:'Directory',code:'Directory',mask:256}),new AdvOptionFieldsModel({label:'Company Report',code:'Company',mask:256}),new AdvOptionFieldsModel({label:'Stockbroker Report',code:'Stockbroker',mask:256}),new AdvOptionFieldsModel({label:'Market Research Report',code:'Market',mask:256}),new AdvOptionFieldsModel({label:'Press Release',code:'Press',mask:256})]);var DisciplineTypes=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Physics',code:'A',mask:2}),new AdvOptionFieldsModel({label:'Electrical/Electronic engineering',code:'B',mask:2}),new AdvOptionFieldsModel({label:'Computers/Control engineering',code:'C',mask:2}),new AdvOptionFieldsModel({label:'Information technology',code:'D',mask:2}),new AdvOptionFieldsModel({label:'Manufacturing and production engineering',code:'E',mask:2})]);var TreatmentTypes=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Applications',code:'APP',mask:3}),new AdvOptionFieldsModel({label:'Biographical',code:'BIO',mask:1}),new AdvOptionFieldsModel({label:'Bibliography',code:'BIB',mask:2}),new AdvOptionFieldsModel({label:'Economic',code:'ECO',mask:3}),new AdvOptionFieldsModel({label:'Experimental',code:'EXP',mask:3}),new AdvOptionFieldsModel({label:'General review',code:'GEN',mask:3}),new AdvOptionFieldsModel({label:'Historical',code:'HIS',mask:1}),new AdvOptionFieldsModel({label:'Literature review',code:'LIT',mask:1}),new AdvOptionFieldsModel({label:'Management aspects',code:'MAN',mask:1}),new AdvOptionFieldsModel({label:'Numerical',code:'NUM',mask:1}),new AdvOptionFieldsModel({label:'New development',code:'NEW',mask:2}),new AdvOptionFieldsModel({label:'Practical',code:'PRA',mask:2}),new AdvOptionFieldsModel({label:'Product review',code:'PRO',mask:2}),new AdvOptionFieldsModel({label:'Theoretical',code:'THR',mask:3})]);var Languages=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'English',code:'English',mask:14740935}),new AdvOptionFieldsModel({label:'Chinese',code:'Chinese',mask:14740935}),new AdvOptionFieldsModel({label:'French',code:'French',mask:14740935}),new AdvOptionFieldsModel({label:'German',code:'German',mask:14740935}),new AdvOptionFieldsModel({label:'Italian',code:'Italian',mask:14737799}),new AdvOptionFieldsModel({label:'Japanese',code:'Japanese',mask:14740935}),new AdvOptionFieldsModel({label:'Russian',code:'Russian',mask:14740935}),new AdvOptionFieldsModel({label:'Spanish',code:'Spanish',mask:14740935})]);var AutoStemmingOptions=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Turn autostemming off',code:'true'})]);var ExpertAutoStemmingOptions=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Turn autostemming off',code:'true',selected:true})]);var SortingOptions=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Relevance',code:'relevance',selected:true}),new AdvOptionFieldsModel({label:'Date (Newest)',code:'yr',selected:false})]);var BrowseIndexes=new AdvOptionsCollection([new AdvOptionFieldsModel({label:'Author',index:'AUS',type:'AUTHOR',title:'Author Index will open in a new window',qsmask:2106567,esmask:2106567}),new AdvOptionFieldsModel({label:'Inventor',index:'AUS',type:'INVENTOR',title:'Inventor Index will open in a new window',qsmask:51200,esmask:51200}),new AdvOptionFieldsModel({label:'Author/Inventor',index:'AUS',type:'AUTHORINVENTOR',title:'Author/Inventor Index will open in a new window',qsmask:2157767,esmask:2157767}),new AdvOptionFieldsModel({label:'Author affiliation',index:'AF',type:'AFFILIATION',title:'Author affiliation Index will open in a new window',qsmask:2106567,esmask:2106567}),new AdvOptionFieldsModel({label:'Assignee',index:'AF',type:'ASSIGNEE',title:'Assignee Index will open in a new window',qsmask:51200,esmask:51200}),new AdvOptionFieldsModel({label:'Affiliation/Assignee',index:'AF',type:'AFFILIATIONASSIGNEE',title:'Affiliation/Assignee Index will open in a new window',qsmask:2157767,esmask:2157767}),new AdvOptionFieldsModel({label:'Controlled term',index:'CVS',type:'CONTROLLEDTERM',title:'Controlled term Index will open in a new window',qsmask:2108871,esmask:2108871}),new AdvOptionFieldsModel({label:'Language',index:'LA',type:'LANGUAGE',title:'Language Index will open in a new window',qsmask:0,esmask:2108871}),new AdvOptionFieldsModel({label:'Source title',index:'ST',type:'SOURCE',title:'Source title Index will open in a new window',qsmask:2106819,esmask:2106819}),new AdvOptionFieldsModel({label:'Document type',index:'DT',type:'DOCUMENT',title:'Document type Index will open in a new window',qsmask:0,esmask:2106819}),new AdvOptionFieldsModel({label:'Publisher',index:'PN',type:'PUBLISHER',title:'Publisher Index will open in a new window',qsmask:2098243,esmask:2098243}),new AdvOptionFieldsModel({label:'Treatment',index:'TR',type:'TREATMENT',title:'Treatment Index will open in a new window',qsmask:0,esmask:3}),new AdvOptionFieldsModel({label:'Country',index:'PC',type:'COUNTRY',title:'Country Index will open in a new window',qsmask:2048,esmask:2048}),new AdvOptionFieldsModel({label:'Discipline',index:'DI',type:'DISIPLINE',title:'Discipline Index will open in a new window',qsmask:0,esmask:2}),new AdvOptionFieldsModel({label:'IPC Code',index:'PID',type:'IPCCODE',title:'IPC Code Index will open in a new window',qsmask:2,esmask:2})]);var AdvTabModel=Backbone.Model.extend({defaults:{name:'',href:'',title:'',fields:new AdvOptionsCollection(),fieldType:'checkbox'}});var AdvTabsCollection=Backbone.Collection.extend({model:AdvTabModel});var AdvOptionsView=Backbone.Marionette.View.extend({template:_.template($('#ev-advoptions-template').html()),tagname:'div',autoStemOff:false,initialize:function(options){app.model.on('searchSubmit',this.hideAdvOptions,this);app.model.on('hideAdvancedOptions',this.hideAdvOptions,this);Backbone.Radio.channel("sessionsettingschannel").off("sessionsettings:update",this.updateTabs);Backbone.Radio.channel("sessionsettingschannel").on("sessionsettings:update",this.updateTabs,this);this.databaseCheckBoxView=new DatabaseCheckBoxView(QuickExpertsearchFormDatabase);if(!_.isUndefined(options)&&!_.isUndefined(options.version)){this.version=options.version;}
this.autoStemOff=!app.userSession.attributes.enabledFences.AUTOSTEMMING;},setVersion:function(version){this.version=version;},render:function(){if((_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues)||_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues.attributes.databasemask))){this.updateTabs();}else{if(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues.attributes.databasemask==app.sessionSettings.attributes.userMask){this.updateTabs();}else{Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{userMask:app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues.attributes.databasemask});}}
return this;},renderSearchCodes:function(){if(_.isUndefined(this.searchCodesView)){this.searchCodesView=new SearchCodesView({dbCheckBoxView:this.databaseCheckBoxView});}
this.$el.find("#search-codes-container").html(this.searchCodesView.render().el);},updateTabs:function(changedSessionSettings){if((!_.isUndefined(changedSessionSettings))){if(_.isUndefined(changedSessionSettings.userMask)&&_.isUndefined(changedSessionSettings.sort)&&_.isUndefined(changedSessionSettings.advOptionsDisplay)){this.checkTovalidateForm();return;}}
var currentTab=this.$el.find("#adv-options-tabs li.active a.tabLink").attr("id");var wasOpen;var isResults=app.getParamByName("SEARCHID",document.url)||null;var dbMaskChange=!_.isUndefined(changedSessionSettings)&&!_.isUndefined(changedSessionSettings.userMask);var advOptionsDisplayChange=!_.isUndefined(changedSessionSettings)&&!_.isUndefined(changedSessionSettings.advOptionsDisplay);if(this.$el.find("#adv-options-bottom").length==0){if(isResults){wasOpen=false;}else{wasOpen=!("closed"==app.sessionSettings.attributes.advOptionsDisplay);}}else{if(advOptionsDisplayChange){wasOpen=!("closed"==app.sessionSettings.attributes.advOptionsDisplay);}else if(isResults&&!dbMaskChange){wasOpen=false;}else{wasOpen=this.$el.find("#adv-options-bottom").is(":visible");}}
advTabsCollection=this.getAdvTabsCollection(this.version);if(currentTab===undefined||changedSessionSettings&&changedSessionSettings.sort){_.each(advTabsCollection.get("sort").attributes.fields.models,function(m){if(m.attributes.code==app.sessionSettings.attributes.sort){m.attributes.selected=true;}else{m.attributes.selected=false;}});}
this.$el.html(this.template({tabs:advTabsCollection.toJSON(),isOpen:wasOpen,needsDBs:this.version!='thesaurus'}));var tabs=this.$el.find("#adv-options-tabs .tabLink");this.$el.find("#adv-options-tabs .tabLink").on("click",this.tabClick);this.$el.find("#adv-options-tabs .tabLink").on("keydown",this.tabClickOnKey);this.$el.find("#adv-options-tabs .tabLink").on("hidden.bs.tab",this.updateTabArrow);this.$el.find("#browseIndex-tab-content .ev-bi-link a").on("click",this.openBrowseIndex);this.$el.find("#date-tab-content select").select2({minimumResultsForSearch:Infinity,width:'40%'});if(this.version!='thesaurus'){this.databaseCheckBoxView.render(this.$el);}
if(this.version=='expert'){this.renderSearchCodes();this.$el.find(".adv-options-search-btn").css("width",0);this.$el.find(".adv-options-search-btn a").attr("id","expertSearch");}else if(this.version=='thesaurus'){this.$el.find(".adv-options-search-btn").hide();}else{this.$el.find(".adv-options-search-btn").show();}
var currentPage=Backbone.history.location.pathname;if((currentPage=="/search/quick.url"||currentPage=="/search/expert.url")&&(currentTab===undefined||(changedSessionSettings&&changedSessionSettings.advOptionsDisplay))){currentTab=app.sessionSettings.attributes.advOptionsDisplay+"-tab";if("closed-tab"===currentTab){if(this.$el.find("#adv-options-bottom").is(":visible")){this.$el.find("#adv-options-bottom").collapse('toggle');}
this.checkTovalidateForm();return;}
var t=this.$el.find("#"+currentTab);if(t.length==1){if(t.parent().hasClass("disabled")){this.$el.find("#database-tab").parent().removeClass('active');this.$el.find("#database-tab").parent().addClass('collapsed');this.$el.find("#database-tab").collapse();this.$el.find("#database-tab-content").removeClass('active');this.$el.find("#adv-options-bottom").collapse();this.checkTovalidateForm();return;}
this.$el.find(".tab-pane.active").removeClass('active');t.tab('show');t.parent().addClass('active');t.parent().removeClass('collapsed');this.$el.find("#"+currentTab+"-content").addClass('active');this.$el.find("#adv-options-bottom").show();}}else if(currentPage=='/search/thesaurus.url'){if(wasOpen){if(this.$el.find('#'+currentTab).parent().hasClass("disabled")){}else{this.$el.find('#'+currentTab).click();}}}
if(this.autoStemOff==true){$("input[name='autostem']").prop("checked",true);}else{$("input[name='autostem']").prop("checked",false);}
this.checkTovalidateForm();},checkTovalidateForm:function(){if(!_.isUndefined(app.sessionSettings.attributes.userMask)&&app.sessionSettings.attributes.userMask!=0&&!_.isUndefined(app.getRegion().currentView.searchView)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues)){this.populateForm(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues);}},populateForm:function(vals){this.$el.find("input[value='NO-LIMIT']").prop("checked",true);this.$el.find("select").each(function(){if(!_.isEmpty(vals.get($(this).attr("name")))){$(this).val(vals.get($(this).attr("name"))).select2({minimumResultsForSearch:Infinity,width:'40%'});}});if(!_.isUndefined(vals.attributes.databasemask)){var dbmask=Number(vals.attributes.databasemask),$dbcheckboxes=this.$el.find("#database-tab-content :checkbox");if(app.allDbMask==dbmask){$dbcheckboxes.prop("checked",true);}else{$dbcheckboxes.prop("checked",false);$dbcheckboxes.each(function(){var mask=parseInt($(this).attr("ev-mask"));if((mask&Number(vals.attributes.databasemask))==mask){$(this).prop("checked",true);}});}}
if(!_.isUndefined(vals.attributes.documenttype)&&vals.attributes.documenttype!='NO-LIMIT'){this.$el.find("#doctype-tab-content input[value='"+vals.attributes.documenttype+"']").prop("checked",true);}
if(!_.isUndefined(vals.attributes.language)){this.$el.find("#language-tab-content input[value='"+vals.attributes.language+"']").prop("checked",true);}
if(!_.isUndefined(vals.attributes.treatmentType)){this.$el.find("#treatmentType-tab-content input[value='"+vals.attributes.treatmentType+"']").prop("checked",true);}
if(!_.isUndefined(vals.attributes.disciplinetype)){this.$el.find("#disciplinetype-tab-content input[value='"+vals.attributes.disciplinetype+"']").prop("checked",true);}
if(!_.isUndefined(vals.attributes.sort)){this.$el.find("#sort-tab-content input[value='"+vals.attributes.sort+"']").prop("checked",true);}
if(!_.isUndefined(vals.attributes.updatesNo)&&!_.isNull(vals.attributes.updatesNo)){this.$el.find("#date-tab-content input[value='lastupdate']").prop("checked",true);this.$el.find("#updates-no").val(vals.attributes.updatesNo);this.$el.find("#date-tab-content select").select2({minimumResultsForSearch:Infinity,width:'40%'});}else{this.$el.find("#date-tab-content input[value='yearrange']").prop("checked",true);var resetYear=false;if((_.isUndefined(vals.attributes.startYear)||_.isNull(vals.attributes.startYear)||_.isEmpty(vals.attributes.startYear))||_.isUndefined(vals.attributes.endYear)||_.isNull(vals.attributes.endYear)||_.isEmpty(vals.attributes.endYear)||((!_.isUndefined(app.sessionSettings.attributes.userMask)||!_.isUndefined(vals.attributes.databasemask))&&vals.attributes.databasemask!=app.sessionSettings.attributes.userMask)&&vals.attributes.searchtype!="Thesaurus"){resetYear=true;}
if(!resetYear||this.isYearAvailable(vals.attributes.startYear)||this.isYearAvailable(vals.attributes.endYear)){this.$el.find("#start-year").val(vals.attributes.startYear);this.$el.find("#end-year").val(vals.attributes.endYear);}else{$("#start-year").val($("#start-year option:first").val());$("#end-year").val($("#end-year option:first").val());}
this.$el.find("#date-tab-content select").select2({minimumResultsForSearch:Infinity,width:'40%'});}
if(_.isUndefined(vals.attributes.autostem)&&app.getRegion().currentView.searchView.searchFormView.model.attributes.type=='expert'){$("input[name='autostem']").prop("checked",true);this.autoStemOff=true;}
if(!_.isUndefined(vals.attributes.autostem)){if(vals.attributes.autostem=='off'){$("input[name='autostem']").prop("checked",true);this.autoStemOff=true;}else{$("input[name='autostem']").prop("checked",false);this.autoStemOff=false;}}},isYearAvailable:function(year){$("#start-year select.select option").each(function(){if($(this).val()==year){return true;}});return false;},getAdvTabsCollection:function(version){if(version=='expert'){return new AdvTabsCollection([new AdvTabModel({id:"date",name:"Date",href:"#date-tab-content",title:"Date Range",template:"dateFields",fieldType:'date'}),new AdvTabModel({id:"sort",name:"Sort by",href:"#sort-tab-content",title:"Choose how results are sorted",fieldType:'radio',fields:SortingOptions}),new AdvTabModel({id:"autostem",name:"Autostemming",href:"#autostem-tab-content",title:"Turn off Autostemming",fields:ExpertAutoStemmingOptions}),new AdvTabModel({id:"search-codes",name:"Search codes",href:"#search-codes-tab-content",title:"Search codes",fieldType:'codes',fields:SearchCodes}),new AdvTabModel({id:"browseIndex",name:"Browse indexes",href:"#browseIndex-tab-content",title:"Choose Browse indexes",fieldType:'link',fields:new AdvOptionsCollection(BrowseIndexes.filter(function(field){if(app.sessionSettings.attributes.userMask==0)return false;else if(app.sessionSettings.attributes.userMask==2158023)return(field.attributes.type=='ASSIGNEE'||field.attributes.type=='INVENTOR'||field.attributes.type=='AUTHOR'||field.attributes.type=='AFFILIATION')?false:true;else if(field.attributes.type=='AUTHORINVENTOR')return((app.effectiveDbMask()&2106567)!=0&&(app.effectiveDbMask()&51200)!=0);else if(field.attributes.type=='AFFILIATIONASSIGNEE')return((app.effectiveDbMask()&2106567)!=0&&(app.effectiveDbMask()&51200)!=0);else if($('#databases-container .ev-checkbox-input:checked').length==1)return((field.attributes.esmask&app.effectiveDbMask())==app.effectiveDbMask());else if(field.attributes.type=='AUTHOR')return((app.effectiveDbMask()&2157767)!=0&&(app.effectiveDbMask()&51200)==0);else if(field.attributes.type=='AFFILIATION')return((app.effectiveDbMask()&2157767)!=0&&(app.effectiveDbMask()&51200)==0);else if(field.attributes.type=='COUNTRY')return((app.effectiveDbMask()&2048)!=0);else if(field.attributes.type=='TREATMENT')return((app.effectiveDbMask()&3)!=0);else if(field.attributes.type=='PUBLISHER')return((app.effectiveDbMask()&2098243)!=0);else if(field.attributes.type=='ASSIGNEE'||field.attributes.type=='INVENTOR')return((app.effectiveDbMask()==49152)||!((app.effectiveDbMask()|2048)==app.effectiveDbMask()||(app.effectiveDbMask()|32768)==app.effectiveDbMask()||(app.effectiveDbMask()|16384)==app.effectiveDbMask()));else if((app.effectiveDbMask()==51200||app.effectiveDbMask()==49152)&&(field.attributes.type=='DOCUMENT'||field.attributes.type=='SOURCE'))return false;else if(app.effectiveDbMask()==49152&&((field.attributes.type=='CONTROLLEDTERM'||field.attributes.type=='LANGUAGE')))return false;else return(field.attributes.esmask&app.effectiveDbMask()==app.effectiveDbMask()?true:((field.attributes.esmask|app.effectiveDbMask())==app.effectiveDbMask()));}))})]);}else if(version=='thesaurus'){return new AdvTabsCollection([new AdvTabModel({id:"date",name:"Date",href:"#date-tab-content",title:"Date Range",template:"dateFields",fieldType:'date'}),new AdvTabModel({id:"doctype",name:"Document type",href:"#doctype-tab-content",title:"Choose a Document type",fieldType:'radio',fields:new AdvOptionsCollection(DocumentTypes.filter(function(field){return((field.attributes.mask&app.effectiveThesDbMask())==app.effectiveThesDbMask())}))}),new AdvTabModel({id:"language",name:"Language",href:"#language-tab-content",title:"Choose a Language",fieldType:'radio',fields:new AdvOptionsCollection(Languages.filter(function(field){return((field.attributes.mask&app.effectiveThesDbMask())==app.effectiveThesDbMask())}))}),new AdvTabModel({id:"disciplinetype",name:"Discipline",href:"#disciplinetype-tab-content",title:"Choose a Discipline",fieldType:'radio',fields:new AdvOptionsCollection(DisciplineTypes.filter(function(field){return((field.attributes.mask&app.effectiveThesDbMask())==app.effectiveThesDbMask())}))}),new AdvTabModel({id:"treatmentType",name:"Treatment",href:"#treatmentType-tab-content",title:"Choose a Treatment",fieldType:'radio',fields:new AdvOptionsCollection(TreatmentTypes.filter(function(field){return((field.attributes.mask&app.effectiveThesDbMask())==app.effectiveThesDbMask())}))}),new AdvTabModel({id:"sort",name:"Sort by",href:"#sort-tab-content",title:"Choose how results are sorted",fieldType:'radio',fields:SortingOptions})]);}else{if(this.autoStemOff){AutoStemmingOptions.models[0].set('selected',true);}
return new AdvTabsCollection([new AdvTabModel({id:"date",name:"Date",href:"#date-tab-content",title:"Date Range",template:"dateFields",fieldType:'date'}),new AdvTabModel({id:"language",name:"Language",href:"#language-tab-content",title:"Choose a Language",fieldType:'radio',fields:new AdvOptionsCollection(Languages.filter(function(field){return((field.attributes.mask&app.effectiveDbMask())==app.effectiveDbMask())}))}),new AdvTabModel({id:"doctype",name:"Document type",fieldType:'radio',href:"#doctype-tab-content",title:"Choose a Document type",fields:new AdvOptionsCollection(DocumentTypes.filter(function(field){return((field.attributes.mask&app.effectiveDbMask())==app.effectiveDbMask())}))}),new AdvTabModel({id:"sort",name:"Sort by",href:"#sort-tab-content",title:"Choose how results are sorted",fieldType:'radio',fields:SortingOptions}),new AdvTabModel({id:"browseIndex",name:"Browse indexes",href:"#browseIndex-tab-content",title:"Choose Browse indexes",fieldType:'link',fields:new AdvOptionsCollection(BrowseIndexes.filter(function(field){if(app.effectiveDbMask()==2158023)return false;else if(field.attributes.type=='AUTHORINVENTOR')return((app.effectiveDbMask()&2106567)!=0&&(app.effectiveDbMask()&51200)!=0&&(app.effectiveDbMask()&256)==0);else if(field.attributes.type=='AFFILIATIONASSIGNEE')return((app.effectiveDbMask()&2106567)!=0&&(app.effectiveDbMask()&51200)!=0&&(app.effectiveDbMask()&256)==0);else return((field.attributes.qsmask&app.effectiveDbMask())==app.effectiveDbMask());}))}),new AdvTabModel({id:"autostem",name:"Autostemming",href:"#autostem-tab-content",title:"Turn off Autostemming",fields:AutoStemmingOptions}),new AdvTabModel({id:"disciplinetype",name:"Discipline",href:"#disciplinetype-tab-content",title:"Choose a Discipline",fieldType:'radio',fields:new AdvOptionsCollection(DisciplineTypes.filter(function(field){return((field.attributes.mask&app.effectiveDbMask())==app.effectiveDbMask())}))}),new AdvTabModel({id:"treatmentType",name:"Treatment",href:"#treatmentType-tab-content",title:"Choose a Treatment",fieldType:'radio',fields:new AdvOptionsCollection(TreatmentTypes.filter(function(field){return((field.attributes.mask&app.effectiveDbMask())==app.effectiveDbMask())}))})]);}},hideAdvOptions:function(){if($("#adv-options-bottom").is(':visible')){$("#adv-options-bottom").collapse('hide');}},toggleAdvOptions:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;$("#adv-options-bottom").collapse('toggle');},tabClick:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($(this).parent().hasClass("disabled")){return;}
if($(this).parent().hasClass('active')){$(this).parent().toggleClass('collapsed');$("#adv-options-bottom").collapse('toggle');}else{if(!$("#adv-options-bottom").is(":visible")){$("#adv-options-bottom").collapse('toggle');}
$(this).tab('show');$(this).parent().removeClass('collapsed');}},tabClickOnKey:function(e){if(e.keyCode===40){$(e.target).click();return false;}},updateTabArrow:function(e){$(e.target).parent().addClass("collapsed");},openBrowseIndex:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var browseindexWindow,$link=$(e.target),lookupindex=$link.is('a')?$link.data('index'):$link.parent().data('index'),selectedDatabaseMask=app.effectiveDbMask(),formType=app.getRegion().currentView.searchView.currentSearchFormType=="quick"?"Quick":"Expert",browseindexlookuptype=$link.is('a')?$link.data('type'):$link.parent().data('type');var tabloc="/search/browseindex.url?database="+selectedDatabaseMask
+"&lookup="+lookupindex
+"&searchtype="+formType
+"&browseindexlookuptype="+browseindexlookuptype;if(!browseindexWindow||browseindexWindow.closed){browseindexWindow=window.open(tabloc,"Engineering Village - Browse Index Lookup","height=600,width=650,top=0,left="
+((screen.width*.35))+","
+"scrollbars=yes,menubar=no,resizable=yes,"
+"toolbar=no,location=no,directories=no");}else{browseindexWindow.location=tabloc;browseindexWindow.focus();}}});var SearchCodesView=Backbone.Marionette.View.extend({template:_.template($('#ev-searchcodes-template').html()),tagName:'div',className:'codes',events:{},initialize:function(options){this.databaseCheckBoxView=options.dbCheckBoxView;},render:function(){this.$el.html(this.template({searchcodes:this.getMatchingSearchCodes()}));return this;},getMatchingSearchCodes:function(){var currentDbs=this.databaseCheckBoxView.getSelectedDbs(app.effectiveDbMask());var filteredSearchCodes=SearchCodes.filter(function(code){var intersection=_.intersection(code.attributes.dbs.split(/[\s]*,[\s]*/),currentDbs.map(function(db,index){return db.attributes.searchcode}));if(intersection.length>0){code.set('filteredCodes',intersection);return true;}
return false;});return{currentDbs:currentDbs,codes:filteredSearchCodes};}});var SearchCodes=new SearchCodesCollection([new SearchCodesModel({label:"Abstract",dbs:"c, i, n, pc, cm, cb, el, ep, g, f, u, e, k",code:"AB"}),new SearchCodesModel({label:"Accession number",dbs:"c, i, n, pc, el, ep, g, f, k",code:"AN"}),new SearchCodesModel({label:"Affiliation/Assignee",dbs:"c, i, n, pc, cm, el, ep, g, f, u, e",code:"AF"}),new SearchCodesModel({label:"All fields",dbs:"c, i, n, pc, cm, cb, el, g, f, u, e, k",code:"ALL"}),new SearchCodesModel({label:"Annotation",dbs:"f",code:"ANN"}),new SearchCodesModel({label:"Astronomical indexing",dbs:"i",code:"AI"}),new SearchCodesModel({label:"Author/Inventor",dbs:"c, i, n, pc, el, ep, g, f, u, e, k",code:"AU"}),new SearchCodesModel({label:"Availability",dbs:"n, cb, f",code:"AV"}),new SearchCodesModel({label:"CAS registry number",dbs:"cm, cb, el, ep",code:"CR"}),new SearchCodesModel({label:"Chemical Acronyms",dbs:"cb",code:"CE"}),new SearchCodesModel({label:"Chemical indexing",dbs:"i",code:"CI"}),new SearchCodesModel({label:"Chemicals",dbs:"cb",code:"CM"}),new SearchCodesModel({label:"Classification code",dbs:"c, i, cm, el, ep, g, f",code:"CL"}),new SearchCodesModel({label:"CODEN",dbs:"c, i, pc, cm, cb, f",code:"CN"}),new SearchCodesModel({label:"Companies",dbs:"pc, cb",code:"CP"}),new SearchCodesModel({label:"Conference code",dbs:"c, pc, el",code:"CC"}),new SearchCodesModel({label:"Conference information",dbs:"c, i, el, f",code:"CF"}),new SearchCodesModel({label:"Contract number",dbs:"n",code:"CT"}),new SearchCodesModel({label:"Controlled term/Subject Area",dbs:"c, i, n, pc, cm, cb, el, ep, g, f, k",code:"CV"}),new SearchCodesModel({label:"Controlled term as a product",dbs:"el, ep",code:"CVP"}),new SearchCodesModel({label:"Controlled term as a reagent",dbs:"el, ep",code:"CVA"}),new SearchCodesModel({label:"Controlled term with no role",dbs:"el, ep",code:"CVN"}),new SearchCodesModel({label:"Country of application",dbs:"c, pc",code:"PU"}),new SearchCodesModel({label:"Country of origin ",dbs:"c, i, n, cm, cb, el, g, f, u, e",code:"CO"}),new SearchCodesModel({label:"Derwent accession number",dbs:"ep",code:"AJ"}),new SearchCodesModel({label:"Derwent IPC",dbs:"ep",code:"DPID"}),new SearchCodesModel({label:"Discipline",dbs:"i",code:"DI"}),new SearchCodesModel({label:"DOI",dbs:"c, i,  pc, cm, el, g, k",code:"DOI"}),new SearchCodesModel({label:"Document type",dbs:"c, i, n, pc, cm, cb, el, g, f, k",code:"DT"}),new SearchCodesModel({label:"ECLA code",dbs:"e",code:"PEC"}),new SearchCodesModel({label:"Ei main heading",dbs:"c",code:"MH"}),new SearchCodesModel({label:"Funding acronym",dbs:"c, pc, cm, el, g",code:"GFA"}),new SearchCodesModel({label:"Funding number",dbs:"c, pc, cm, el, g",code:"GFN"}),new SearchCodesModel({label:"Funding sponsor",dbs:"c, pc, cm, el, g",code:"GAG"}),new SearchCodesModel({label:"Industrial Sectors",dbs:"cb",code:"GD"}),new SearchCodesModel({label:"Int.patent classification",dbs:"ep, u, e",code:"PID"}),new SearchCodesModel({label:"ISBN",dbs:"c, i, pc, cb, el, g, f, k",code:"BN"}),new SearchCodesModel({label:"ISSN",dbs:"c, i, pc, cm, cb, el, g, f",code:"SN"}),new SearchCodesModel({label:"Issue",dbs:"c, i, pc, cm, el, g, f",code:"SU"}),new SearchCodesModel({label:"Language",dbs:"c, i, n, pc, cm, cb, el, ep, g, f, k",code:"LA"}),new SearchCodesModel({label:"Linked term",dbs:"el, ep",code:"LT"}),new SearchCodesModel({label:"Major term",dbs:"el, ep",code:"CVM"}),new SearchCodesModel({label:"Major term as a product",dbs:"el, ep",code:"CVMP"}),new SearchCodesModel({label:"Major term as a reagent",dbs:"el, ep",code:"CVMA"}),new SearchCodesModel({label:"Major term with no role",dbs:"el, ep",code:"CVMN"}),new SearchCodesModel({label:"Map Scale",dbs:"f",code:"MS"}),new SearchCodesModel({label:"Map Type",dbs:"f",code:"MP"}),new SearchCodesModel({label:"Material identity number",dbs:"i",code:"MI"}),new SearchCodesModel({label:"Monitoring agency",dbs:"n",code:"AG"}),new SearchCodesModel({label:"Notes",dbs:"n",code:"NT"}),new SearchCodesModel({label:"see Numerical Data Codes",dbs:"c,i",code:"NU",href:"/help/topic.url?topic=25929"}),new SearchCodesModel({label:"Numerical indexing",dbs:"i",code:"NI"}),new SearchCodesModel({label:"Original classification code",dbs:"i",code:"OC"}),new SearchCodesModel({label:"Patent application country",dbs:"ep, u, e",code:"PCO"}),new SearchCodesModel({label:"Patent application date",dbs:"c, n, pc, ep, u, e",code:"PA"}),new SearchCodesModel({label:"Patent application number",dbs:"ep, u, e",code:"PAM"}),new SearchCodesModel({label:"Patent attorney name",dbs:"u, e",code:"PAN"}),new SearchCodesModel({label:"Patent authority code",dbs:"ep, u, e",code:"PAC"}),new SearchCodesModel({label:"Patent citation",dbs:"u,  e",code:"PCI"}),new SearchCodesModel({label:"Patent Country",dbs:"ep",code:"PC"}),new SearchCodesModel({label:"Patent examiner",dbs:"u, e",code:"PE"}),new SearchCodesModel({label:"Patent filing date",dbs:"u, e",code:"PFD"}),new SearchCodesModel({label:"Patent issue date",dbs:"c, n, pc, u, e",code:"PI"}),new SearchCodesModel({label:"Patent number",dbs:"c, pc, ep, u, e",code:"PM"}),new SearchCodesModel({label:"Patent priority information",dbs:"ep, u, e",code:"PRN"}),new SearchCodesModel({label:"Priority country",dbs:"ep",code:"PRC"}),new SearchCodesModel({label:"Priority date",dbs:"ep",code:"PRD"}),new SearchCodesModel({label:"Publication date",dbs:"u, e",code:"PD"}),new SearchCodesModel({label:"Publication year",dbs:"c, el, f, k",code:"YR"}),new SearchCodesModel({label:"Publisher",dbs:"c, i, pc, cm, el, g, f, k",code:"PN"}),new SearchCodesModel({label:"Geographic terms",dbs:"g",code:"RGI"}),new SearchCodesModel({label:"Report number",dbs:"n,  f",code:"RN"}),new SearchCodesModel({label:"Role",dbs:"el, ep",code:"RO"}),new SearchCodesModel({label:"SIC Codes",dbs:"cb",code:"IC"}),new SearchCodesModel({label:"Source",dbs:"el, k",code:"SO"}),new SearchCodesModel({label:"Source note",dbs:"f",code:"SNO"}),new SearchCodesModel({label:"Source title",dbs:"c, i, pc, cm, cb, el, g, f, k",code:"ST"}),new SearchCodesModel({label:"Subject/Title/Abstract",dbs:"c, i, n, pc, cm, cb, el, ep, g, f,<br/>u, e, k",code:"KY"}),new SearchCodesModel({label:"Title",dbs:"c, i, n, pc, cm, cb, el, ep, g, f, u, e, k",code:"TI"}),new SearchCodesModel({label:"Collection title",dbs:"f",code:"VT"}),new SearchCodesModel({label:"Treatment type",dbs:"c, i, pc",code:"TR"}),new SearchCodesModel({label:"Type of Degree",dbs:"f",code:"DE"}),new SearchCodesModel({label:"Uncontrolled term",dbs:"c, i, n, pc, el, ep, g, f",code:"FL"}),new SearchCodesModel({label:"US classification",dbs:"u",code:"PUC"}),new SearchCodesModel({label:"Volume",dbs:"c, i, pc, cm, el, g, f",code:"VO"})]);var app=app||{};var SearchFormDatabaseModel=Backbone.Model.extend({defaults:{label:'',code:'',searchcode:'',mask:0,startyr:1666,endyr:new Date().getFullYear(),defaultstartyr:0,selected:false}});var SearchFormDatabasesCollection=Backbone.Collection.extend({model:SearchFormDatabaseModel});var cpxDatabase=new SearchFormDatabaseModel({label:'Compendex',textZoneKey:'COMPENDEX_SELECTED_START_YEAR',searchcode:'c',code:'cpx',mask:1,startyr:1969});var cpxFrontDatabase=new SearchFormDatabaseModel({label:'Compendex',searchcode:'c',code:'c84',mask:32,startyr:1884});var eiBackFileDatabase=new SearchFormDatabaseModel({label:'Ei Backfile',searchcode:'c',code:'zbf',mask:262144,startyr:1884,endyr:1969});var insDatabase=new SearchFormDatabaseModel({label:'Inspec',textZoneKey:'INSPEC_SELECTED_START_YEAR',searchcode:'i',code:'ins',mask:2,startyr:1969});var insFrontDatabase=new SearchFormDatabaseModel({label:'Inspec',searchcode:'i',code:'ibf',mask:4096,startyr:1896});var inspecArchiveDatabase=new SearchFormDatabaseModel({label:'Inspec Archive',textZoneKey:'INSPEC_ARC_STAND_START_YEAR',searchcode:'ib',code:'ibs',mask:1048576,startyr:1896,endyr:1968});var ntiDatabase=new SearchFormDatabaseModel({label:'NTIS',textZoneKey:'NTIS_SELECTED_START_YEAR',searchcode:'n',code:'nti',mask:4,startyr:1899});var pchDatabase=new SearchFormDatabaseModel({label:'PaperChem',textZoneKey:'PAPER_CHEM_SELECTED_START_YEAR',searchcode:'pc',code:'pch',mask:64,startyr:1967});var chmDatabase=new SearchFormDatabaseModel({label:'Chimica',textZoneKey:'CHIMICA_SELECTED_START_YEAR',searchcode:'cm',code:'chm',mask:128,startyr:1970});var cbnDatabase=new SearchFormDatabaseModel({label:'CBNB',textZoneKey:"CBNB_SELECTED_START_YEAR",searchcode:'cb',code:'cbn',mask:256,startyr:1985});var eltDatabase=new SearchFormDatabaseModel({label:'EnCompassLIT',textZoneKey:'ENCOMPASS_LIT_SELECTED_START_YEAR',searchcode:'el',code:'elt',mask:1024,startyr:1962});var eptDatabase=new SearchFormDatabaseModel({label:'EnCompassPAT',textZoneKey:'ENCOMPASS_PAT_SELECTED_START_YEAR',searchcode:'ep',code:'ept',mask:2048,startyr:1963});var eltThesDatabase=new SearchFormDatabaseModel({label:'EnCompass',textZoneKey:'ENCOMPASS_LIT_SELECTED_START_YEAR',searchcode:'el',code:'elt',mask:1024,startyr:1962});var eptThesDatabase=new SearchFormDatabaseModel({label:'EnCompass',textZoneKey:'ENCOMPASS_PAT_SELECTED_START_YEAR',searchcode:'ep',code:'ept',mask:2048,startyr:1963});var eptltDatabase=new SearchFormDatabaseModel({label:'EnCompass',searchcode:'ep',code:'ept',mask:3072,startyr:1962});var geoDatabase=new SearchFormDatabaseModel({label:'GEOBASE',textZoneKey:'GEOBASE_SELECTED_START_YEAR',searchcode:'g',code:'geo',mask:8192,startyr:1973});var grfDatabase=new SearchFormDatabaseModel({label:'GeoRef',textZoneKey:'GEOREF_SELECTED_START_YEAR',searchcode:'f',code:'grf',mask:2097152,startyr:1666});var upaDatabase=new SearchFormDatabaseModel({label:'US Patents',textZoneKey:'US_PATENTS_SELECTED_START_YEAR',searchcode:'u',code:'upa',mask:32768,startyr:1790});var eupDatabase=new SearchFormDatabaseModel({label:'EP Patents',textZoneKey:'EUROPEAN_PATENTS_SELECTED_START_YEAR',searchcode:'e',code:'eup',mask:16384,startyr:1978});var kncDatabase=new SearchFormDatabaseModel({label:'Knovel',searchcode:'k',code:'knc',mask:4194304,startyr:1969});var knaDatabase=new SearchFormDatabaseModel({label:'Knovel',searchcode:'k',code:'kna',mask:8388608,startyr:1969});var ThesMask=2108419;var DatabaseCheckBoxView=Backbone.Marionette.View.extend({template:_.template($('#ev-database-template').html()),all_database:true,initialize:function(databases){this.databases=this.checkStartYears(databases);Backbone.Radio.channel("sessionsettingschannel").off("sessionsettings:update",this.onSessionsettingsUpdate);Backbone.Radio.channel("sessionsettingschannel").on("sessionsettings:update",this.onSessionsettingsUpdate,this);Backbone.Radio.channel("databasechannel").reply("startyear:get",this.getMinStartYear,this);this.loadCheck();},checkStartYears:function(dbs){_.each(dbs.models,function(db){if(!_.isUndefined(db)&&!_.isUndefined(db.attributes.textZoneKey)){startYr=parseInt(_.chain(app.userSession.attributes.userTextZones).pick(db.attributes.textZoneKey).values().value()[0]);if(!isNaN(startYr)){db.attributes.startyr=startYr;}}});return dbs;},loadCheck:function(){if(_.isString(app.sessionSettings.attributes.userMask)){app.sessionSettings.attributes.userMask=parseInt(app.sessionSettings.attributes.userMask)}
app.model.set('startYr',this.getMinStartYear(app.sessionSettings.attributes.userMask));app.model.set('endYr',this.getMaxEndYear(app.sessionSettings.attributes.userMask));},getActualMask:function(mask){if((cpxDatabase.attributes.mask&mask)==cpxDatabase.attributes.mask){if((cpxFrontDatabase.attributes.mask&app.model.attributes.entitleddatabasemask)==cpxFrontDatabase.attributes.mask){return mask+cpxFrontDatabase.attributes.mask;}}else if((insDatabase.attributes.mask&mask)==insDatabase.attributes.mask){if((insFrontDatabase.attributes.mask&app.model.attributes.entitleddatabasemask)==insFrontDatabase.attributes.mask){return mask+insFrontDatabase.attributes.mask;}}
return mask;},events:{"click #databases-container :checkbox":"clicked","click #all-checkb":"allClick"},render:function(parent){if(_.isUndefined(parent)){this.setElement($("#database-row"))
this.$dbsCheckBoxContent=$("#databases-container");}else{this.setElement(parent.find("#database-row"))
this.$dbsCheckBoxContent=parent.find("#databases-container");}
this.$dbsCheckBoxContent.html(this.template({databases:this.databases.toJSON()}));var dbStatus=this.checkDatabase(this.databases.toJSON());if(this.checkDatabase(this.databases.toJSON())==1){$("#all-checkb").prop("checked",false);$("#all-databases-container").hide();this.checkSingleDatabase();}else if(this.$("#databases-container :checkbox:checked").length==this.$("#databases-container :checkbox").length){$("#all-checkb").prop("checked",true)}
return this;},checkSingleDatabase:function(){var self=this;var firstTime=self.all_database,clerTime='';function checkExist(){if($("#all-databases-container").length>0){$("#all-checkb").prop("checked",false);$("#all-databases-container").hide();if(firstTime){self.all_database=false;clearTimeout(clerTime);}}else{clerTime=setTimeout(checkExist,1000);}};checkExist();},checkDatabase:function(databases){var count=0;_.each(databases,function(database,index){if((database.mask&app.model.attributes.entitleddatabasemask)==database.mask){count++;}});return count;},allClick:function(e){if($(e.target).is(":checked")){this.$dbsCheckBoxContent.find(':checkbox').prop("checked",true);this.propagateMaskChange();}else{this.$dbsCheckBoxContent.find(':checkbox').prop("checked",false);this.propagateMaskChange();}},clicked:function(e){var $target=$(e.target);if(!$target.is(':checkbox'))$target=$target.find('input:checkbox');this.processAllCheckbox();this.propagateMaskChange();},processAllCheckbox:function(){if((this.$("#databases-container :checkbox:checked").length==this.$("#databases-container :checkbox").length)&&$("#all-checkb").is(":visible")){$("#all-checkb").prop("checked",true)}else{$("#all-checkb").prop("checked",false);}},calculateSelectedMask:function(){var newMask=0;$("#databases-container :checkbox:checked").each(function(){var mask=parseInt($(this).attr("ev-mask"));newMask+=mask;});return newMask;},propagateMaskChange:function(){var newMask=this.calculateSelectedMask();app.model.set('startYr',this.getMinStartYear(newMask));app.model.set('endYr',this.getMaxEndYear(newMask));Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{userMask:newMask});},getMinStartYear:function(mask){if(_.isUndefined(mask)||mask<=0){return 1666;}
var actualMask=this.getActualMask(mask);return _.min(allAvailableDatabases.filter(function(db){return(db.attributes.mask&actualMask)==db.attributes.mask}).map(function(db,indext){return db.attributes.startyr}))},getMaxEndYear:function(mask){if(_.isUndefined(mask)||mask<=0){return new Date().getFullYear()+1;}
var actualMask=this.getActualMask(mask);return _.max(allAvailableDatabases.filter(function(db){return(db.attributes.mask&actualMask)==db.attributes.mask}).map(function(db,indext){return db.attributes.endyr}))},getSelectedDbs:function(mask){return QuickExpertsearchFormDatabase.filter(function(db){return(db.attributes.mask&mask)==db.attributes.mask});},getSearchCodesList:function(mask){return QuickExpertsearchFormDatabase.filter(function(db){return(db.attributes.mask&mask)==db.attributes.mask}).map(function(db,indext){return db.attributes.searchcode})},onSessionsettingsUpdate:function(changedAttrs){if(changedAttrs.userMask&&changedAttrs.userMask!=this.calculateSelectedMask()){$("#databases-container :checkbox[ev-mask]").each(function(){var mask=parseInt($(this).attr("ev-mask"));if(mask==(mask&changedAttrs.userMask)){$(this).prop("checked",true);}else{$(this).prop("checked",false);}});this.processAllCheckbox();}}});var allAvailableDatabases=new SearchFormDatabasesCollection([cpxDatabase,cpxFrontDatabase,eiBackFileDatabase,insDatabase,insFrontDatabase,inspecArchiveDatabase,ntiDatabase,pchDatabase,chmDatabase,cbnDatabase,eltDatabase,eptDatabase,geoDatabase,grfDatabase,upaDatabase,eupDatabase,kncDatabase,knaDatabase]);var app=app||{};var ENTER_KEY=13;var SearchFormDatabaseModel=Backbone.Model.extend({defaults:{label:'',code:'',mask:0,startyr:0,endyr:new Date().getFullYear(),defaultstartyr:0,selected:true}})
var SearchFormDatabasesCollection=Backbone.Collection.extend({model:SearchFormDatabaseModel});var SearchFieldModel=Backbone.Model.extend({defaults:{label:'',code:'',mask:0}});var SearchEntityModel=Backbone.Model.extend({url:'/search/searchentityjson.url',defaults:{},getSearchEntity:function(entity,callBack){if(!_.isEmpty(entity)){var urlParams=''
for(var key in entity){urlParams+="&"+key+"="+entity[key];}
this.fetch({data:urlParams+"&angularReq=true",contentType:"application/json",success:function(){callBack();}});}}})
var AuthorSearchEntityModel=Backbone.Model.extend({url:'/search/author/searchentityjson.url',defaults:{},getAuthorSearchEntity:function(searchId,callBack){if(!_.isUndefined(searchId)){this.fetch({data:"&searchid="+searchId+"&angularReq=true",contentType:"application/json",success:function(){callBack();},error:function(){callBack();}});}}});var AffiliationSearchEntityModel=Backbone.Model.extend({url:'/search/affil/searchentityjson.url',defaults:{},getAffiliationSearchEntity:function(searchId,callBack){if(!_.isUndefined(searchId)){this.fetch({data:"&searchid="+searchId+"&angularReq=true",contentType:"application/json",success:function(){callBack();},error:function(){callBack();}});}}});var SearchFieldsCollection=Backbone.Collection.extend({model:SearchFieldModel});var SearchFields=new SearchFieldsCollection([new SearchFieldModel({label:'All fields',code:'NO-LIMIT',mask:16051655}),new SearchFieldModel({label:'Subject/Title/Abstract',code:'KY',mask:16051655}),new SearchFieldModel({label:'Abstract',code:'AB',mask:16051655}),new SearchFieldModel({label:'Author',code:'AU',mask:16000199}),new SearchFieldModel({label:'Author affiliation',code:'AF',mask:2368711}),new SearchFieldModel({label:'Inventor',code:'AU',mask:51200}),new SearchFieldModel({label:'Assignee',code:'AF',mask:51200}),new SearchFieldModel({label:'Title',code:'TI',mask:16051655}),new SearchFieldModel({label:'Ei Classification code',code:'CL',mask:262145}),new SearchFieldModel({label:'Geographic terms',code:'RGI',mask:8192}),new SearchFieldModel({label:'Classification code',code:'CL',mask:1056770}),new SearchFieldModel({label:'CODEN',code:'CN',mask:2359299}),new SearchFieldModel({label:'Conference information',code:'CF',mask:3408899}),new SearchFieldModel({label:'Collection title',code:'VT',mask:2097152}),new SearchFieldModel({label:'ISBN',code:'	BN',mask:14680064}),new SearchFieldModel({label:'Conference code',code:'CC',mask:1}),new SearchFieldModel({label:'ISSN',code:'	SN',mask:2106819}),new SearchFieldModel({label:'Ei main heading',code:'MH',mask:262145}),new SearchFieldModel({label:'Publisher',code:'PN',mask:15991875}),new SearchFieldModel({label:'Source title',code:'ST',mask:16000451}),new SearchFieldModel({label:'Patent number',code:'PM',mask:3196930}),new SearchFieldModel({label:'Filing date',code:'PA',mask:2}),new SearchFieldModel({label:'Patent issue date',code:'	PI',mask:2}),new SearchFieldModel({label:'Country of application',code:'PU',mask:2}),new SearchFieldModel({label:'Material Identity Number',code:'MI',mask:2}),new SearchFieldModel({label:'Controlled term',code:'CV',mask:3419207}),new SearchFieldModel({label:'Subject Area',code:'CV',mask:12582912}),new SearchFieldModel({label:'Uncontrolled term',code:'FL',mask:2108487}),new SearchFieldModel({label:'Contract number',code:'CT',mask:4}),new SearchFieldModel({label:'Country of origin',code:'CO',mask:2416647}),new SearchFieldModel({label:'Monitoring agency',code:'AG',mask:4}),new SearchFieldModel({label:'NTIS accession number',code:'AN',mask:4}),new SearchFieldModel({label:'Publication date',code:'PD',mask:49152}),new SearchFieldModel({label:'Application number',code:'PAM',mask:49152}),new SearchFieldModel({label:'Priority number',code:'PRN',mask:49152}),new SearchFieldModel({label:'Int. patent classification',code:'PID',mask:51202}),new SearchFieldModel({label:'CAS registry number',code:'CR',mask:3072}),new SearchFieldModel({label:'Patent country',code:'PC',mask:2048}),new SearchFieldModel({label:'ECLA code',code:'	PEC',mask:16384}),new SearchFieldModel({label:'US classification',code:'PUC',mask:32768}),new SearchFieldModel({label:'Report number',code:'RN',mask:4}),new SearchFieldModel({label:'Funding number',code:'GFN',mask:271553}),new SearchFieldModel({label:'Funding acronym',code:'GFA',mask:271553}),new SearchFieldModel({label:'Funding sponsor',code:'GAG',mask:271553}),]);var SearchFieldRowModel=Backbone.Model.extend({defaults:{rowId:1,connector:'',searchField:'ALL',searchTerm:''}});var SearchFieldRowCollection=Backbone.Collection.extend({model:SearchFieldRowModel});var SearchFormModel=Backbone.Model.extend({defaults:{type:'quick',title:'Engineering Village - Quick Search',mask:3,databases:null,doctypes:null,treatmenttypes:null,languages:null,searchRows:new SearchFieldRowCollection([new SearchFieldRowModel()])},initialize:function(){}});var SearchFieldRowView=BaseFeatureView.extend({template:_.template($("#ev-searchform-row").html()),sfTemplate:_.template($("#ev-search-field-template").html()),events:{},initialize:function(options){Backbone.Radio.channel("sessionsettingschannel").off("sessionsettings:update",this.updateFields);Backbone.Radio.channel("sessionsettingschannel").on("sessionsettings:update",this.updateFields,this);this.collection.on({'add':this.addRow,'remove':this.removeRow,'reset':this.removeAll},this);},render:function(){if(this.collection.size()-1>0){this.collection.each(function(row,index){if(index==0){return;}
this.addRow(row);},this)}
this.updateFields();this.addAutoSuggesttoRow('1');},removeAll:function(){this.$("#searchBtn").detach().insertAfter("#first-search-row .underline-v2");$(".search-row-copy").remove();},addRow:function(row){var newRow=this.template({row:row});this.$searchBtn=this.$("#searchBtn");if(this.$(".search-row-copy").length==0){newRow=$(newRow).insertAfter(this.$("#first-search-row"));}else{newRow=$(newRow).insertAfter(this.$(".search-row-copy:last"));}
searchFieldHtml=this.sfTemplate({fields:this.getFilteredSearchFields()});$(newRow).find('select.section').html(searchFieldHtml);this.$(".search-row-copy:last select.section").select2({minimumResultsForSearch:Infinity,width:'100%'});this.$(".search-row-copy:last select.boolean").select2({minimumResultsForSearch:Infinity,width:'50%'});this.$searchBtn.detach().insertAfter(this.$(".search-row-copy:last .underline-v2"));this.addAutoSuggesttoRow(row.cid);SearchResultsView.prototype.renameSearchRows();},getFilteredSearchFields:function(){return SearchFields.filter(function(field){return(field.attributes.mask&app.effectiveDbMask())==app.effectiveDbMask();});},updateFields:function(changedAttrs){if(!_.isNull(changedAttrs)&&!_.isUndefined(changedAttrs)){if(_.isUndefined(changedAttrs.userMask)){return;}}
var sectionJsons=this.getFilteredSearchFields();searchFieldHtml=this.sfTemplate({fields:sectionJsons});this.$('select.section').html(searchFieldHtml);if(!_.isUndefined(changedAttrs)&&!_.isEmpty(changedAttrs.userMask)){var optionCodeString;_.each(sectionJsons,function(sectionJson,index){optionCodeString=optionCodeString+sectionJson.attributes.code;});if(!_.isUndefined(app.getRegion().currentView.searchView)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues)){var vals=app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues
for(var key in vals.attributes){if(vals.attributes.hasOwnProperty(key)){var lastKeyVal=key.slice(-1);if(lastKeyVal=="1"||lastKeyVal=="2"||lastKeyVal=="3"){if(key.indexOf('section')>-1){if($("select[name='"+key+"']").length==0){}else{if(optionCodeString.indexOf(vals.attributes[key])!==-1)
$("select[name='"+key+"']").val(vals.attributes[key]).select2({minimumResultsForSearch:Infinity,width:'100%'});}}}}}
if(!_.isUndefined(vals.attributes.sectionStr)){var sections=vals.attributes.sectionStr.split("|");_.each(sections,function(section,index){if(optionCodeString.indexOf(section)!==-1){$($("select[name='sections']")[index]).val(section).select2({minimumResultsForSearch:Infinity,width:'100%'});}});}}}},removeRow:function(row){var searchBtn=this.$searchBtn.detach();$("#row_"+row.cid).remove();if($(".search-row-copy").length>0){this.$searchBtn.detach().insertAfter(".search-row-copy:last .underline-v2");}else{this.$searchBtn.detach().insertAfter("#first-search-row .underline-v2");}
return true;},addAutoSuggesttoRow:function(cid){this.filteredlist=new Backbone.AutocompleteList({url:function(){return'/autocomplete?term='+$('#autocomplete-remote'+cid+' #search-word-'+cid).val()},filter:null,limit:11,cid:cid,el:$('#autocomplete-remote'+cid+' #search-word-'+cid),results:$('.autocomplete-results'),template:_.template('<p id="suggest" class="suggP" role="option">{{ if(isUseTerms){ }} &nbsp;&nbsp; <span style="font-style: italic;"> Recommended terms: </span>{{ } }} {{=mainTermDisplay}}</p>'),delay:500,minLength:3,autoSuggestTemplate:_.template('<div class="typeaheadFooter"><span style="float: left;"><span	style="font-family: sans-serif; font-weight: bold; font-size: 12px; padding: 0px;margin-right: 7px">AutoSuggest</span><span style="font-size: 11px; padding: 0px;;margin-right: 7px"><i>Powered by </i></span>	Ei Thesaurus</span><span class="acToggle"> <a id="turn_off" href="#" class="acOff" onclick="">Turn off</a>	</span>	<div></div></div>'),value:function(model){var txt=model.get('mainTermSearch');txt=txt.replace(/\(/g,'');txt=txt.replace(/\)/g,'');if(txt.indexOf(" OR ")>0){txt=txt.replace(/ OR /g,'" OR "');txt='"'+txt+'"';}
return txt;},}).resultsView.collection.parse=function(resp){var returnDetails='{"list":[';var len=resp.length;_.each(resp,function(section,index){if(section.hasUseTerms){if(index==len-1){returnDetails=returnDetails+'{"mainTermDisplay":"'+section.mainTermDisplay+'", "mainTermSearch":"'+section.mainTermSearch+'", "isUseTerms":false},';returnDetails=returnDetails+'{"mainTermDisplay":"'+section.useTerms.mainTermDisplay+'", "mainTermSearch":"'+section.useTerms.mainTermSearch+'", "isUseTerms":true}';}else{returnDetails=returnDetails+'{"mainTermDisplay":"'+section.mainTermDisplay+'", "mainTermSearch":"'+section.mainTermSearch+'", "isUseTerms":false},'
returnDetails=returnDetails+'{"mainTermDisplay":"'+section.useTerms.mainTermDisplay+'", "mainTermSearch":"'+section.useTerms.mainTermSearch+'", "isUseTerms":true},';}}else{if(index==len-1){returnDetails=returnDetails+'{"mainTermDisplay":"'+section.mainTermDisplay+'", "mainTermSearch":"'+section.mainTermSearch+'", "isUseTerms":false}'}else{returnDetails=returnDetails+'{"mainTermDisplay":"'+section.mainTermDisplay+'", "mainTermSearch":"'+section.mainTermSearch+'", "isUseTerms":false},'}}});returnDetails=returnDetails+']}';var json=JSON.parse(returnDetails);return json.list;};},updateSearchFields:function(){$("select.section").each(function(){searchFieldHtml=this.sfTemplate({fields:SearchFields.toJSON()});$(this).html(searchFieldHtml);$(this).select2({minimumResultsForSearch:Infinity,width:'100%'});});}});var SearchFormsCollection=Backbone.Collection.extend({model:SearchFormModel});var SearchView=BaseFeatureView.extend({$searchForm:$('#ev-searchform-container'),$searchResultsContainer:$('#ev-searchresults-container'),$searchContainer:$('#ev-search-container'),$tablist:$("#ev-tablist"),$navigationLink:$('.ev-navigation-links'),el:'#ev-search-container',authorFormValues:{},events:{"keydown #first-search-row":"enterSubmit","keydown #author-search-col":"enterSubmit","keydown #orcid-search-col":"enterSubmit","keydown #second-search-row":"enterSubmit","keydown #third-search-row":"enterSubmit","keydown #affil-search-row":"enterSubmit",'change #updates-no':'updateElements','change #start-year':'updateElements','change #end-year':'updateElements'},initialize:function(){this.searchFormViewCache=[];this.formValues={};var twoRows=new SearchFieldRowCollection([new SearchFieldRowModel(),new SearchFieldRowModel({rowId:2}),]);var oneRow=new SearchFieldRowCollection([new SearchFieldRowModel()]);this.searchForms=new SearchFormsCollection([new SearchFormModel({type:'quick',url:"quick",title:'Engineering Village - Quick Search',mask:1,searchRows:oneRow,templateElement:'#ev-quick-searchform-template'}),new SearchFormModel({type:'expert',url:"expert",title:'Engineering Village - Expert Search',mask:3,templateElement:'#ev-expert-searchform-template'}),new SearchFormModel({type:'thesaurus',url:"thesaurus",title:'Engineering Village - Thesaurus Search',mask:4,templateElement:'#ev-thes-searchform-template'}),new SearchFormModel({type:'author',url:"author",title:'Engineering Village - Author Search',mask:5,templateElement:'#ev-author-searchform-template'}),new SearchFormModel({type:'affiliation',url:"affiliation",title:'Engineering Village - Affiliation Search',mask:5,templateElement:'#ev-affil-searchform-template'}),new SearchFormModel({type:'searchHistory',url:"searchHistory",title:'Engineering Village - Search history',mask:0,templateElement:'#ev-search-history-template'})]);this.formValues=new SearchEntityModel();this.authorFormValues=new AuthorSearchEntityModel();this.affilFormValues=new AffiliationSearchEntityModel();if(!_.isUndefined(app.getRegion().currentView.searchResultViewCache)&&!_.isEmpty(app.getRegion().currentView.searchResultViewCache)){this.searchResultsView=app.getRegion().currentView.searchResultViewCache;app.getRegion().currentView.searchResultViewCache=""}else{this.searchResultsView=new SearchResultsView();}
this.authorSearchResultsView=new AuthorSearchResultsView();this.affilSearchResultsView=new AffiliationSearchResultsView();app.model.on("searchSubmit",this.runSearch,this);app.model.on("authorSearchSubmit",this.runAuthorSearch,this);app.model.on("affilSearchSubmit",this.runAffiliationSearch,this);app.model.on("searchSubmitLink",this.runSearchFromLink,this);app.model.on("updateSearchEntity",this.updateSearchEntity,this);app.model.on("updateAuthorSearchEntity",this.updateAuthorSearchEntity,this);app.model.on("updateAffiliationSearchEntity",this.updateAffiliationSearchEntity,this);},updateSearchEntity:function(newSearchEntity){if(!_.isUndefined(this.searchFormView)&&!_.isUndefined(this.searchFormView.model.attributes)&&!_.isUndefined(newSearchEntity)&&!_.isEmpty(newSearchEntity)&&(this.formValues.attributes.searchId!=newSearchEntity.searchId)){this.formValues=new SearchEntityModel(newSearchEntity);this.searchFormView.model.attributes.formValues=this.formValues;this.searchFormView.populateAndRenderForm();}},updateAuthorSearchEntity:function(newSearchEntity){if(!_.isUndefined(newSearchEntity)&&!_.isEmpty(newSearchEntity)){this.authorFormValues=new AuthorSearchEntityModel(newSearchEntity);}},updateAffiliationSearchEntity:function(newSearchEntity){if(!_.isUndefined(newSearchEntity)&&!_.isEmpty(newSearchEntity)){this.affilFormValues=new AffiliationSearchEntityModel(newSearchEntity);}},getSearchFormView:function(version){var form;if(this.searchForms.length>0){form=this.searchForms.where({url:version})[0];if(!form||_.isUndefined(form)){form=this.searchForms.where({type:'quick'})[0];}
document.title=form.attributes.title;if(!_.isUndefined(this.searchFormView)&&form.attributes.url==this.currentSearchFormType&&!this.searchFormView.isDestroyed()){return;}
this.currentSearchFormType=form.attributes.url;if((!_.isUndefined(this.searchFormView)&&(!this.searchFormView.isDestroyed()))&&this.searchFormViewCache.length>0&&_.where(this.searchFormViewCache,{type:form.attributes.url}).length>0){this.searchFormView=_.where(this.searchFormViewCache,{type:form.attributes.url})[0].form;return;}
if(form.attributes.type=='quick'){this.searchFormView=new QuickSearchFormView({model:form,el:'#ev-searchform-container'});}else if(form.attributes.type=='expert'){this.searchFormView=new ExpertSearchFormView({model:form,el:'#ev-searchform-container'});}else if(form.attributes.type=='thesaurus'){this.searchFormView=new ThesaurusSearchFormView({model:form,el:'#ev-searchform-container'});}else if(form.attributes.type=='searchHistory'){this.searchFormView=new SearchHistoryView({model:new SearchHistoryList(),el:'#ev-searchform-container'});}else if(form.attributes.type=='author'){this.searchFormView=new AuthorSearchFormView({model:form,el:'#ev-searchform-container'});}else if(form.attributes.type=='affiliation'){this.searchFormView=new AffiliationSearchFormView({model:form,el:'#ev-searchform-container'});}
this.searchFormViewCache.push({type:version,form:this.searchFormView});}},destroyFormView:function(destroySearchForm,destroyResultView){if(destroySearchForm){this.undelegateEvents();app.model.off("searchSubmit",this.runSearch,this);app.model.off("authorSearchSubmit",this.runAuthorSearch,this);app.model.off("affilSearchSubmit",this.runAffiliationSearch,this);app.model.off("searchSubmitLink",this.runSearchFromLink,this);app.model.off("updateSearchEntity",this.updateSearchEntity,this);app.model.off("updateAuthorSearchEntity",this.updateAuthorSearchEntity,this);app.model.off("updateAffiliationSearchEntity",this.updateAffiliationSearchEntity,this);this.searchFormViewCache=[];if(!_.isUndefined(this.searchFormView)){this.searchFormView.destroy();$("<div id='ev-searchform-container'></div>").insertBefore("#ev-search-container #ev-searchhistory-container");$('#ev-searchform-container').addClass('ev-green-bg');}}
if(destroyResultView){if(!_.isUndefined(this.searchResultsView)){this.searchResultsView.destroy();$("<div id='ev-searchresults-container'></div>").insertAfter("#ev-search-container #ev-searchhistory-container");app.appChannel.request('application:setStatus','results',app.status.RESULTS_NONE);}}},render:function(version){if(version=='dups'){var params='content=t&'+window.location.search.substr(1);this.searchResultsView.updateView(params,'/search/results/dedup.url',"");$('.ev-navigation-links').hide();$('#ev-searchform-container').hide();}else if(version=='tagsGroups'){var params='content=t&'+window.location.search.substr(1);this.searchResultsView.updateView(params,'/search/results/tags.url',"");$('.ev-navigation-links').hide();$('#ev-searchform-container').hide();}else{var curSearch=this.getSearch();this.checkForFieldValues(version,curSearch);if(_.isUndefined(curSearch.edit)&&_.isUndefined(curSearch.EDIT)){if(version=="author"){this.authorSearchResultsView.checkForSearch();}else if(version=="affiliation"){this.affilSearchResultsView.checkForSearch();}else{this.searchResultsView.checkForSearch(version);}}
if(curSearch.edit||version=="searchHistory"){$('#ev-searchresults-container').empty();}
if(_.isUndefined(curSearch.searchid)||_.isUndefined(curSearch.SEARCHID)){$(".ev-navigation-header .ev-active").removeClass("ev-active");$('#search-menu').addClass("ev-active");$('#ev-header-search-link').addClass("ev-active");if(version=="searchHistory"){$("#navlinks-container a[data-id='search history']").addClass("ev-active");}else{$("#navlinks-container a[data-id='"+version+"']").addClass("ev-active");}}}},checkForFieldValues:function(version,curSearch){if((!_.isEmpty(curSearch))&&(!_.isUndefined(curSearch))&&(!_.isUndefined(curSearch.SEARCHID)||!_.isUndefined(curSearch.searchid))){var searchId='',location='',entity={};if(!_.isUndefined(curSearch.searchid)){searchId=curSearch.searchid;entity['searchid']=curSearch.searchid;}else if(!_.isUndefined(curSearch.SEARCHID)){searchId=curSearch.SEARCHID;entity['searchid']=curSearch.SEARCHID;}
if(!_.isUndefined(curSearch.location)){entity['location']=curSearch.location;}
var callBack=_.bind(this.renderForm,this,version);if(version=='author'){this.authorFormValues.getAuthorSearchEntity(searchId,callBack);}else if(version=='affiliation'){this.affilFormValues.getAffiliationSearchEntity(searchId,callBack);}else{this.formValues.getSearchEntity(entity,callBack);}}else{this.renderForm(version);}},renderForm:function(version){if(this.searchForms.length>0){this.getSearchFormView(version);if(version=='author'){if(!_.isEmpty(this.authorFormValues)&&version!='searchHistory'){this.searchFormView.model.attributes.authorFormValues=this.authorFormValues;}}else if(version=='affiliation'){if(!_.isEmpty(this.affilFormValues)&&version!='searchHistory'){this.searchFormView.model.attributes.affilFormValues=this.affilFormValues;}}else{if(!_.isEmpty(this.formValues)&&version!='searchHistory'){this.searchFormView.model.attributes.formValues=this.formValues;}}
var params=this.getURLParam();var searchWord1=this.getURLParamByName("searchWord1",Backbone.history.getFragment());this.searchFormView.render();this.$searchForm.hide();this.$navigationLink.hide();if(!(params.CID=='dedup')){this.$searchForm.show();this.$navigationLink.show();}
if(!_.isUndefined(searchWord1)&&!_.isNull(searchWord1)&&!_.isEmpty(searchWord1)){$("input[name='searchWord1']").val(searchWord1.trim());$("textarea[name='searchWord1']").val(searchWord1.trim());}
$('body').on('keydown',this.updateTextInput);$('body').on('keyup',this.updateTextInput);$('body').on('click',this.updateTextInput);$('body').on('change','input',this.updateTextInput);this.toggleSearchbtn();$('#search-form-top').on("input change propertychange",'.search-word',this.toggleSearchbtn);}else{console.error("No search forms are available!");}
app.$searchContainer.show();},getSearchFromSearchId:function(searchId){},toggleSearchbtn:function(){var searchBox=$(".search-word");if(searchBox!=undefined){var isTextAvb=false;$(searchBox).each(function(i,val){if($(this).val()!=undefined&&$(this).val().trim().length>0){isTextAvb=true;return false;}});if(isTextAvb){$(".searchBtnDis").attr("disabled",false);}else{$(".searchBtnDis").attr("disabled",true)}}},runSearch:function(params){if(this.searchResultsView==null||(typeof this.searchResultsView=='undefined')){this.searchResultsView=new SearchResultsView();}
app.model.trigger("ev:clearAlert");if(_.isObject(params)&&!_.isString(params)&&!_.isUndefined(params.url)){this.searchResultsView.updateView(params.params,params.url);}else{this.searchResultsView.updateView(params);}},runAuthorSearch:function(params){if(this.authorSearchResultsView==null||(typeof this.authorSearchResultsView=='undefined')){this.authorSearchResultsView=new AuthorSearchResultsView();}
app.model.trigger("resultsLoaded");if(_.isObject(params)&&!_.isString(params)&&!_.isUndefined(params.url)){this.authorSearchResultsView.updateView(params.params,params.url);}else{this.authorSearchResultsView.updateView(params);}},runAffiliationSearch:function(params){if(this.affilSearchResultsView==null||(typeof this.affilSearchResultsView=='undefined')){this.affilSearchResultsView=new AffiliationSearchResultsView();}
app.model.trigger("resultsLoaded");if(_.isObject(params)&&!_.isString(params)&&!_.isUndefined(params.url)){this.affilSearchResultsView.updateView(params.params,params.url);}else{this.affilSearchResultsView.updateView(params);}},runSearchFromLink:function(url){$(".ev-container").hide();var searchtypeFromParam=this.getURLParamByName("searchtype",url),usageOrigin=this.getURLParamByName("usageOrigin",url),usageZone=this.getURLParamByName("usageZone",url);if(searchtypeFromParam=='Expert'){app.router.navigate("/search/expert.url?usageOrigin="+usageOrigin+"&usageZone="+usageZone,false);this.renderForm("expert");}else{app.router.navigate("/search/quick.url?usageOrigin="+usageOrigin+"&usageZone="+usageZone,false);this.renderForm("quick");}
if(this.searchResultsView==null||(typeof this.searchResultsView=='undefined')){this.searchResultsView=new SearchResultsView();}
$('#ev-search-container').show();app.model.trigger("resultsLoaded");url+="&angularReq=true&isFullJsonResult=true";this.searchResultsView.updateView("",url,this.searchFormView.populateAndRenderForm());var databaseParam=this.getURLParamByName("database",url);Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{userMask:databaseParam});},updateTextInput:function(event){if(event!=null)
{var keycode=event.keyCode;if(keycode===27)
{return''}}
var input_fields=$(".ev-text-input-field");for(var i=0;i<input_fields.length;i++){var input_field=$(input_fields[i]);if(input_field.is(":focus")||input_field.val()!=""){input_field.parent().addClass("ev-text-input-active")}
else{input_field.parent().removeClass("ev-text-input-active")}}},updateElements:function(e){var $element=$(e.target);if($element.is('select#updates-no')){$('input[value="lastupdate"]').prop('checked',true);}else{$('input[value="yearrange"]').prop('checked',true);}},enterSubmit:function(e){if($(document.activeElement).parents(".nav-tabs").length>0){return;}
var $target=$(e.target);$('.autocomplete-results').hide();if(e.which===ENTER_KEY){if(this.searchFormView.model.attributes.type=='thesaurus'){this.searchFormView.submitThesSearch(e);}else if($target.attr("id")=="author-orcid"){this.searchFormView.orcIdSearch(e);}else{this.searchFormView.submit(e);}}}});var QuickExpertsearchFormDatabase=new SearchFormDatabasesCollection([cpxDatabase,eiBackFileDatabase,insDatabase,inspecArchiveDatabase,ntiDatabase,pchDatabase,chmDatabase,cbnDatabase,eltDatabase,eptDatabase,geoDatabase,grfDatabase,upaDatabase,eupDatabase,kncDatabase,knaDatabase]);var thesaurusdatabases=new SearchFormDatabasesCollection([cpxDatabase,insDatabase,grfDatabase,geoDatabase,eltThesDatabase,eptThesDatabase,]);var QuickSearchFormView=BaseFeatureView.extend({tagName:'div',className:'searchForm',template:_.template($('#ev-quick-searchform-template').html()),events:{"click #searchBtn":"submit","keydown form":"enterSubmit","click #add-searchfield-link":"addSearchRow","keydown #add-searchfield-link":"addSearchRowOnKey","click .delete-search-field":"deleteSearchRow","keydown .delete-search-field":"deleteSearchRowFromKey","click .auto-suggest-toggle":"toggleAutoSuggest","keydown .auto-suggest-toggle":"toggleAutoSuggestOnKey","click #last-update-radio":"checkLastUpdates","click #reset-form-link-quick":"resetForm","keydown #reset-form-link-quick":"resetFormOnKey",},initialize:function(options){this.options=options||{};this.searchRowView=new SearchFieldRowView({el:this.el,collection:this.model.attributes.searchRows});this.advOptionsView=new AdvOptionsView({version:'quick'});this.databases=QuickExpertsearchFormDatabase;Backbone.Radio.channel("sessionsettingschannel").off("sessionsettings:update",this.updateAutoSuggest);Backbone.Radio.channel("sessionsettingschannel").on("sessionsettings:update",this.updateAutoSuggest,this);},resetForm:function(){Backbone.Radio.channel("searchFormChannel").request("resetForms",'quick','formLink');},resetFormOnKey:function(e){if(e.keyCode===ENTER_KEY){$(e.target).click();return false;}},render:function(){this.$el.empty();this.template=_.template($(this.model.attributes.templateElement).html());this.$el.html(this.template(this.model.attributes));this.searchRowView.render();this.updateAutoSuggest();if(!_.isEmpty(this.model.attributes.formValues.attributes)){this.populateAndRenderForm();}else{this.$el.find("#quick-adv-options-content").html(this.advOptionsView.render().el);this.$el.find("select.section").select2({minimumResultsForSearch:Infinity,width:'100%'});this.$el.find("select.boolean").select2({minimumResultsForSearch:Infinity,width:'50%'});}
this.checkForDBParam();return this;},checkLastUpdates:function(){var result=true,seldbmask=this.calculateMask(),alertmsg="",REFEREX=131072,CBF=262144,IBS=1048576;if($("#last-update-radio:checked")){if(seldbmask==REFEREX){alertmsg="Last updates selection does not apply to Referex collections.";result=false;}else if(seldbmask==CBF){alertmsg="Last updates selection does not apply to Ei Backfile.";result=false;}else if(seldbmask==IBS){alertmsg="Last updates selection does not apply to Inspec Archive.";result=false;}else if(seldbmask==(IBS+CBF)){alertmsg="Last updates selection does not apply to Ei Backfile and Inspec Archive.";result=false;}else if(seldbmask==(IBS+REFEREX)){alertmsg="Last updates selection does not apply to Inspec Archive and Referex collections.";result=false;}else if(seldbmask==(CBF+REFEREX)){alertmsg="Last updates selection does not apply to Ei Backfile and Referex collections.";result=false;}else if(seldbmask==(IBS+CBF+REFEREX)){alertmsg="Last updates selection does not apply to Ei Backfile, Inspec Archive and Referex collections.";result=false;}}
if(!result){app.model.trigger("ev:alert","error",alertmsg);$("#year-range-radio").prop('checked',true);$("#year-range-radio").focus();}
return result;},calculateMask:function(){var selectedDbMask=0,alldb=$("input[name='allDb']"),databases=$("input[name='database']");if(alldb.length>0&&alldb.is(":checked")){selectedDbMask=eval(alldb.val());}else if(databases.length>0){databases.each(function(idx){if($(this).is(":checked"))
selectedDbMask+=eval($(this).val());});}
return selectedDbMask;},populateAndRenderForm:function(){var vals=this.model.attributes.formValues.attributes;if(this.$el.find("#quick-adv-options-content").is(":empty")){this.$el.find("#quick-adv-options-content").html(this.advOptionsView.render().el);}
this.model.attributes.searchRows.reset([new SearchFieldRowModel()]);$("select[name='section1']").select2({minimumResultsForSearch:Infinity,width:'100%'});for(var key in vals){if(vals.hasOwnProperty(key)){var lastKeyVal=key.slice(-1);if(lastKeyVal=="1"||lastKeyVal=="2"||lastKeyVal=="3"){if(key.indexOf('searchWord')>-1&&key!='searchWords'){if($("input[name='"+key+"']").length==0){this.addSearchRow();}
$("input[name='"+key+"']").val(vals[key]);}else if(key.indexOf('section')>-1){if($("select[name='"+key+"']").length==0){this.addSearchRow();}
$("select[name='"+key+"']").val(vals[key]).select2({minimumResultsForSearch:Infinity,width:'100%'});}else if(key.indexOf('boolean')>-1){if($("select[name='"+key+"']").length==0){this.addSearchRow();}
$("select[name='"+key+"']").val(vals[key]).select2({minimumResultsForSearch:Infinity,width:'50%'});}}}}
if(!_.isUndefined(vals.searchphrases)&&!_.isNull(vals.searchphrases)&&!_.isEmpty(vals.searchphrases)){var searchphrases=vals.searchphrases.split("|");var sections=vals.sectionStr.split("|");var bools=vals.booleansStr.split("|");if($("input[name='searchWords']").length==0||!(this.model.attributes.searchRows.size()-3)==$("input[name='searchWords']").length){while(sections.length>(this.model.attributes.searchRows.size()-3)){this.addSearchRow();}}
_.each(sections,function(section,index){$($("select[name='sections']")[index]).val(section).select2({minimumResultsForSearch:Infinity,width:'100%'});$($("select[name='booleans']")[index]).val(bools[index]).select2({minimumResultsForSearch:Infinity,width:'50%'});$($("input[name='searchWords']")[index]).val(searchphrases[index]);});}
this.advOptionsView.populateForm(this.model.attributes.formValues);this.prepareForUsage();},addSearchRow:function(e){if(this.model.attributes.searchRows.size()<12){newRow=new SearchFieldRowModel();this.model.attributes.searchRows.add(newRow);}else{app.model.trigger("ev:alert","error","You have reached maximum 12 search fields.",false);$("body").animate({scrollTop:0},1000);}
return false;},addSearchRowOnKey:function(e){if(this.model.attributes.searchRows.size()<12){if(e.keyCode===ENTER_KEY){$(e.target).click();return false;}}else{app.model.trigger("ev:alert","error","You have reached maximum 12 search fields.",false);$("body").animate({scrollTop:50},1000);}},deleteSearchRow:function(e){if(this.model.attributes.searchRows.size()>1){cid=$(e.target).attr("id");this.model.attributes.searchRows.remove({cid:cid});}
return false;},deleteSearchRowFromKey:function(e){if(this.model.attributes.searchRows.size()>1){cid=$(e.target).attr("id");if(e.keyCode===ENTER_KEY){$(e.target).click();return false;}}},toggleAutoSuggest:function(e){Backbone.Radio.channel("autoSuggestChannel").request("toggle",e);},toggleAutoSuggestOnKey:function(e){if(e.keyCode===ENTER_KEY){$(e.target).click();return false;}},updateAutoSuggest:function(){var status=$(".auto-suggest-toggle:visible").attr("status");if((status=="on"&&!app.sessionSettings.attributes.autosuggestOff)||(status!="on"&&app.sessionSettings.attributes.autosuggestOff)){$(".auto-suggest-toggle").toggle();}},submit:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($("#searchBtn").attr('disabled')){e.preventDefault();return false;}else if($("#databases-container :checkbox:checked").length==0){app.model.trigger("ev:alert","error","No databases are selected. You must select at least 1 database to search.");return false;}else if($("#search-word-1").val().trim().length==0){app.model.trigger("ev:alert","error","Please enter a search term in the first text box.");return false;}else if($("#year-range-radio:checked")){var startYear=$("#start-year").val(),endYear=$("#end-year").val();if(parseInt(startYear)>parseInt(endYear)){app.model.trigger("ev:alert","error","Start year should be less than or equal to End year.");return false;}}
Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{selectedMask:app.getRegion().currentView.searchView.searchFormView.advOptionsView.databaseCheckBoxView.calculateSelectedMask()});Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{startPage:this.getSearchStartPage(this.model.attributes.type)});app.model.trigger("searchSubmit",$("#quick-search-form").serialize());},prepareForUsage:function(){var editSearch=this.getURLParamByName("edit",window.location.href);if(editSearch=='true'){$("input[name='editSearch']").val("true");}}});var ExpertSearchFormView=BaseFeatureView.extend({tagName:'div',className:'searchForm',template:_.template($('#ev-expert-searchform-template').html()),events:{"click #expertSearchBtn, #expert-adv-options-content #expertSearch":"submit","click #reset-form-link-expert":"resetForm",},initialize:function(options){this.options=options||{};this.databases=QuickExpertsearchFormDatabase;this.advOptionsView=new AdvOptionsView({version:'expert'});},render:function(){this.$el.empty();this.$el.html(this.template(this.model.attributes));if(!_.isEmpty(this.model.attributes.formValues.attributes)){this.populateAndRenderForm();}else{this.$el.find("#expert-adv-options-content").html(this.advOptionsView.render().el);}
this.checkForDBParam();return this;},resetForm:function(){Backbone.Radio.channel("searchFormChannel").request("resetForms",'expert','formLink');},populateAndRenderForm:function(){var vals=this.model.attributes.formValues.attributes;if(!_.isUndefined(app.getRegion().currentView.searchView.searchResultsView)&&!_.isUndefined(app.getRegion().currentView.searchView.searchResultsView.model)&&!_.isUndefined(app.getRegion().currentView.searchView.searchResultsView.model.attributes.searchMetaData.intermediatequery)&&!_.isEmpty(app.getRegion().currentView.searchView.searchResultsView.model.attributes.searchMetaData.intermediatequery)&&!_.isNull(app.getRegion().currentView.searchView.searchResultsView.model.attributes.searchMetaData.intermediatequery)&&app.getRegion().currentView.searchView.searchResultsView.model.attributes.searchMetaData.intermediatequery!=vals.searchWord1){var intermediateQuery=app.getRegion().currentView.searchView.searchResultsView.model.attributes.searchMetaData.intermediatequery;if(intermediateQuery.charAt(0)=='('&&intermediateQuery.charAt(1)=='('&&intermediateQuery.charAt(intermediateQuery.length-1)==')'&&intermediateQuery.charAt(intermediateQuery.length-2)==')'){intermediateQuery=intermediateQuery.substring(1,intermediateQuery.length-1);}
$("textarea[name='searchWord1']").val(intermediateQuery);}else{$("textarea[name='searchWord1']").val(vals.searchWord1);}
if(this.$el.find("#expert-adv-options-content").is(":empty")){this.$el.find("#expert-adv-options-content").html(this.advOptionsView.render().el);}
this.advOptionsView.populateForm(this.model.attributes.formValues);app.getRegion().currentView.searchView.toggleSearchbtn();this.prepareForUsage();},submit:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($("#expertSearchBtn").attr('disabled')){e.preventDefault();return false;}else if($("#databases-container :checkbox:checked").length==0){app.model.trigger("ev:alert","error","No databases are selected. You must select at least 1 database to search.");return false;}else if($("#srchWrd1").val().trim().length==0){app.model.trigger("ev:alert","error","You must enter a search term.");return false;}else if($("#year-range-radio:checked")){var startYear=$("#start-year").val(),endYear=$("#end-year").val();if(parseInt(startYear)>parseInt(endYear)){app.model.trigger("ev:alert","error","Start year should be less than or equal to End year.");return false;}}
Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{selectedMask:app.getRegion().currentView.searchView.searchFormView.advOptionsView.databaseCheckBoxView.calculateSelectedMask()});Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{startPage:this.getSearchStartPage(this.model.attributes.type)});app.model.trigger("searchSubmit",$("#expert-search-form").serialize());},prepareForUsage:function(){var editSearch=this.getURLParamByName("edit",window.location.href);if(editSearch=='true'){$("input[name='editSearch']").val("true");}}});var AuthorSearchFormView=BaseFeatureView.extend({tagName:'div',className:'searchForm',template:_.template($('#ev-author-searchform-template').html()),events:{"click #authorSearchBtn":"submit","click #authorOrcIdSearchBtn":"orcIdSearch","click #reset-form-link-author":"resetForm"},initialize:function(options){this.options=options||{};},resetForm:function(){$("#author-last-name").val("");$("#author-affil-name").val("");$("#author-first-name").val("");$("#author-exact-match").prop('checked',false);this.toggleSearchbtn();},render:function(){this.$el.empty();this.$el.html(this.template(this.model.attributes));if(!_.isEmpty(this.model.attributes.authorFormValues.attributes)){this.populateAndRenderForm();}
$('#author-search-form-top').on("input change propertychange",'.search-word',this.toggleSearchbtn);$('#author-orcid').on("input",function(e){$('#authorOrcIdSearchBtn').attr('disabled',true);});var options={translation:{'0':{pattern:/[0-9]/},'x':{pattern:/[0-9xX]/}},onComplete:function(){$('#authorOrcIdSearchBtn').attr('disabled',false);},onChange:function(){$('#authorOrcIdSearchBtn').attr('disabled',true);}};$('#author-orcid').mask('0000-0000-0000-000x',options);return this;},populateAndRenderForm:function(){var vals=this.model.attributes.authorFormValues.attributes;if(vals){$("#author-last-name").val(vals.lastName);$("#author-first-name").val(vals.firstName);$("#author-affil-name").val(vals.affiliation);if(vals.exactMatch&&vals.exactMatch==true){$('#author-exact-match').prop('checked',true);}}},orcIdSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($("#authorOrcIdSearchBtn").attr('disabled')){e.preventDefault();return false;}
app.model.trigger("authorSearchSubmit",$("#author-search-form [name]").not('#author-last-name,#author-first-name,#author-affil-name').serialize());return false;},submit:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($("#authorSearchBtn").attr('disabled')){e.preventDefault();return false;}
if($("#author-exact-match").is(':checked')){$("#author-exact-match").val(true);}
if($("#author-last-name").val()||$("#author-first-name").val()||$("#author-affil-name").val()){var lastName=$("#author-last-name").val();var firstName=$("#author-first-name").val();var affilName=$("#author-affil-name").val();if(lastName&&new RegExp("^[\\*\\s]+$").test(lastName)){app.model.trigger("ev:alert","error","Your search contains invalid input("+lastName+").",false);}else if(firstName&&new RegExp("^[\\*\\s]+$").test(firstName)){app.model.trigger("ev:alert","error","Your search input contains invalid input("+firstName+").",false);}else if(affilName&&new RegExp("^[\\*\\s]+$").test(affilName)){app.model.trigger("ev:alert","error","Your search input contains invalid input("+affilName+").",false);}else{app.model.trigger("authorSearchSubmit",$("#author-search-form [name]").not('#author-orcid').serialize());}}else{app.model.trigger("ev:alert","error","Please enter atleast one search input.",false);return false;}},toggleSearchbtn:function(){var searchBox=$("#author-search-form-top .search-word");if(searchBox!=undefined){var isTextAvb=false;$(searchBox).each(function(i,val){if($(this).val()!=undefined&&$(this).val().trim().length>0){isTextAvb=true;return false;}});if(isTextAvb){$("#author-search-form-top .searchBtnDis").attr("disabled",false);}else{$("#author-search-form-top .searchBtnDis").attr("disabled",true)}}}});var AffiliationSearchFormView=BaseFeatureView.extend({tagName:'div',className:'searchForm',template:_.template($('#ev-affil-searchform-template').html()),events:{"click #affilSearchBtn":"submit"},initialize:function(options){this.options=options||{};},render:function(){this.$el.empty();this.$el.html(this.template(this.model.attributes));if(!_.isEmpty(this.model.attributes.affilFormValues.attributes)){this.populateAndRenderForm();}
$('#affil-search-form-top').on("input change propertychange",'.search-word',this.toggleSearchbtn);return this;},populateAndRenderForm:function(){var vals=this.model.attributes.affilFormValues.attributes;if(vals){$("#affilName").val(vals.affiliationName);if(vals.exactMatch&&vals.exactMatch==true){$('#affil-exact-match').prop('checked',true);}}},submit:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($("#affilSearchBtn").attr('disabled')){e.preventDefault();return false;}
if($("#affil-exact-match").is(':checked')){$("#affil-exact-match").val(true);}
if($("#affilName").val()){var affilName=$("#affilName").val();if(new RegExp("^[\\*\\s]+$").test(affilName)){app.model.trigger("ev:alert","error","Your search input contains invalid input("+affilName+").",false);}else{app.model.trigger("affilSearchSubmit",$("#affil-search-form").serialize());}}else{app.model.trigger("ev:alert","error","Please enter affiliation as search input.",false);return false;}},toggleSearchbtn:function(){var searchBox=$("#affil-search-form-top .search-word");if(searchBox!=undefined){var isTextAvb=false;$(searchBox).each(function(i,val){if($(this).val()!=undefined&&$(this).val().trim().length>0){isTextAvb=true;return false;}});if(isTextAvb){$("#affil-search-form-top .searchBtnDis").attr("disabled",false);}else{$("#affil-search-form-top .searchBtnDis").attr("disabled",true)}}}});var ThesaurusSearchFormView=BaseFeatureView.extend({tagName:'div',className:'searchForm',template:_.template($('#ev-thes-searchform-template').html()),events:{"click #thesSearchBtn":"submitThesSearch","click #overwrite-terms-confirm":"submitThesSearch","click .ev-thes-db":"updateFields"},updateFields:function(e){Backbone.Radio.channel("thesaurus").trigger('mask:change');},initialize:function(){this.model.attributes.databases=thesaurusdatabases;if(((eltDatabase.attributes.mask&app.model.attributes.entitleddatabasemask)==eltDatabase.attributes.mask)&&((eptDatabase.attributes.mask&app.model.attributes.entitleddatabasemask)==eptDatabase.attributes.mask)){this.model.attributes.databases.remove(eltThesDatabase);this.model.attributes.databases.remove(eptThesDatabase);this.model.attributes.databases.add(eptltDatabase);}},regions:{thesResults:'#thes-search-results'},onRender:function(){this.$el.find("#thesaurus-searchtype").select2({minimumResultsForSearch:Infinity,width:'100%'})
$($(".ev-thes-db")[0]).prop("checked",true);selectedTermsCollection.reset();var curSearch=this.getSearch();if((!_.isEmpty(curSearch))&&(!_.isUndefined(curSearch))&&((!_.isUndefined(curSearch.query)&&!_.isUndefined(curSearch.database)&&!_.isUndefined(curSearch.type)))){this.runThesSearch(curSearch.type,curSearch.database,curSearch.query,curSearch.snum,true,false,curSearch.pageNumber,curSearch.index);}
this.populateAndRenderForm();return this;},populateAndRenderForm:function(){var vals=this.model.attributes.formValues.attributes;if(!_.isUndefined(vals.searchWord1)){$(".ev-thes-db[value='"+vals.databasemask+"']").prop("checked",true);var searchTerms=vals.searchWord1.match(/{[^{}]+}\s*WN\s*CV\)/g);selectedTermsCollection.reset();_.each(searchTerms,function(term,index){term=term.match(/{[^{}]+}/g)[0];term=term.replace(/[{|}]/g,'');selectedTermsCollection.add(new SelectedTermModel({id:index,title:term}));$(".add-term[value='"+term+"']").prop("checked",true);});this.runThesSearch('empty',vals.databasemask,'',0,false,true);}},submit:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;},submitThesSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if(this.$el.find("input[name='database']:checked").length==0){app.model.trigger("ev:alert","error","please select a database.");return false;}
var searchType=this.$el.find("#thesaurus-searchtype").val();var database=this.$el.find("input[name='database']:checked").val();var query=this.$el.find("#thes-search-term").val();if(($(e.currentTarget).attr("id")!="overwrite-terms-confirm")){var resultsViewRegion=this.getRegion("thesResults");if(!_.isUndefined(resultsViewRegion.currentView)&&(resultsViewRegion.currentView.model.attributes.database!=database)&&selectedTermsCollection.length>0){$('#overwrite-terms-modal').modal();return false;}}else{$('#overwrite-terms-modal').modal('hide')}
if(query.length<=0){app.model.trigger("ev:alert","error","please enter a search term");return false;}
if(query&&new RegExp("[<>]").test(query)){app.model.trigger("ev:alert","error","search term cannot contain < or >");return false;}
this.runThesSearch(searchType,database,query,0,false,false);},runThesSearch:function(searchType,database,query,snum,updateForm,updateAdvOptions,pageNumber,index){var resultsViewRegion=this.getRegion("thesResults");if(_.isUndefined(snum)){snum=0;}
if((_.isUndefined(resultsViewRegion.currentView)||(!resultsViewRegion.hasView()))||(!_.isUndefined(resultsViewRegion.currentView)&&(resultsViewRegion.currentView.model.attributes.database!=database))){this.resultsView=new ThesaurusSearchResultsView({model:new GenericThesSearchModel({type:searchType,snum:snum,database:database,query:query})});if(!_.isUndefined(pageNumber)){this.resultsView.model.attributes.pageNumber=pageNumber;}
else if(!_.isUndefined(index)){this.resultsView.model.attributes.index=index;}
if(!_.isUndefined(resultsViewRegion.currentView)&&(resultsViewRegion.currentView.model.attributes.database!=database)){selectedTermsCollection.reset();}
resultsViewRegion.show(this.resultsView);}else{if(searchType=='empty'){if(updateAdvOptions){resultsViewRegion.currentView.populateAdvOptions(this.model.attributes.formValues)}
return false;}
resultsViewRegion.currentView.model.attributes.type=searchType;resultsViewRegion.currentView.model.attributes.database=database;resultsViewRegion.currentView.model.attributes.query=query;resultsViewRegion.currentView.model.attributes.snum=0;if(!_.isUndefined(pageNumber)){resultsViewRegion.currentView.model.attributes.pageNumber=pageNumber;}
else if(!_.isUndefined(index)){resultsViewRegion.currentView.model.attributes.index=index;}
resultsViewRegion.currentView.runThesSearch();}
if(updateForm){this.updateFormFields(searchType,database,query);}
if(updateAdvOptions){resultsViewRegion.currentView.populateAdvOptions(this.model.attributes.formValues)}},saveSelectedItems:function(){},updateFormFields:function(searchType,database,query){this.$el.find("#thesaurus-searchtype").val(searchType).trigger("change");this.$el.find("input[value='"+database+"']").prop("checked",true);this.$el.find("#thes-search-term").val(query);}});var GenericThesSearchModel=Backbone.Model.extend({defaults:{type:'search',database:0,query:'',snum:null},intialize:function(){}})
var ThesaurusSearchResultsView=BaseFeatureView.extend({tagName:'div',className:'',template:_.template($('#ev-thes-searchform-bottom-template').html()),termTemplate:_.template($('#ev-thes-term-results-template').html()),exactTemplate:_.template($('#ev-thes-exact-results-template').html()),browseTemplate:_.template($('#ev-thes-browse-results-template').html()),emptyTemplate:_.template($('#ev-thes-emply-template').html()),events:{'click .thes-next-page':'nextPage','click .thes-prev-page':'prevPage','click .thes-browse-prev-page':'prevBrowsePage','click .thes-browse-next-page':'nextBrowsePage','click .fullRecLink':'searchFromLink','click .thesStep':'searchFromStep','click .add-term':'handleAddTermCheckbox','click .remove-term':'handleRemoveTerm','click #thesDocSearchBtn':'runDocumentSearch','click #thes-reset-link':'resetForm','click .scopenotelink':'showScopeNote','click #thes-result-count':'toggleTermResults'},initialize:function(){this.termSearchModel=new ThesTermSearchModel();this.fullRecModel=new ThesFullRecModel();this.browseModel=new ThesBrowseModel();selectedTermsCollection.on('update',this.renderSelectedTerms,this);this.termSearchModel.on('sync',this.renderTermSearchResults,this);this.fullRecModel.on('sync',this.renderFullRecResults,this);this.browseModel.on('sync',this.renderBrowseResults,this);this.advOptionsView=new AdvOptionsView({version:'thesaurus'});this.listenTo(Backbone.Radio.channel("thesaurus"),"mask:change",this.updateAdvOptions);Backbone.Radio.channel("thesaurus").on('results:loading',this.minimizeTermResults);selectedTermsCollection.on("reset",this.clearSelections,this)},resetForm:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;selectedTermsCollection.reset();this.getRegion('thesAdvOptionsRegion').reset();this.advOptionsView=new AdvOptionsView({version:'thesaurus'});this.getRegion('thesAdvOptionsRegion').show(this.advOptionsView);},clearSelections:function(){$(".add-term").prop("checked",false);},populateAdvOptions:function(vals){this.advOptionsView.populateForm(vals);},updateAdvOptions:function(){var newStartYear=Backbone.Radio.channel("databasechannel").request("startyear:get",parseInt($("#ev-thesaurus-searchform").find("input[name='database']:checked").val()));app.model.set('startYr',newStartYear);this.advOptionsView.updateTabs();$("#start-year").val($("#start-year option:first").val());$("#end-year").val($("#end-year option:first").val());$("#date-tab-content select").select2({minimumResultsForSearch:Infinity,width:'40%'});},onBeforeDestroy:function(){selectedTermsCollection.off('update');},regions:{thesAdvOptionsRegion:"#thes-adv-options-content",selectTermsRegion:"#thes-selected-terms"},onRender:function(){var newStartYear=Backbone.Radio.channel("databasechannel").request("startyear:get",parseInt($("#ev-thesaurus-searchform").find("input[name='database']:checked").val()));app.model.set('startYr',newStartYear);this.getRegion('thesAdvOptionsRegion').show(this.advOptionsView);if(!_.isUndefined(this.model.attributes.query)&&!_.isEmpty(this.model.attributes.query)){this.runThesSearch();}else{this.renderResults(null,this.emptyTemplate);}
this.renderSelectedTerms();},onAttach:function(){if(app.appChannel.request('application:getStatus','results')==app.status.RESULTS_LOADING){this.minimizeTermResults();}},handleAddTermCheckbox:function(e){var term={title:$(e.currentTarget).val()};if($(e.currentTarget).prop("checked")){if($("#thes-search-results-region input[value='"+term.title+"']").length>1){$("#thes-search-results-region input[value='"+term.title+"']").prop("checked",true);}
this.selectTerm(term);}else{this.removeTerm(term);if($("#thes-search-results-region input[value='"+term.title+"']").length>1){$("#thes-search-results-region input[value='"+term.title+"']").prop("checked",false);}}},handleRemoveTerm:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var title=$(e.currentTarget).parent().find(".term-item").text();this.removeTerm({title:title});$(".add-term[value='"+title+"']").prop("checked",false);},selectTerm:function(term){selectedTermsCollection.add(term);},removeTerm:function(term){selectedTermsCollection.remove(selectedTermsCollection.where(term));},renderSelectedTerms:function(){if(_.isUndefined(this.selectedTermsView)){this.selectedTermsView=new SelectedTermsView({collection:selectedTermsCollection});this.showChildView("selectTermsRegion",this.selectedTermsView);}},runThesSearch:function(){var queryParams={term:this.model.attributes.query,database:this.model.attributes.database,snum:this.model.attributes.snum};this.showLoading();switch(this.model.attributes.type){case"search":if(!_.isUndefined(this.model.attributes.pageNumber)){queryParams.pageNumber=this.model.attributes.pageNumber}
this.termSearchModel.queryParams=queryParams;this.termSearchModel.fetch({error:this.showError});break;case"exact":queryParams.fetchBroaderTermTree=false;this.fullRecModel.queryParams=queryParams;this.fullRecModel.fetch({error:this.showError});break;case"browse":if(!_.isUndefined(this.model.attributes.index)){queryParams.index=this.model.attributes.index}
this.browseModel.queryParams=queryParams;this.browseModel.fetch({error:this.showError});break;case"empty":this.renderResults(null,this.emptyTemplate);break;}},showLoading:function(){var container="#thes-search-results-region";if($("#thes-search-results-region .panel-body").length>0){var container="#thes-search-results-region .panel-body";}
if(_.isNull(this.loading)||_.isUndefined(this.loading)){this.loading=$("#ev-loading").clone();}
this.$el.find(container).empty();this.$el.find(container).append(this.loading);this.loading.show();},nextPage:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;this.showLoading();this.currentSearchModel.queryParams.pageNumber=this.currentSearchModel.attributes.pagenav.nextpage;this.currentSearchModel.queryParams.snum=-1;this.currentSearchModel.fetch({error:this.showError});},prevPage:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;this.showLoading();this.currentSearchModel.queryParams.pageNumber=this.currentSearchModel.attributes.pagenav.prevpage;this.currentSearchModel.queryParams.snum=-1;this.currentSearchModel.fetch({error:this.showError});},nextBrowsePage:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;this.showLoading();this.currentSearchModel.queryParams.index=this.currentSearchModel.attributes.nextindex;this.currentSearchModel.fetch({error:this.showError});},prevBrowsePage:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;this.showLoading();this.currentSearchModel.queryParams.index=this.currentSearchModel.attributes.previndex;this.currentSearchModel.fetch({error:this.showError});},showError:function(model,response,options){console.log('errors have been made');$("#thes-search-results-region").html("<div class='ev-error-txt'><span class='ss-alert'></span> Unable to process this request.</div>");},searchFromLink:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var linkSnum=$(e.currentTarget).attr('snum');if(_.isEmpty(linkSnum)){linkSnum=parseInt(this.model.attributes.snum)+1;}
this.model.attributes.query=$(e.currentTarget).text();this.model.attributes.database=$(e.currentTarget).attr('database');this.model.attributes.snum=linkSnum;this.model.attributes.type='exact';this.runThesSearch();},searchFromStep:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var linkSnum=$(e.currentTarget).attr('snum');if(_.isEmpty(linkSnum)){linkSnum=parseInt(this.model.attributes.snum)+1;}
this.model.attributes.query=$(e.currentTarget).text();this.model.attributes.database=$(e.currentTarget).attr('database');this.model.attributes.snum=linkSnum;var type="exact";var context=$(e.currentTarget).attr('context');if(context.toLowerCase().indexOf("browse")>=0){type="browse";}else if(context.toLowerCase().indexOf("term")>=0){type="search"}
this.model.attributes.type=type;this.runThesSearch();},renderResults:function(model,template){if(model==null){this.$el.find("#thes-search-results-region").html(template());}else{this.currentSearchModel=model;this.$el.find("#thes-search-results-region").html(template({results:model.toJSON(),selectedTerms:selectedTermsCollection.toJSON()}));this.updateUrl();}},updateUrl:function(){var newUrl=Backbone.history.location.pathname+"?query="+this.currentSearchModel.queryParams.term+"&database="+this.currentSearchModel.queryParams.database+"&snum="+this.currentSearchModel.queryParams.snum+"&type="+this.model.attributes.type;if(!_.isUndefined(this.currentSearchModel.queryParams.pageNumber)){newUrl+="&pageNumber="+this.currentSearchModel.queryParams.pageNumber;}else if(!_.isUndefined(this.currentSearchModel.queryParams.index)){newUrl+="&index="+this.currentSearchModel.queryParams.index;}
app.router.navigate(newUrl,{trigger:false});},renderTermSearchResults:function(){this.renderResults(this.termSearchModel,this.termTemplate);},renderFullRecResults:function(){this.renderResults(this.fullRecModel,this.exactTemplate);},renderBrowseResults:function(){this.renderResults(this.browseModel,this.browseTemplate);},renderEmptyResults:function(){this.renderResults(null,this.emptyTemplate);},runDocumentSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;if($("#thes-selected-terms li .term-item").length>0){var searchString=this.getSearchString();app.model.trigger("searchSubmit",{params:$("#thesaurus-doc-search-form").serialize(),url:'/search/thesaurus.url'});this.minimizeTermResults();}else{app.model.trigger("ev:alert","error","No terms selected. Please select one term to run a search.");}},toggleTermResults:function(){if($("#thes-search-results").hasClass('ev-thesaurus-searchform-bottom-min')){this.maximizeTermResults()}else{this.minimizeTermResults()}},maximizeTermResults:function(){$("#thes-result-count").removeClass("collapsed");$("#thes-search-results").removeClass("overflow-hidden");$("#thes-search-results").removeClass("ev-thesaurus-searchform-bottom-min",400);},minimizeTermResults:function(){$("#thes-result-count").addClass("collapsed");$("#thes-search-results").addClass("overflow-hidden");$("#thes-search-results").addClass("ev-thesaurus-searchform-bottom-min",400);$("#thesaurus-search-form").one("focus click",this.maximizeTermResults);},showScopeNote:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var href=$(e.currentTarget).attr('href');if(this.model.attributes.database==2097152)
{window.open(href,'NewWindow','status=no,resizable,scrollbars=1,width=500,height=400');void('');}
else
{window.open(href,'NewWindow','status=no,resizable,scrollbars=1,width=500,height=400');void('');}},getSearchString:function(){var database=this.model.attributes.database;var search=this.$el.find("input[name='searchWord1']");var selectedTerms=$("#thes-selected-terms li");var andor=$("input[name='and-or']:checked").val();this.$el.find("input[name='andor']").val(andor);this.$el.find("input[name='database']").val(database);search.val("((");for(var i=0;i<selectedTerms.length;i++){var term=$(selectedTerms[i]).find(".term-item").text();if(i<selectedTerms.length-1){if(database==8192){search.val(search.val()+(i>0?"(":"")+"{"+term+"} WN CV OR {"+term+"} WN RGI) "+andor+" ");}else if(database==2048||database==3072||database==1024){if(term.charAt(0)=="-"){search.val(search.val()+"{"+term+"}  WN CL) "+andor+" (");}else{search.val(search.val()+"(({"+term
+"} WN CV) OR "+"({"+term
+"-A} WN CVA) OR "+"({"+term
+"-N} WN CVN) OR "+"({"+term
+"} WN CVM) OR "+"({"+term
+"-P} WN CVP) OR "+"({"+term
+"-N} WN CVMN) OR "+"({"+term
+"-A} WN CVMA) OR "+"({"+term
+"-P} WN CVMP))) "+andor+" (");}}else{search.val(search.val()+"({"+term+"}  WN CV) "+andor+" ");}}else if(i==selectedTerms.length-1){if(database==8192){search.val(search.val()+(i>0?"(":"")+"{"+term+"} WN CV OR {"+term+"} WN RGI))");}else if(database==2048||database==3072||database==1024){if(term.charAt(0)=="-"){search.val(search.val()+"{"+term+"} WN CL))");}else{search.val(search.val()+"(({"+term
+"} WN CV) OR "+"({"+term
+"-A} WN CVA) OR "+"({"+term
+"-N} WN CVN) OR "+"({"+term
+"} WN CVM) OR "+"({"+term
+"-P} WN CVP) OR "+"({"+term
+"-N} WN CVMN) OR "+"({"+term
+"-A} WN CVMA) OR "+"({"+term
+"-P} WN CVMP))))");}}else{search.val(search.val()+"({"+term+"} WN CV)))");}}}
return search.val();}});var SelectedTermModel=Backbone.Model.extend({defaults:function(){return{id:this.cid,title:""}}})
var SelectedTermsCollection=Backbone.Collection.extend({model:SelectedTermModel,});var selectedTermsCollection=new SelectedTermsCollection();var SelectedTermView=Backbone.Marionette.View.extend({tagName:'li',className:'list-group-item',template:_.template("<span class='term-item'>{{=title}}</span> <a href='#' class='remove-term ss-delete right' title='Remove term {{=title}}' aria-label='Remove term {{=title}}' id='term-{{=id}}'></a>"),model:SelectedTermModel,attributes:function(){return{id:this.model.attributes.id}}});var ThesEmptyView=Backbone.Marionette.View.extend({template:_.template('<i>Select term by using the checkboxes or find additional terms by clicking on the term...</i>')});var SelectedTermsView=Backbone.Marionette.CollectionView.extend({tagName:'ul',className:'list-group col-sm-12 no-padding-right',childView:SelectedTermView,emptyView:ThesEmptyView})
var ThesTermSearchModel=Backbone.Model.extend({url:"/search/thes/termsearch.url",queryParams:{term:null,snum:null,pageNumber:null,database:null},fetch:function(options){this.doFetch(_.extend({emulateHTTP:false,emulateJSON:false,suppressErrors:true,data:this.queryParams},options))},doFetch:function(options){Backbone.Model.prototype.fetch.apply(this,arguments);},});var ThesFullRecModel=Backbone.Model.extend({url:"/search/thes/fullrec.url",queryParams:{term:null,snum:null,database:null},fetch:function(options){this.doFetch(_.extend({emulateHTTP:false,emulateJSON:false,data:this.queryParams},options))},doFetch:function(options){Backbone.Model.prototype.fetch.apply(this,arguments);},});var ThesBrowseModel=Backbone.Model.extend({url:"/search/thes/browse.url",queryParams:{term:null,snum:null,database:null,index:null},fetch:function(options){this.doFetch(_.extend({emulateHTTP:false,emulateJSON:false,data:this.queryParams},options))},doFetch:function(options){Backbone.Model.prototype.fetch.apply(this,arguments);},});var ThesScopeNoteModel=Backbone.Model.extend({url:"/thes/scopenote.url",queryParams:{term:null,database:null},fetch:function(options){this.doFetch(_.extend({emulateHTTP:false,emulateJSON:false,data:this.queryParams},options))},doFetch:function(options){Backbone.Model.prototype.fetch.apply(this,arguments);},});var app=app||{};var SearchHistoryCountModel=Backbone.Model.extend({url:'/search/history/shcount.url',defaults:{count:0},});var SearchHistoryModel=Backbone.Model.extend({defaults:{searchid:'',issaved:false,isalert:false,databasemask:'1',databasedisplay:'',startYear:'',endYear:'',autostem:'Off',dedupCriterias:[]},});var SearchHistoryList=Backbone.Collection.extend({model:SearchHistoryModel,url:'/search/history/shjson.url',clearUrl:'/search/history/clearjson.url?backurl=SEARCHHISTORY',initialize:function(options){this.on("reset",this.clearAll,this);},clearAll:function(data){if(data.length==0){$.post(this.clearUrl,function(){});}},clear:function(searchId){url=this.clearUrl+"&searchid="+searchId;$.get(url,_.bind(this.updateCollection,this)).fail(function(){});},updateCollection:function(data){this.reset(data);}});var SearchHistoryView=BaseFeatureView.extend({regions:{"searchHistoryTable":"#search-history-table"},template:_.template($('#ev-searchhistory-template').html()),showMoreTmp:_.template('Showing 2 of {{=size}} in your search history. <a href="#">Show more<span class="ss-navigatedown"></span></a>'),showLessTmp:_.template('Showing {{=size}} of {{=size}} in your search history. <a href="#" class="showless">Show less<span class="ss-navigateup"></span></a>'),combineUrl:'/search/history/combine.url',saveSearchUrl:'/personal/savedsearch/adddelete.url?',showAllRows:false,events:{'click #clear-search-history-link':'clearSearchHistory','click .combine-select-action':'combineOptions','click .combine-chkbox':'combineChkBox','click #combineSearchBtn':'submit','keydown #txtcombine':'submitOnEnter',"click .sh-save-search":"saveSearch","click .sh-create-alert":"saveSearch","click .ss-edit-link":"editSearch","click .sh-delete-search":"deleteSearch","click .search-history-rerun-link":"rerunSearch","click #search-history-show-more a":"showAll"},getShowAll:function(){return this.showAllRows;},showAll:function(e){if(!_.isUndefined(e)){e.preventDefault?e.preventDefault():e.returnValue=false;}
if($(e.currentTarget).hasClass('showless')){this.showLess();}else{$(".sh-hidden").show();this.showAllRows=true;$("#search-history-show-more").html(this.showLessTmp({size:this.model.length}));}},showLess:function(){if($(".showless").is(":visible")){$(".sh-hidden").removeAttr("style");this.showAllRows=false;$("#search-history-show-more").html(this.showMoreTmp({size:this.model.length}));}},initialize:function(options){this.options=options||{};this.model.on('sync',this.showSearchHistoryTable,this);this.model.on('update',this.modelUpdate,this);this.model.on('reset',this.modelUpdate,this);Backbone.Radio.channel("searchHistoryChannel").reply("searchhistory:showAllRows",this.getShowAll,this);},onRender:function(){this.showhideLoading(true,$(".search-history-header-row"));this.model.fetch();this.$txtCombine=$("#txtcombine");this.combineDBMask=0;},updateSearchHistoryTable:function(){if($("#ev-search-history").is(":visible")){this.model.fetch();this.combineDBMask=0;}},modelUpdate:function(){this.showLoadingCursor(false);this.updateCount();this.resetCombine();$("#txtcombine").val("");},editSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var url=$(e.currentTarget).attr("href");app.router.navigate(url,true);},saveSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var userChannel=Backbone.Radio.channel("usersessionchannel");var btn=$(e.currentTarget);var mark=btn.hasClass("saved")?"unmark":"mark";var searchId=$(e.currentTarget).parents(".search-history-actions").attr("id").split('-')[1];var type=btn.hasClass("EmailAlert")?"EmailAlert":"SavedSearch";var saveUrl=this.saveSearchUrl+"selectvalue="+mark+"&searchid="+searchId+"&option="+type;var savedSeachesAndAlertsLimit=app.model.attributes.common.savedSearchesLimit;if(userChannel.request("usersession:individualuser")){this.showLoadingCursor(true);saveUrl+="&ajax=true";var success=function(data){if(data.status=='error'){if(type=='SavedSearch')app.model.trigger("ev:alert","error","Unable to save your search!");if(type=='EmailAlert')app.model.trigger("ev:alert","error","Unable to save your email alert!");this.showLoadingCursor(false);return;}else if(data.status=='limit'){app.model.trigger("ev:alert","error","You may only create "
+savedSeachesAndAlertsLimit
+" total saved searches and alerts.\nPlease delete a search or alert to create a new one.");this.showLoadingCursor(false);return;}else{btn.toggleClass("saved");if(type=='EmailAlert'&&mark=="mark"){$("#actions-"+searchId+" .SavedSearch").addClass("saved");}else if(mark=="unmark"&&type=='SavedSearch'){$("#actions-"+searchId+" .EmailAlert").removeClass("saved");}
app.appChannel.trigger('ev:saveSearchAlerts',(type=='EmailAlert')?{'EmailAlert':searchId}:{'SavedSearch':searchId})}
this.showLoadingCursor(false);};success=_.bind(success,this);var fail=function(data){if(type=='SaveSearch')app.model.trigger("ev:alert","error","Unable to save your search!");if(type=='EmailAlert')app.model.trigger("ev:alert","error","Unable to save your email alert!");event.stopPropagation();this.showLoadingCursor(false);return false;};fail=_.bind(fail,this);$.get(saveUrl,success).fail(fail);}else{window.location=saveUrl+"&backurl=SEARCHHISTORY";}},deleteSearch:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;this.showLoadingCursor(true);searchId=$(event.currentTarget).parents(".search-history-actions").attr("id").split('-')[1];this.model.clear(searchId);},rerunSearch:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;var url=$(event.target).attr('href')+"&angularReq=true&isFullJsonResult=true";this.showLess();app.model.trigger("searchSubmit",{params:"",url:url});},submit:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;if(!this.validateCombine(this.model.length)){return false;}
app.model.once("updateSearchEntity",this.updateSearchHistoryTable,this);var params=$("#search-history-combine-form").serialize();params+="&angularReq=true&isFullJsonResult=true";this.showLess();app.model.trigger("searchSubmit",{params:params,url:this.combineUrl});},submitOnEnter:function(event){if(event.keyCode==13){this.submit(event);}},clearSearchHistory:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;this.showLoadingCursor(true);this.model.reset();},showSearchHistoryTable:function(){var showHistory=_.bind(function(){this.showLoadingCursor(false);this.showChildView("searchHistoryTable",new SearchHistoryCollectionView({collection:this.model}));this.updateCount();},this);this.showhideLoading(false,$(".search-history-header-row"),showHistory);},updateCount:function(){if(this.model.length>2){$("#search-history-show-more").html(this.showMoreTmp({size:this.model.length}));$("#clear-search-history-link").show();}else if(this.model.length==0){$("#clear-search-history-link").hide();$("#search-history-show-more").empty();}else{$("#clear-search-history-link").show();$("#search-history-show-more").empty();}},resetCombine:function(){$(".combine-actions").addClass("start").removeClass("remove");$(".combine-chkbox").prop('checked',false);this.combineDBMask=0;},combineChkBox:function(event){var serialNum=$(event.target).val();var action="and";if(!$(event.target).prop("checked")){action="remove";}else if(this.combineDBMask==0){action="start";}
if(!this.handleCombine(serialNum,action)){return false;}},combineOptions:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;var serialNum=$(event.target).attr("id").split('-')[1];var action=$(event.target).attr('action');this.handleCombine(serialNum,action);},handleCombine:function(serialNum,action){var ckbx=$("#combine-select-"+serialNum);var mask=$('#dbmask-'+serialNum).val();var menu=$("#combine-options-menu-"+serialNum+" .combine-actions");var restart=new RegExp("\\s*#"+serialNum+"\\s*(AND|OR|NOT)*\\s*");var reconnect=new RegExp("\\s*(AND|OR|NOT)\\s*#"+serialNum+"\\s*");if(action=='start'){this.combineDBMask=mask
$(".combine-actions").removeClass("start");menu.removeClass("start").addClass("remove");this.$txtCombine.val("#"+serialNum);ckbx.prop("checked",true);}else if(action=='remove'){ckbx.prop("checked",false);var match=this.$txtCombine.val().match(restart);if(match==null)return false;this.$txtCombine.val($.trim(this.$txtCombine.val().replace(reconnect,"")));this.$txtCombine.val($.trim(this.$txtCombine.val().replace(restart,"")));this.$txtCombine.val($.trim(this.$txtCombine.val()));match=this.$txtCombine.val().match("#\\d");if(match==null){$(".combine-actions").addClass("start").removeClass("remove");this.combineDBMask=0;}else{num=match.input[1];menu.removeClass("remove").removeClass("start");$("#combine-options-menu-"+num+" .combine-actions").addClass("remove").removeClass("start");}}else if(action=='and'||action=='or'||action=='not'){if(this.combineDBMask!=mask){app.model.trigger("ev:alert","error","Only searches from the same database can be combined.");ckbx.prop("checked",false);event.stopPropagation();return false;}
var appendme=' '+action.toUpperCase()+' #'+serialNum+' ';if(this.$txtCombine.val().match(reconnect)){this.$txtCombine.val($.trim(this.$txtCombine.val().replace(reconnect,appendme)));}else{this.$txtCombine.val($.trim(this.$txtCombine.val())+appendme);}
this.$txtCombine.val($.trim(this.$txtCombine.val()));ckbx.prop("checked",true);}
return true;},validateCombine:function(numberofsearchs){if(numberofsearchs==0){app.model.trigger("ev:alert","error","Search history is empty, combine search is not possible.");return false;}
var combineString=this.$txtCombine.val();if((combineString=="")||(combineString==null)){app.model.trigger("ev:alert","error","Enter values to combine searches.");return false;}
if(!(combineString=="")){var searchLength=combineString.length;var tempword=combineString;var tempLength=0;while(tempword.substring(0,1)==' '){tempword=tempword.substring(1);tempLength=tempLength+1;}
if(searchLength==tempLength){app.model.trigger("ev:alert","error","Enter values to combine searches.");return(false);}}
var searchLength=combineString.length;var tempword=combineString;var hashindex=tempword.indexOf('#');if(hashindex<0){app.model.trigger("ev:alert","error","Each query number must be preceded by a # sign to combine searches (e.g., #1 AND #2, or combustion AND #2).");return false;}
for(var i=0;i<searchLength;i++){var hashindex=tempword.indexOf('#');if(hashindex>=0&&tempword.charAt(hashindex+1)==' '){app.model.trigger("ev:alert","error","Space is not allowed between # and search query number.");return false;}
if(hashindex>=0&&isNaN(tempword.charAt(hashindex+1))){app.model.trigger("ev:alert","error","Only number is allowed after #.");return false;}
tempword=tempword.substring(1);searchLength=tempword.length;}
var lasthashindex=combineString.lastIndexOf('#');if(lasthashindex==(combineString.length-1)){app.model.trigger("ev:alert","error","Please enter a number after #.");return false;}
return true;}});var SearchHistoryRowView=Backbone.Marionette.View.extend({template:_.template($("#ev-search-history-row-template").html()),model:SearchHistoryModel,className:"sh-hidden"})
var MyEmptyView=Backbone.Marionette.View.extend({template:_.template('<i>You have not performed any searches in this session</i>')});var SearchHistoryCollectionView=Backbone.Marionette.CollectionView.extend({childView:SearchHistoryRowView,emptyView:MyEmptyView,});var resultsChannel=Backbone.Radio.channel("results");var app=app||{};var searchTimers={};var SearchResultsModel=Backbone.Model.extend({url:"/search/submit.url",defaults:{searchMetaData:{searchId:"",displayquery:"",physicalquery:"",intermediatequery:"",foundINDBs:"",resultcount:0,refinequery:[],searchesEntity:{}},pagenav:{},navigators:{navigators:[]},results:[]},changeResultsPerPage:function(){var selectedResultPerPage=$("#results-per-page-select").val();var params;if(!_.isUndefined(this.attributes.searchMetaData.dedup)&&this.attributes.searchMetaData.dedup){params='content=t&CID=dedup&database='+this.attributes.searchMetaData.database+"&pageSizeVal="+selectedResultPerPage+'&fieldpref='+this.attributes.searchMetaData.dedupsummary.fieldpref+"&SEARCHID="+this.attributes.searchMetaData.searchId
+'&dbpref='+this.attributes.searchMetaData.dedupsummary.dbpref+"&usageOrigin=dedupresults&usageZone=resultsperpagetop";}else if(this.attributes.searchMetaData.searchtype.toLowerCase()=="tagsearch"){params='content=t&SEARCHID='+encodeURIComponent(this.attributes.searchMetaData.searchId)+'&pageSizeVal='+selectedResultPerPage+'&usageOrigin=tagresults&usageZone=resultsperpagetop&searchtype=TagSearch&database=&CID=tagSearch&scope='+this.getQueryValue('scope');}else{params="pageSizeVal="+selectedResultPerPage+"&SEARCHID="+this.attributes.searchMetaData.searchId+"&sort"+$("#sort-on-select").val()+"&angularReq=true&isFullJsonResult=false&usageOrigin=searchresults&usageZone=resultsperpagetop";}
if(selectedResultPerPage!=this.attributes.pagenav.resultsperpage){this.fetch({cache:false,url:this.getNextPageUrl(),data:params,contentType:"application/json",accept:"application/json",success:function(){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:setLocal",{"resultsPerPage":selectedResultPerPage});}});}},changeResultsPerPageBottom:function(){var selectedResultPerPage=$("#results-per-page-select-bottom").val();var params;if(!_.isUndefined(this.attributes.searchMetaData.dedup)&&this.attributes.searchMetaData.dedup){params='content=t&CID=dedup&database='+this.attributes.searchMetaData.database+"&pageSizeVal="+selectedResultPerPage+'&fieldpref='+this.attributes.searchMetaData.dedupsummary.fieldpref+"&SEARCHID="+this.attributes.searchMetaData.searchId
+'&dbpref='+this.attributes.searchMetaData.dedupsummary.dbpref+"&usageOrigin=dedupresults&usageZone=resultsperpagebottom";}else if(this.attributes.searchMetaData.searchtype.toLowerCase()=="tagsearch"){params='content=t&SEARCHID='+encodeURIComponent(this.attributes.searchMetaData.searchId)+'&pageSizeVal='+selectedResultPerPage+'&usageOrigin=tagresults&usageZone=resultsperpagebottom&searchtype=TagSearch&database=&CID=tagSearch&scope='+this.getQueryValue('scope');}else{params="pageSizeVal="+selectedResultPerPage+"&SEARCHID="+this.attributes.searchMetaData.searchId+"&sort"+$("#sort-on-select").val()+"&angularReq=true&isFullJsonResult=false&usageOrigin=searchresults&usageZone=resultsperpagebottom";}
if(selectedResultPerPage!=this.attributes.pagenav.resultsperpage){this.fetch({cache:false,url:this.getNextPageUrl(),data:params,contentType:"application/json",accept:"application/json",success:function(){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:setLocal",{"resultsPerPage":selectedResultPerPage});}});}},getPage:function(direction){if(!_.isUndefined(Backbone.fetchCache.getCache("SEARCHID="+encodeURIComponent(this.attributes.searchMetaData.searchId)+"&COUNT=1"))&&direction=='NEXT'){Backbone.fetchCache.clearItem("SEARCHID="+encodeURIComponent(this.attributes.searchMetaData.searchId)+"&COUNT=1");}
this.url=this.getNextPageUrl();this.fetch({cache:false,url:this.getNextPageUrl(),data:this.getNextPageParams(direction),contentType:"application/json",accept:"application/json"});},handleRefineQueryLink:function(url){this.fetch({cache:false,url:url+"&angularReq=true&isFullJsonResult=true",contentType:"application/json",accept:"application/json",suppressErrors:true,success:function(model,response){console.log("Successfully refined")},error:function(model,response,options){$(".errorMsg-container").show();}});},handleDuplicateFiltersLink:function(url){this.fetch({cache:false,url:url,contentType:"application/json",accept:"application/json"});},getNextPageUrl:function(){if(!_.isUndefined(this.attributes.searchMetaData.dedup)&&this.attributes.searchMetaData.dedup){this.nextPageUrl='/search/results/dedup.url';}else if(this.attributes.searchMetaData.searchtype.toLowerCase()=="combined"){this.nextPageUrl='/search/results/expert.url';}else if(this.attributes.searchMetaData.searchtype.toLowerCase()=="tagsearch"){this.nextPageUrl='/search/results/tags.url';}else{this.nextPageUrl='/search/results/'+this.attributes.searchMetaData.searchtype.toLowerCase()+'.url';}
return this.nextPageUrl;},getNextPageParams:function(direction){if(!_.isUndefined(this.attributes.searchMetaData.dedup)&&this.attributes.searchMetaData.dedup){var dedupResultCount=this.attributes.searchMetaData.dedupsummary.dedupsetCount;if(!_.isNull(this.attributes.searchMetaData.linkResultCount)&&!_.isUndefined(this.attributes.searchMetaData.linkResultCount)){dedupResultCount=this.attributes.searchMetaData.linkResultCount}
this.nextPageParams="content=t&usageOrigin=dedupresults&DupFlag="+this.attributes.searchMetaData.dedup+"&dbpref="+this.attributes.searchMetaData.dedupsummary.dbpref+"&fieldpref="+this.attributes.searchMetaData.dedupsummary.fieldpref+"&origin="+this.attributes.searchMetaData.dedupsummary.origin+"&dbLink="+this.attributes.searchMetaData.dedupsummary.dbLink+"&linkSet="+this.attributes.searchMetaData.dedupsummary.linkSet+"&navigator=NEXT&SEARCHID="+this.attributes.searchMetaData.searchId+"&database="+this.attributes.searchMetaData.database+"&linkResultCount="+dedupResultCount;}else if(this.attributes.searchMetaData.searchtype.toLowerCase()=="tagsearch"){this.nextPageParams="content=t&navigator=NEXT&SEARCHID="+encodeURIComponent(this.attributes.searchMetaData.searchId)+"&database=&searchtype=TagSearch&scope="+this.getQueryValue('scope')+"&usageOrigin=tagresults"}else{this.nextPageParams="navigator="+direction+"&SEARCHID="+this.attributes.searchMetaData.searchId
+"&database="+this.attributes.searchMetaData.searchesEntity.databasemask
+"&angularReq=true&isFullJsonResult=false&usageOrigin=searchresults";}
if(direction==="PREV"){this.nextPageParams+="&COUNT="+this.attributes.pagenav.previndex+"&usageZone=previouspage";}else{this.nextPageParams+="&COUNT="+this.attributes.pagenav.nextindex+"&usageZone=nextpage";}
return this.nextPageParams},getQueryValue:function(param){var val;app.getSearchFragment().split("&").some(function(item){return item.split("=")[0]==param&&(val=item.split("=")[1])})
return val;},changeSort:function(){this.fetch({cache:false,url:this.getNextPageUrl(),data:"pageSizeVal="+$("#results-per-page-select").val()+"&SEARCHID="+this.attributes.searchMetaData.searchId+"&"+$("#sort-on-select").val()+"&angularReq=true&isFullJsonResult=true&usageOrigin=searchresults&usageZone=sortresults",contentType:"application/json",accept:"application/json",success:function(){app.sessionSettings.fetch({cache:false});}});}});var AuthorSearchResultsModel=Backbone.Model.extend({url:"/search/author/submit.url",defaults:{searchMetaData:{searchId:"",displayquery:"",resultcount:0,searchesEntity:{}},pagenav:{},navigators:{navigators:[]},results:[]},changeResultsPerPage:function(position){var authorSelectedResultPerPage=$("#author-results-per-page-select-"+position).val();if(authorSelectedResultPerPage!=this.attributes.pagenav.resultsperpage){this.fetch({url:this.getNextPageUrl(),data:"pageSizeVal="+authorSelectedResultPerPage+"&searchid="+this.attributes.searchMetaData.searchId+"&"+$("#author-sort-on-select").val()+"&isFullJsonResult=false&usageOrigin=authorresults&usageZone=resultsperpage"+position,contentType:"application/json",accept:"application/json",success:function(){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:setLocal",{"resultsPerPage":authorSelectedResultPerPage});},error:function(xhr,status,error){$("#loading-results").fadeOut();var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.error,myJSON.message,false);}});}},getNextPageUrl:function(){this.nextPageUrl='/search/author/results/author.url';return this.nextPageUrl;},getPage:function(direction,position){this.url=this.getNextPageUrl();this.fetch({url:this.getNextPageUrl(),data:this.getNextPageParams(direction,position),contentType:"application/json",accept:"application/json",success:function(){},error:function(xhr,status,error){$("#loading-results").fadeOut();var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.error,myJSON.message,false);}});},getNextPageParams:function(direction,position){this.nextPageParams="navigator="+direction+"&searchid="+this.attributes.searchMetaData.searchId
+"&angularReq=true&isFullJsonResult=false&usageOrigin=authorresults";if(direction==="PREV"){this.nextPageParams+="&COUNT="+this.attributes.pagenav.previndex+"&usageZone=previouspage"+position;}else{this.nextPageParams+="&COUNT="+this.attributes.pagenav.nextindex+"&usageZone=nextpage"+position;}
return this.nextPageParams},changeSort:function(){this.fetch({url:this.getNextPageUrl(),data:"pageSizeVal="+$("#author-results-per-page-select-top").val()+"&searchid="+this.attributes.searchMetaData.searchId+"&"+$("#author-sort-on-select").val()+"&isFullJsonResult=true&usageOrigin=authorresults&usageZone=sortresults",contentType:"application/json",accept:"application/json",success:function(){app.sessionSettings.fetch();},error:function(xhr,status,error){$("#loading-results").fadeOut();var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.error,myJSON.message,false);}});}});var AffiliationSearchResultsModel=Backbone.Model.extend({url:"/search/affil/submit.url",defaults:{searchMetaData:{searchId:"",displayquery:"",resultcount:0,searchesEntity:{}},pagenav:{},navigators:{navigators:[]},results:[]},changeResultsPerPage:function(position){var affilSelectedResultPerPage=$("#affil-results-per-page-select-"+position).val();if(affilSelectedResultPerPage!=this.attributes.pagenav.resultsperpage){this.fetch({url:this.getNextPageUrl(),data:"pageSizeVal="+affilSelectedResultPerPage+"&searchid="+this.attributes.searchMetaData.searchId+"&"+$("#affil-sort-on-select").val()+"&isFullJsonResult=false&usageOrigin=affiliationresults&usageZone=resultsperpage"+position,contentType:"application/json",accept:"application/json",success:function(){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:setLocal",{"resultsPerPage":affilSelectedResultPerPage});},error:function(xhr,status,error){$("#loading-results").fadeOut();var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.errorType,myJSON.errorText,false);}});}},getNextPageUrl:function(){this.nextPageUrl='/search/affil/results/affil.url';return this.nextPageUrl;},getPage:function(direction,position){this.url=this.getNextPageUrl();this.fetch({url:this.getNextPageUrl(),data:this.getNextPageParams(direction,position),contentType:"application/json",accept:"application/json",success:function(){},error:function(xhr,status,error){$("#loading-results").fadeOut();var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.error,myJSON.message,false);}});},getNextPageParams:function(direction,position){this.nextPageParams="navigator="+direction+"&searchid="+this.attributes.searchMetaData.searchId
+"&angularReq=true&isFullJsonResult=false&usageOrigin=affiliationresults";if(direction==="PREV"){this.nextPageParams+="&COUNT="+this.attributes.pagenav.previndex+"&usageZone=previouspage"+position;}else{this.nextPageParams+="&COUNT="+this.attributes.pagenav.nextindex+"&usageZone=nextpage"+position;}
return this.nextPageParams},changeSort:function(){this.fetch({url:this.getNextPageUrl(),data:"pageSizeVal="+$("#affil-results-per-page-select-top").val()+"&searchid="+this.attributes.searchMetaData.searchId+"&"+$("#affil-sort-on-select").val()+"&isFullJsonResult=true&usageOrigin=affiliationresults&usageZone=sortresults",contentType:"application/json",accept:"application/json",success:function(){app.sessionSettings.fetch();},error:function(xhr,status,error){$("#loading-results").fadeOut();var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.error,myJSON.message,false);}});}});var NavigatorsModel=Backbone.Model.extend({defaults:{label:'',field:'',modifiers:[],startyr:0}});var ViewAllNavsModel=Backbone.Model.extend({defaults:{searchId:'',field:'',nav:new NavigatorsModel()},initialize:function(){this.attributes.nav.url='/getnav.json?field='+this.attributes.field+'&searchId='+this.attributes.searchId+"&searchtype="+this.attributes.searchtype;}});var RssFeedModel=Backbone.Model.extend({defaults:{}});var ViewAllNavsCollection=Backbone.Collection.extend({model:ViewAllNavsModel,modelId:function(attrs){return attrs.field;}});var AbstractPreviewModel=Backbone.Model.extend({idAttribute:"docId",defaults:{previewtext:'',theRest:'',countLeft:0},initialize:function(){this.url=""}});var AbstractPreviewCollection=Backbone.Collection.extend({model:AbstractPreviewModel,initialize:function(options){this.url="/search/results/bulkpreview.url?SEARCHID="+options.searchId+"&COUNT="+options.offset;},parse:function(response,options){return response.results;}});var AbstractPreviewView=Backbone.Marionette.View.extend({template:_.template($("#ev-abspreview-template").html()),events:{'click .showRest':'showRest'},initialize:function(options){this.el=this.id;this.setElement($(this.id));$(this.el).find(".abstract_content").html("<span>Loading...</span>");if(!options.skipFetch){this.model.on('sync',this.render,this);this.model.fetch();}},render:function(){var htmlText=this.template({text:this.model.toJSON()});if(htmlText.length<=18){htmlText="No Preview available.";}
$(this.el).find(".abstract_content").html(htmlText);},showRest:function(event){this.$(".previewMore").fadeIn();this.$(".moreTerms").fadeOut();return false;}});var RefineResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-refineresults-template').html()),tagname:"div",formEl:'#facetform',numericFormEl:'#numericalForm',viewAllCollection:null,events:{'click .refine-submit':'refineSubmit','click #facetsearchbtn':'refineNewSearchSubmit','submit #facetsearchform':'refineNewSearchSubmit','shown.bs.collapse #sortable-navs .collapse':'updateNavState','hidden.bs.collapse #sortable-navs .collapse':'updateNavState','sortupdate #sortable-navs':'updateNavState','show.bs.modal .view-all-modal':'loadAll','click .ev-modal-view-more':'loadAll','click .modal-body .ev-checkbox-input':'updateLessView','click .facet-row .ev-checkbox-input':'updateMoreView','shown.bs.modal .view-chart-modal':'showChartClick','hidden.bs.modal .view-chart-modal':'deleteChart','click .nav_chart':'showChart','click .nav_download':'downloadNavigator','click .download-all-link':'downloadNavigator','click #knovel-search-submit':'runKnovelSearch','click .ev-nav-refine-link':'refineSearch','click .pie-toggle':'chartToggle','click #list_pie_dt':'listToggle'},swapCodes:new Array(8211,8212,8216,8217,8220,8221),swapStrings:new Array("-","-","'","'","\"","\""),onRender:function(){this.model.attributes.navigators.navigators=_.sortBy(this.model.attributes.navigators.navigators,'order');return this;},onAttach:function(){$("#sortable-navs").sortable();$("#sortable-navs").disableSelection();var dtrow=$("#nav_dt").detach();$("#sortable-navs").prepend(dtrow);$("#nav_dt_panel").collapse("show");},showChart:function(e){e.stopPropagation();var navField=$(e.target).attr("id").split("_")[1];if(navField.length>0&&$("#chart_modal_"+navField).length>0){$("#chart_modal_"+navField).modal("toggle");}
return false;},chartToggle:function(event){$(".dt_row").hide();$(".pie-zone").removeClass("hidden");this.showFacetChartClick(event);$("#all_pie_dt").addClass("hidden");$("#list_pie_dt").removeClass("hidden");},listToggle:function(event){event.stopPropagation();$(".pie-zone").addClass("hidden");$(".dt_row").show();$("#list_pie_dt").addClass("hidden");$("#all_pie_dt").removeClass("hidden");},deleteChart:function(e){var navField=$(e.target).attr("id").split("_")[2];$('#chart-canvas-'+navField).empty();},showFacetChartClick:function(e){var navField=$(e.target).attr("id").split("_")[2];var description=$("#pie_chart_"+navField+' .modal-title').text();var title=$("#pie_chart_"+navField+' .modal-title').text();this.drawFacetChart(navField,"pie-chart-canvas",false,title,description);},showChartClick:function(e){var navField=$(e.target).attr("id").split("_")[2];var canvas=document.getElementById("chart-canvas-"+navField);var description=$("#chart_modal_"+navField+' .modal-title').text();var title=$("#chart_modal_"+navField+' .modal-title').text();this.drawChart(navField,canvas,false,title,description);},drawFacetChart:function(navField,canvas,chartAll,title,typeDescription){if(!_.isUndefined(canvas)){var navs=_.findWhere(this.model.attributes.navigators.navigators,{field:navField});if(this.viewAllCollection!=null&&chartAll){viewAllField=$("#"+navField+"_all").attr("data-viewall");navsModel=this.viewAllCollection.get(viewAllField);if(typeof navsModel!='undefined'){navs=navsModel.attributes.nav.attributes;}}
var counts=_.map(navs.modifiers,function(nav){return nav.count});var labels=_.map(navs.modifiers,function(nav){return nav.label});var values=_.map(navs.modifiers,function(nav){return nav.value});var dataPoints=[];var barColors=[];for(var i in counts){dataPoints[i]={name:labels[i],y:counts[i],value:values[i],loc:navs.name,field:navs.field};barColors[barColors.length]=colorPicker(values[i]);}
var dataPoints2=dataPoints.slice(0,5);values=values.map(function(e){return e.toUpperCase()});function colorPicker(type){switch(type){case"ja":return'#3aabf0';case"ca":return'#702862';case"cp":return'#ff6e7d';case"ds":return'#d6ea08';case"ch":return'#ff322b';case"ip":return'#00bdc4';case"bk":return'#ac0015';case"er":return'#6fbc26';case"rr":return'#e6008c';case"ed":return'#664129';case"rc":return'#29b762';case"st":return'#af5400';case"pa":return'#ffce00';default:return'#017F6A';}}
var year=new Date();var height='auto';if(counts.length>30){height=counts.length*25;}
if($("#display-query").text().length>165){var title=$("#display-query").text().substring(0,165)+"...";}else{var title=$("#display-query").text();}
Highcharts.setOptions({lang:{thousandsSep:','}});Highcharts.chart(canvas,{chart:{type:'bar',backgroundColor:null,width:225,height:200,typeDescription:typeDescription,},colors:barColors,title:{text:null,},exporting:{enabled:false},xAxis:{categories:values,title:{text:null}},yAxis:{title:{text:null},labels:{enabled:false},},plotOptions:{series:{dataLabels:{enabled:true,},colorByPoint:true,cursor:'pointer',point:{events:{click:function(e){var $target=$(e.currentTarget),refineFilter=this.options.loc+"="+this.options.value,searchId="&SEARCHID="+$('#facetform').find("input:hidden[name='SEARCHID']").val(),sort="&sort="+$('#facetform').find("input:hidden[name='sort']").val(),sortDir="&sortdir="+$('#facetform').find("input:hidden[name='sortdir']").val(),lastRefineStep="&lastRefineStep="+$('#facetform').find("input:hidden[name='lastRefineStep']").val(),data=refineFilter+searchId+sort+sortDir+lastRefineStep
+"&usageOrigin=searchresults&usageZone=barchart&isFullJsonResult=true&angularReq=true";$(".result-row").hide();$("#loading-results").fadeIn();app.getRegion().currentView.searchView.searchResultsView.model.fetch({cache:false,url:$('#facetform').attr("action"),data:data,contentType:"application/json",accept:"application/json",success:function(model,response,options){$(".result-row").empty();app.model.trigger("hideAdvancedOptions");Backbone.Radio.channel("searchFormChannel").request("searchSynchronize",response.searchMetaData.searchtype);app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();$(".errorMsg-container").show();$(".result-row").show();}});$('#more_'+this.options.field).modal('hide');}}}}},credits:{enabled:false},legend:{enabled:false},series:[{name:"Records",data:dataPoints2}],navigation:{buttonOptions:{}},});}},drawChart:function(navField,canvas,chartAll,title,typeDescription){if(!_.isUndefined(canvas)){var navs=_.findWhere(this.model.attributes.navigators.navigators,{field:navField});if(this.viewAllCollection!=null&&chartAll){viewAllField=$("#"+navField+"_all").attr("data-viewall");navsModel=this.viewAllCollection.get(viewAllField);if(typeof navsModel!='undefined'){navs=navsModel.attributes.nav.attributes;}}
var counts=_.map(navs.modifiers,function(nav){return nav.count});var labels=_.map(navs.modifiers,function(nav){return nav.label});var values=_.map(navs.modifiers,function(nav){return nav.value});var dataPoints=[];for(var i in counts){dataPoints[i]={name:labels[i],y:counts[i],value:values[i],loc:navs.name,field:navs.field};}
var year=new Date();var height='auto';if(counts.length>30){height=counts.length*25;}
if($("#display-query").text().length>165){var title=$("#display-query").text().substring(0,165)+"...";}else{var title=$("#display-query").text();}
Highcharts.setOptions({lang:{thousandsSep:','}});Highcharts.chart(canvas,{chart:{type:'bar',height:height,typeDescription:typeDescription,events:{load:function(){this.credits.element.onclick=function(){window.open('https://www.elsevier.com/solutions/engineering-village/content#compendex','_blank');}}}},colors:['#017F6A'],title:{text:'Search: '+title,align:'left',x:20,widthAdjust:-50},subtitle:{text:'Click to limit your results',align:'left',x:30,},xAxis:{categories:labels,title:{text:null}},yAxis:{min:0,title:{text:'',align:'high'},labels:{overflow:'justify',format:'{value:,.0f}'}},plotOptions:{series:{dataLabels:{enabled:true,},cursor:'pointer',point:{events:{click:function(e){var $target=$(e.currentTarget),refineFilter=this.options.loc+"="+this.options.value,searchId="&SEARCHID="+$('#facetform').find("input:hidden[name='SEARCHID']").val(),sort="&sort="+$('#facetform').find("input:hidden[name='sort']").val(),sortDir="&sortdir="+$('#facetform').find("input:hidden[name='sortdir']").val(),lastRefineStep="&lastRefineStep="+$('#facetform').find("input:hidden[name='lastRefineStep']").val(),data=refineFilter+searchId+sort+sortDir+lastRefineStep
+"&usageOrigin=searchresults&usageZone=barchart&isFullJsonResult=true&angularReq=true";$(".result-row").hide();$("#loading-results").fadeIn();app.getRegion().currentView.searchView.searchResultsView.model.fetch({cache:false,url:$('#facetform').attr("action"),data:data,contentType:"application/json",accept:"application/json",success:function(model,response,options){$(".result-row").empty();app.model.trigger("hideAdvancedOptions");Backbone.Radio.channel("searchFormChannel").request("searchSynchronize",response.searchMetaData.searchtype);app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();$(".errorMsg-container").show();$(".result-row").show();}});$('#more_'+this.options.field).modal('hide');$('#chart_modal_'+this.options.field).modal('hide');}}}}},credits:{enabled:true,text:'provided by Engineering Village \u00A9'+year.getFullYear()+' Reed Elsevier'},series:[{name:"Records","colorByPoint":true,data:dataPoints}],navigation:{buttonOptions:{}},});}},drawPieChart:function(navField,canvas,chartAll,title,typeDescription){if(!_.isUndefined(canvas)){var navs=_.findWhere(this.model.attributes.navigators.navigators,{field:navField});if(this.viewAllCollection!=null&&chartAll){viewAllField=$("#"+navField+"_all").attr("data-viewall");navsModel=this.viewAllCollection.get(viewAllField);if(typeof navsModel!='undefined'){navs=navsModel.attributes.nav.attributes;}}
var chartOptions={type:"pie",renderloc:canvas,title:$("#display-query").text().length>165?$("#display-query").text().substring(0,165)+"...":$("#display-query").text(),subtitle:"",credits:'provided by Engineering Village \u00A9'+(new Date()).getFullYear()+' Reed Elsevier',primaryColors:[],secondaryColors:[],loc:navs.name,field:navs.field}
var counts=_.map(navs.modifiers,function(nav){return nav.count});var labels=_.map(navs.modifiers,function(nav){return nav.label});var values=_.map(navs.modifiers,function(nav){return nav.value});var count_total=0;for(var i in counts){count_total+=counts[i];}
var dataPoints=[];var other={name:'Other',abbrev:'Other',y:0,percent:0.0,value:'',tooltip:'',count:0,dataPoints:[]};var otherCount=0;for(var i in counts){if(navs.modifiers[i].count/count_total>=0.005){chartOptions.primaryColors[chartOptions.primaryColors.length]=colorPicker(values[i]);dataPoints[i]={name:labels[i],abbrev:labels[i].length>15?labels[i].substring(0,13)+"...":labels[i],y:counts[i],percent:Math.round(navs.modifiers[i].count/count_total*1000)/10,value:values[i],tooltip:'<div><b>'+labels[i]+'</b> '+counts[i]+' documents<br></div><div><br> Click chart segment to refine search results</div>'};}else{other.count++;other.y+=navs.modifiers[i].count;chartOptions.secondaryColors[chartOptions.secondaryColors.length]=colorPicker(values[i]);other.dataPoints[other.dataPoints.length]={name:labels[i],abbrev:labels[i].length>15?labels[i].substring(0,13)+"...":labels[i],y:counts[i],percent:Math.round(navs.modifiers[i].count/count_total*1000)/10,value:values[i],tooltip:'<div><b>'+labels[i]+'</b> '+counts[i]+' documents<br></div><div><br> Click chart segment to refine search results</div>'};if(other.count<=10){other.tooltip+='<div><b>'+labels[i]+'</b> '+counts[i]+' documents<br></div>'}}}
other.percent=Math.round(other.y/count_total*1000)/10;if(other.count>=11){other.tooltip+='<div>\+'+(other.count-10).toString()+' Additional</div>';}
other.tooltip+='<div><br> Click chart segment to see more</div>';if(other.y==1){chartOptions.primaryColors[chartOptions.primaryColors.length]=chartOptions.secondaryColor[0];dataPoints[dataPoints.length]=other.dataPoint[0];}else if(other.y>0){chartOptions.primaryColors[chartOptions.primaryColors.length]='#017F6A';dataPoints[dataPoints.length]=other}
buildPieChart(dataPoints,chartOptions,null,false,chartOptions.primaryColors);function colorPicker(type){switch(type){case"ja":return'#3aabf0';case"ca":return'#702862';case"cp":return'#ff6e7d';case"ds":return'#d6ea08';case"ch":return'#ff322b';case"ip":return'#00bdc4';case"bk":return'#ac0015';case"er":return'#6fbc26';case"rr":return'#e6008c';case"ed":return'#664129';case"rc":return'#29b762';case"st":return'#af5400';case"pa":return'#ffce00';default:return'#017F6A';}}
function buildPieChart(dataPoints,chartOptions,previousData,backButton,colors){chart=new Highcharts.Chart({chart:{type:chartOptions.type,height:500,renderTo:chartOptions.renderloc,events:{load:function(){this.credits.element.onclick=function(){window.open('https://www.elsevier.com/solutions/engineering-village/content#compendex','_blank');}}}},colors:colors,title:{useHTML:true,text:chartOptions.title,align:'left',x:20,useHTML:true,widthAdjust:-100},subtitle:{text:chartOptions.subtitle,align:'left',x:30,},plotOptions:{series:{cursor:'pointer',point:{events:{click:function(e){var drilldown=this.dataPoints;if(drilldown){buildPieChart(drilldown,chartOptions,dataPoints,true,chartOptions.secondaryColors);}else{var $target=$(e.currentTarget),refineFilter=chartOptions.loc+"="+this.options.value,searchId="&SEARCHID="+$('#facetform').find("input:hidden[name='SEARCHID']").val(),sort="&sort="+$('#facetform').find("input:hidden[name='sort']").val(),sortDir="&sortdir="+$('#facetform').find("input:hidden[name='sortdir']").val(),lastRefineStep="&lastRefineStep="+$('#facetform').find("input:hidden[name='lastRefineStep']").val(),data=refineFilter+searchId+sort+sortDir+lastRefineStep
+"&usageOrigin=searchresults&usageZone=piechart&isFullJsonResult=true&angularReq=true";$(".result-row").hide();$("#loading-results").fadeIn();app.getRegion().currentView.searchView.searchResultsView.model.fetch({cache:false,url:$('#facetform').attr("action"),data:data,contentType:"application/json",accept:"application/json",success:function(model,response,options){$(".result-row").empty();app.model.trigger("hideAdvancedOptions");Backbone.Radio.channel("searchFormChannel").request("searchSynchronize",response.searchMetaData.searchtype);app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();$(".errorMsg-container").show();$(".result-row").show();}});$('#more_'+chartOptions.field).modal('hide');}}}},dataLabels:{enabled:true,format:'<span>{point.abbrev} ({point.percent:.1f}%)</span>',style:{fontSize:'12px',color:'#000000',width:'155px',fontWeight:'normal',},distance:30}}},tooltip:{backgroundColor:"rgba(255,255,255,1)",padding:1,useHTML:true,headerFormat:'',pointFormat:'{point.tooltip}'},credits:{enabled:true,text:chartOptions.credits},series:[{type:'pie',name:"Records",data:dataPoints}],exporting:{buttons:{backButton:{enabled:backButton,text:'< Back',onclick:function(){buildPieChart(previousData,chartOptions,dataPoints,false,chartOptions.primaryColors);}}}}});}}},downloadNavigator:function(e){e.stopPropagation();},updateLessView:function(event){checkVal=event.target.id;checkVal=checkVal.replace("_more","");$(".facet-row input[id='"+checkVal+"']").prop('checked',$(event.target).prop('checked'));},updateMoreView:function(event){checkVal=$(event.target).val();$(".facet-more-check input[value='"+checkVal+"']").prop('checked',$(event.target).prop('checked'));},loadAll:function(event){var button=event.relatedTarget?$(event.relatedTarget):$(event.target)
var navInfo=button.data('viewall');var target=button.data('target');var field=button.data('field');var size=button.data('size')||null;var moreTemplate=_.template($('#ev-refinemore-template').html());var view=this;if(this.viewAllCollection==null||(typeof this.viewAllCollection.get(navInfo)=='undefined')||size==160){if(this.viewAllCollection==null){this.viewAllCollection=new ViewAllNavsCollection();}
viewAllNav=new ViewAllNavsModel({field:navInfo,searchId:this.model.attributes.searchMetaData.searchId});if(size==160){viewAllNav.attributes.nav.url=viewAllNav.attributes.nav.url+"&navSize=160&navSizeActive=true";BaseFeatureView.prototype.showhideLoading(true,$(target).find('.modal-body'));}
viewAllNav.attributes.nav.fetch({success:function(model,response,options){var model=model.toJSON();var template='<div class="row">';var ipcolLimit=Math.round(model.modifiers.length/3);if((model.modifiers.length%3)>0){ipcolLimit++;}
_.each(model.modifiers,function(modifier,index){if(index==0||(index)%ipcolLimit==0){template=template+'</div><div class="col-md-4 col-lg-4">';}
template=template+'<div>'+moreTemplate({name:model.name,item:modifier,index2:index})+'</div>';});template=template+'</div></div>';template=template.replace("</div>","");if(size==160){BaseFeatureView.prototype.showhideLoading(false,$(target).find('.modal-body'));}
$(target).find('.modal-body').html(template);view.viewAllCollection.add(viewAllNav);var title=$("#chart-title-"+field);view.drawChart(field,document.getElementById($(target).find('.view-all-chart').attr("id")),true,title.text(),$("#chart-title-"+field).text());if(field=="dt"||field=="la"){view.drawPieChart(field,document.getElementById($(target).find('.view-all-pie-chart').attr("id")),true,title.text(),$("#chart-title-"+field).text());}
if(model.modifiers.length>60){button.hide();}else{button.show();}}});}},updateNavState:function(){var navState="";_.each($("#sortable-navs .collapse"),function(navItem){nav=($(navItem).attr("id").split("_"))[1];navIndex=_.findIndex(this.model.attributes.navigators.navigators,{field:nav});if($(navItem).hasClass("in")){nav+="_5";this.model.attributes.navigators.navigators[navIndex].open=5;}else{nav+="_-5";this.model.attributes.navigators.navigators[navIndex].open=-5}
navState+=nav+",";},this);if(navState.length>0){$.get("/session/navstate.url?navid="+navState);}},refineSearch:function(e){e.preventDefault();var $target=$(e.currentTarget),refineFilter=$target.data('name')+"="+$target.data('value'),searchId="&SEARCHID="+$(this.formEl).find("input:hidden[name='SEARCHID']").val(),sort="&sort="+$(this.formEl).find("input:hidden[name='sort']").val(),sortDir="&sortdir="+$(this.formEl).find("input:hidden[name='sortdir']").val(),lastRefineStep="&lastRefineStep="+$(this.formEl).find("input:hidden[name='lastRefineStep']").val(),data=refineFilter+searchId+sort+sortDir+lastRefineStep
+"&usageOrigin=searchresults&usageZone=oneclickcount&isFullJsonResult=true&angularReq=true";$(".result-row").hide();$("#loading-results").fadeIn();app.getRegion().currentView.searchView.searchResultsView.model.fetch({cache:false,url:$(this.formEl).attr("action"),data:data,contentType:"application/json",suppressErrors:true,accept:"application/json",success:function(model,response,options){$(".result-row").empty();app.model.trigger("hideAdvancedOptions");Backbone.Radio.channel("searchFormChannel").request("searchSynchronize",response.searchMetaData.searchtype);app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();$(".errorMsg-container").show();$(".result-row").show();}});return false;},refineSubmit:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;var checked=$(this.formEl).find("input[type='checkbox']:checked");var addTerm=$('#topappend');var patt=new RegExp("^[a-zA-Z 0-9]+$");if(!_.isEmpty(addTerm.val())){if(checked.length==0&&(!addTerm||$.trim(addTerm.val()).length==0)){alert("Please select at least one search refinement, or enter a term in the \"Add a term\" box.");return false;}}
var textNodeValue=addTerm.val();for(var j=0;j<this.swapCodes.length;j++){var swapper=new RegExp("\\u"+this.swapCodes[j].toString(16),"g");textNodeValue=textNodeValue.replace(swapper,this.swapStrings[j]);}
addTerm.val(textNodeValue);formVals=$(_.uniq($("#facetform input"),false,function(b){return $(b).val();})).serialize();if($(event.target).text().toLowerCase()=="exclude"){formVals+="&exclude=Exclude";}
$(".result-row").hide();$("#loading-results").fadeIn();if(!_.isNull(document.getElementById("database-row"))){document.getElementById("database-row").scrollIntoView();}
Backbone.Radio.channel("searchResultChannel").request("navigateToExpertSubmit");app.getRegion().currentView.searchView.searchResultsView.model.fetch({cache:false,url:$(this.formEl).attr("action"),data:formVals+"&isFullJsonResult=true&angularReq=true",contentType:"application/json",suppressErrors:true,accept:"application/json",success:function(model,response,options){$(".result-row").empty();app.model.trigger("hideAdvancedOptions");Backbone.Radio.channel("searchFormChannel").request("searchSynchronize",response.searchMetaData.searchtype);app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();$(".errorMsg-container").show();$(".result-row").show();}});return false;},refineNewSearchSubmit:function(event){var checked=$("#facetsearchform").find("input[type='checkbox']:checked");var search=$("#facetsearchform").find("input[name='btmappend']");if(checked.length==0&&(!search||$.trim(search.val()).length==0)){alert("Please select at least one search refinement, or enter a term in the \"Add a term\" box.");return false;}
var textNodeValue=search.val();for(var j=0;j<this.swapCodes.length;j++){var swapper=new RegExp("\\u"+this.swapCodes[j].toString(16),"g");textNodeValue=textNodeValue.replace(swapper,this.swapStrings[j]);}
search.val(textNodeValue);formVals=$("#facetsearchform").serialize();facetVals=$(_.uniq($("#facetform input[type='checkbox']:checked"),false,function(b){return $(b).val();})).serialize();$(".result-row").empty()
$("#loading-results").fadeIn();if(!_.isNull(document.getElementById("database-row"))){document.getElementById("database-row").scrollIntoView();}
Backbone.Radio.channel("searchResultChannel").request("navigateToExpertSubmit");app.getRegion().currentView.searchView.searchResultsView.model.fetch({cache:false,url:$("#facetsearchform").attr("action"),data:"searchtype=Expert&resultsorall=all&"+formVals+"&"+facetVals+"&isFullJsonResult=true&angularReq=true",contentType:"application/json",success:function(model,response,options){app.model.trigger("hideAdvancedOptions");app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();}});return false;},runKnovelSearch:function(){var query=$("#display-query").text();var url="https://app.knovel.com/web/search.v?kpromoter=engineeringvillage-search&q=";var windowName="_blank";var strOptions;url+=escape(query);var knovelpop=window.open(url,windowName,strOptions);if(knovelpop!=null)knovelpop.focus();}});var AuthorRefineResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-authorrefineresults-template').html()),tagname:"div",className:"row",formEl:'#authorfacetform',viewAllCollection:null,events:{'click #authorfacetform .refine-submit':'refineSubmit','show.bs.modal #author-sortable-navs .view-all-modal':'loadAll','shown.bs.collapse #author-sortable-navs .collapse':'updateNavState','hidden.bs.collapse #author-sortable-navs .collapse':'updateNavState','sortupdate #author-sortable-navs':'updateNavState','click #author-sortable-navs .modal-body .ev-checkbox-input':'updateLessView','click #author-sortable-navs .facet-row .ev-checkbox-input':'updateMoreView','click .ev-nav-refine-link':'refineSearch'},onRender:function(){this.model.attributes.navigators.navigators=_.sortBy(this.model.attributes.navigators.navigators,'order');return this;},loadAll:function(event){var button=$(event.relatedTarget);var navInfo=button.data('viewall');var target=button.data('target');var field=button.data('field');var moreTemplate=_.template($('#ev-authorRefinemore-template').html());if(this.viewAllCollection==null||(typeof this.viewAllCollection.get(navInfo)=='undefined')){if(this.viewAllCollection==null){this.viewAllCollection=new ViewAllNavsCollection();}
viewAllNav=new ViewAllNavsModel({field:navInfo,searchId:this.model.attributes.searchMetaData.searchId,searchtype:'author'});viewAllNav.attributes.nav.fetch({success:function(model,response,options){$(target).find('.modal-body').html(moreTemplate({nav:model.toJSON()}));}});this.viewAllCollection.add(viewAllNav);}},updateNavState:function(){var navState="";_.each($("#author-sortable-navs .collapse"),function(navItem){nav=($(navItem).attr("id").split("_"))[2];navIndex=_.findIndex(this.model.attributes.navigators.navigators,{field:nav});if($(navItem).hasClass("in")){nav+="_5";this.model.attributes.navigators.navigators[navIndex].open=5;}else{nav+="_-5";this.model.attributes.navigators.navigators[navIndex].open=-5}
navState+=nav+",";},this);if(navState.length>0){$.get("/session/authornavstate.url?navid="+navState);}},refineSearch:function(e){e.preventDefault();var $target=$(e.currentTarget),refineFilter=$target.data('name')+"="+$target.data('value'),searchId="&searchid="+$(this.formEl).find("input:hidden[name='searchid']").val(),sort="&sort="+$(this.formEl).find("input:hidden[name='sort']").val(),sortDir="&sortdir="+$(this.formEl).find("input:hidden[name='sortdir']").val(),data=refineFilter+searchId+sort+sortDir
+"&searchtype=Author&usageOrigin=authorresults&usageZone=oneclickcount&isFullJsonResult=true&angularReq=true";$("#author-search-results .result-row").hide();$("#loading-results").fadeIn();this.model.fetch({url:$(this.formEl).attr("action"),data:data,contentType:"application/json",accept:"application/json",success:function(model,response,options){$("#author-search-results .result-row").empty();},error:function(){var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert","error",myJSON.message,false);}});return false;},refineSubmit:function(event){var checked=$(this.formEl).find("input[type='checkbox']:checked");if(checked.length==0){alert("Please select at least one search refinement.");return false;}
formVals=$(_.uniq($("#authorfacetform input"),false,function(b){return $(b).val();})).serialize();if($(event.target).text().toLowerCase()=="exclude"){formVals+="&exclude=Exclude";}
$("#author-search-results .result-row").empty()
$("#loading-results").fadeIn();document.getElementById("author-query-bar").scrollIntoView();this.model.fetch({url:$(this.formEl).attr("action"),data:formVals+"&isFullJsonResult=true&angularReq=true",contentType:"application/json",success:function(model,response,options){},error:function(xhr,status,error){BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"));var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert","error",myJSON.message,false);}});return false;},onAttach:function(){$("#author-sortable-navs").sortable();$("#author-sortable-navs").disableSelection();},updateLessView:function(event){checkVal=$(event.target).val();$("#author-sortable-navs .facet-row input[value='"+checkVal+"']").prop('checked',$(event.target).prop('checked'));},updateMoreView:function(event){checkVal=$(event.target).val();$("#author-sortable-navs .facet-more-row input[value='"+checkVal+"']").prop('checked',$(event.target).prop('checked'));}});var AffiliationRefineResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-affilrefineresults-template').html()),tagname:"div",className:"row",formEl:'#affilfacetform',viewAllCollection:null,events:{'click #affilfacetform .refine-submit':'refineSubmit','show.bs.modal #affil-sortable-navs .view-all-modal':'loadAll','shown.bs.collapse #affil-sortable-navs .collapse':'updateNavState','hidden.bs.collapse #affil-sortable-navs .collapse':'updateNavState','sortupdate #affil-sortable-navs':'updateNavState','click #affil-sortable-navs .modal-body .ev-checkbox-input':'updateLessView','click #affil-sortable-navs .facet-row .ev-checkbox-input':'updateMoreView','click .ev-nav-refine-link':'refineSearch'},onRender:function(){this.model.attributes.navigators.navigators=_.sortBy(this.model.attributes.navigators.navigators,'order');return this;},loadAll:function(event){var button=$(event.relatedTarget);var navInfo=button.data('viewall');var target=button.data('target');var field=button.data('field');var moreTemplate=_.template($('#ev-affilRefinemore-template').html());if(this.viewAllCollection==null||(typeof this.viewAllCollection.get(navInfo)=='undefined')){if(this.viewAllCollection==null){this.viewAllCollection=new ViewAllNavsCollection();}
viewAllNav=new ViewAllNavsModel({field:navInfo,searchId:this.model.attributes.searchMetaData.searchId,searchtype:'affiliation'});viewAllNav.attributes.nav.fetch({success:function(model,response,options){$(target).find('.modal-body').html(moreTemplate({nav:model.toJSON()}));}});this.viewAllCollection.add(viewAllNav);}},updateNavState:function(){var navState="";_.each($("#affil-sortable-navs .collapse"),function(navItem){nav=($(navItem).attr("id").split("_"))[2];navIndex=_.findIndex(this.model.attributes.navigators.navigators,{field:nav});if($(navItem).hasClass("in")){nav+="_5";this.model.attributes.navigators.navigators[navIndex].open=5;}else{nav+="_-5";this.model.attributes.navigators.navigators[navIndex].open=-5}
navState+=nav+",";},this);if(navState.length>0){$.get("/session/affilnavstate.url?navid="+navState);}},refineSearch:function(e){e.preventDefault();var $target=$(e.currentTarget),refineFilter=$target.data('name')+"="+$target.data('value'),searchId="&searchid="+$(this.formEl).find("input:hidden[name='searchid']").val(),sort="&sort="+$(this.formEl).find("input:hidden[name='sort']").val(),sortDir="&sortdir="+$(this.formEl).find("input:hidden[name='sortdir']").val(),data=refineFilter+searchId+sort+sortDir
+"&searchtype=Affiliation&usageOrigin=affiliationresults&usageZone=oneclickcount&isFullJsonResult=true&angularReq=true";$("#affil-search-results .result-row").hide();$("#loading-results").fadeIn();this.model.fetch({url:$(this.formEl).attr("action"),data:data,contentType:"application/json",accept:"application/json",success:function(model,response,options){$("affil-search-results .result-row").empty();},error:function(){BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"));var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert","error",myJSON.message,false);}});return false;},refineSubmit:function(event){var checked=$(this.formEl).find("input[type='checkbox']:checked");if(checked.length==0){alert("Please select at least one search refinement.");return false;}
formVals=$(_.uniq($("#affilfacetform input"),false,function(b){return $(b).val();})).serialize();if($(event.target).text().toLowerCase()=="exclude"){formVals+="&exclude=Exclude";}
$("#affil-search-results .result-row").empty()
document.getElementById("affil-query-bar").scrollIntoView();$("#loading-results").fadeIn();this.model.fetch({url:$(this.formEl).attr("action"),data:formVals+"&isFullJsonResult=true",contentType:"application/json",success:function(model,response,options){},error:function(xhr,status,error){BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"));var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert","error",myJSON.message,false);}});return false;},onAttach:function(){$("#affil-sortable-navs").sortable();$("#affil-sortable-navs").disableSelection();},updateLessView:function(event){checkVal=$(event.target).val();$("#affil-sortable-navs .facet-row input[value='"+checkVal+"']").prop('checked',$(event.target).prop('checked'));},updateMoreView:function(event){checkVal=$(event.target).val();$("#affil-sortable-navs .facet-more-row input[value='"+checkVal+"']").prop('checked',$(event.target).prop('checked'));}});var ResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-resultsregion-template').html()),});var NumericWidgetView=Backbone.Marionette.View.extend({template:_.template($('#ev-numericWidgetRegion-template').html()),});var RemoveDupsWidgetView=Backbone.Marionette.View.extend({template:_.template($('#ev-removeDupsWidgetRegion-template').html()),});var AuthorResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-authorresultsregion-template').html()),});var AffiliationResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-affilresultsregion-template').html()),});var AuthorSearchResultsView=BaseFeatureView.extend({template:_.template($('#ev-authorsearchresults-template').html()),el:'#ev-searchresults-container',regions:{navigators:'#author-navigators',results:'#author-search-results'},events:{"change #author-results-per-page-select-top":"changePageSizeTop","change #author-results-per-page-select-bottom":"changePageSizeBottom","change #author-sort-on-select":"changeSort","click #author-next-page-top":"nextPageTop","click #author-prev-page-top":"prevPageTop","click #author-next-page-bottom":"nextPageBottom","click #author-prev-page-bottom":"prevPageBottom","click #edit-search-link":"editSearch",'click .ev-author-document-search-link ':'submitClick','click .ev-author-document-alert-link':'authorAlertSubmit','click .ev-author-left-nav-toggle':'toggleNavigator'},toggleNavigator:function(e){e.preventDefault();$("#author-navigators").animate({width:'toggle'});var width=$("#author-search-results")[0].style.width!=="100%"?'100%':'80%';$("#author-search-results").animate({width:width});$('#author-search-results .ev-left-nav-expanded').toggleClass('active');if(app.sessionSettings.attributes.isNavCollapsed){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{"isNavCollapsed":!JSON.parse(app.sessionSettings.attributes.isNavCollapsed)});}else{Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{"isNavCollapsed":true});}
return false;},initialize:function(){this.model=new AuthorSearchResultsModel();this.model.on('sync',this.render,this);resultsChannel.reply('search:model',this.model);},onRender:function(){var resultsView=this.getRegion("results");var navigatorView=this.getRegion("navigators");if(!_.isUndefined(resultsView)&&!_.isNull(resultsView)){resultsView.empty();}
this.showChildView("results",new AuthorResultsView({model:this.model}));this.$el.removeClass("ev-container");if(this.model.attributes.navigators.navigators.length>0){if(!_.isUndefined(navigatorView)&&!_.isNull(navigatorView)){navigatorView.empty();}
this.showChildView("navigators",new AuthorRefineResultsView({model:this.model}));}
$("#author-results-per-page-select-top").select2({minimumResultsForSearch:Infinity,width:'20%'});$("#author-results-per-page-select-bottom").select2({minimumResultsForSearch:Infinity,width:'20%'});$("#author-sort-on-select").select2({minimumResultsForSearch:Infinity,width:'70%'});app.router.navigate(Backbone.history.location.pathname+"?searchid="+this.model.attributes.searchMetaData.searchId+"&COUNT="+this.model.attributes.pagenav.currentindex);app.model.attributes.loadedSearchId=this.model.attributes.searchMetaData.searchId;var el=this.$el;BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"),function(){el.fadeIn('slow')});app.model.trigger("updateAuthorSearchEntity",this.model.attributes.searchMetaData.searchEntity);Backbone.Radio.channel("resultHistoryChannel").request("backToResult",true);if(this.isMoreThan4kRecords()){$("#author-next-page-top").addClass('not-active');$("#author-next-page-bottom").addClass('not-active');}else{$("#author-next-page-top").removeClass('not-active');$("#author-next-page-bottom").removeClass('not-active');}
if(app.sessionSettings.attributes.isNavCollapsed){var flag=JSON.parse(app.sessionSettings.attributes.isNavCollapsed);if(flag){$("#author-navigators").hide();$("#author-search-results").width('100%');$('#author-search-results .ev-left-nav-expanded').toggleClass('active');}else{$("#author-search-results").animate({width:'80%'});}}
return this;},authorAlertSubmit:function(e){e.preventDefault();url=$(e.currentTarget).attr("href");var AUID=this.getURLParamByName('authorId',url);var selectvalue=this.getURLParamByName('selectvalue',url);var searchId=this.getURLParamByName('searchId',url);var self=this;$.ajax({url:url,contentType:"application/json",success:function(data,status,xhr){console.log('alert success');$('.ev-author-alert-'+selectvalue+AUID).hide();if(selectvalue=='mark'){$('.ev-author-alert-'+'unmark'+AUID).show();}else{$('.ev-author-alert-'+'mark'+AUID).show();}
if(self.isArray(data)){for(var i in data){app.appChannel.trigger('ev:saveSearchAlerts',{'EmailAlert':data[i]})}}else{app.appChannel.trigger('ev:saveSearchAlerts',{'EmailAlert':data.searchId})}},error:function(xhr,status,thrown){if((xhr.responseText).indexOf('loginfull.url')!==-1){window.location.href=xhr.responseText;return;}
return;},complete:function(xhr,status){}});},isArray:function(what){return Object.prototype.toString.call(what)==='[object Array]';},checkForSearch:function(){var curSearch=this.getSearch();var url="/search/author/results/author.url?"
if(!_.isEmpty(app.model.loadedSearchId)&&(this.model.attributes.searchMetaData.searchId==app.model.loadedSearchId)){return;}else if((!_.isEmpty(curSearch))&&(!_.isUndefined(curSearch))&&(!_.isUndefined(curSearch.SEARCHID)||!_.isUndefined(curSearch.searchid))){this.updateView($.param(curSearch)+"&isFullJsonResult=true",url);}},getSearch:function(){var search=Backbone.history.location.search.substring(1);return(search?JSON.parse('{"'+search.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(key,value){return key===""?value:decodeURIComponent(value)}):{})},updateView:function(params,url){this.$el.empty();BaseFeatureView.prototype.showhideLoading(true,$("#ev-searchhistory-container"));if(_.isEmpty(url)){this.model.url="/search/author/submit.url";}else{this.model.url=url;}
this.model.fetch({data:params,contentType:"application/json",accept:"application/json",success:function(model,response,options){app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(xhr,status,error){BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"));var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.message,myJSON.errorText,false);}});},changePageSizeTop:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeResultsPerPage("top");},changePageSizeBottom:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeResultsPerPage("bottom");},changeSort:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeSort();},nextPageTop:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("NEXT","top");return false;},prevPageTop:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("PREV","top");return false;},nextPageBottom:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("NEXT","bottom");return false;},prevPageBottom:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("PREV","bottom");return false;},editSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var url=$(e.currentTarget).attr("href");app.router.navigate(url,true);},submitClick:function(e){e.preventDefault();url=$(e.currentTarget).attr("href");app.model.trigger("searchSubmitLink",url);return false;},isMoreThan4kRecords:function(){if((this.model.attributes.pagenav.currentindex<=4000&&this.model.attributes.pagenav.currentindex>(4000-this.model.attributes.pagenav.resultsperpage))||this.model.attributes.pagenav.currentindex>4000){app.model.trigger("ev:alert","info","You can only view the first 4000 records. Run a new search or reduce the number of results by using the Refine results panel.",false,true);return true;}else{return false;}}});var AffiliationSearchResultsView=Backbone.Marionette.View.extend({template:_.template($('#ev-affilsearchresults-template').html()),el:'#ev-searchresults-container',regions:{navigators:'#affil-navigators',results:'#affil-search-results'},events:{"change #affil-results-per-page-select-top":"changePageSizeTop","change #affil-results-per-page-select-bottom":"changePageSizeBottom","change #affil-sort-on-select":"changeSort","click #affil-next-page-top":"nextPageTop","click #affil-prev-page-top":"prevPageTop","click #affil-next-page-bottom":"nextPageBottom","click #affil-prev-page-bottom":"prevPageBottom","click #edit-search-link":"editSearch",'click .ev-affil-document-search-link':'submitClick','click .ev-affil-left-nav-toggle':'toggleNavigator'},toggleNavigator:function(e){e.preventDefault();$("#affil-navigators").animate({width:'toggle'});var width=$("#affil-search-results")[0].style.width!=="100%"?'100%':'80%';$("#affil-search-results").animate({width:width});$('#affil-search-results .ev-left-nav-expanded').toggleClass('active');if(app.sessionSettings.attributes.isNavCollapsed){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{"isNavCollapsed":!JSON.parse(app.sessionSettings.attributes.isNavCollapsed)});}else{Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{"isNavCollapsed":true});}
return false;},initialize:function(){this.model=new AffiliationSearchResultsModel();this.model.on('sync',this.render,this);resultsChannel.reply('search:model',this.model);},onRender:function(){var resultsView=this.getRegion("results");var navigatorView=this.getRegion("navigators");if(!_.isUndefined(resultsView)&&!_.isNull(resultsView)){resultsView.empty();}
this.showChildView("results",new AffiliationResultsView({model:this.model}));this.$el.removeClass("ev-container");if(this.model.attributes.navigators.navigators.length>0){if(!_.isUndefined(navigatorView)&&!_.isNull(navigatorView)){navigatorView.empty();}
this.showChildView("navigators",new AffiliationRefineResultsView({model:this.model}));}
$("#affil-results-per-page-select-top").select2({minimumResultsForSearch:Infinity,width:'20%'});$("#affil-results-per-page-select-bottom").select2({minimumResultsForSearch:Infinity,width:'20%'});$("#affil-sort-on-select").select2({minimumResultsForSearch:Infinity,width:'70%'});app.router.navigate(Backbone.history.location.pathname+"?searchid="+this.model.attributes.searchMetaData.searchId+"&COUNT="+this.model.attributes.pagenav.currentindex);app.model.attributes.loadedSearchId=this.model.attributes.searchMetaData.searchId;var el=this.$el;BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"),function(){el.fadeIn('slow')});app.model.trigger("updateAffiliationSearchEntity",this.model.attributes.searchMetaData.searchEntity);Backbone.Radio.channel("resultHistoryChannel").request("backToResult",true);if(this.isMoreThan4kRecords()){$("#affil-next-page-top").addClass('not-active');$("#affil-next-page-bottom").addClass('not-active');}else{$("#affil-next-page-top").removeClass('not-active');$("#affil-next-page-bottom").removeClass('not-active');}
if(app.sessionSettings.attributes.isNavCollapsed){var flag=JSON.parse(app.sessionSettings.attributes.isNavCollapsed);if(flag){$("#affil-navigators").hide();$("#affil-search-results").width('100%');$('#affil-search-results .ev-left-nav-expanded').toggleClass('active');}else{$("#affil-search-results").animate({width:'80%'});}}
return this;},checkForSearch:function(){var curSearch=this.getSearch();var url="/search/affil/results/affil.url?"
if(!_.isEmpty(app.model.loadedSearchId)&&(this.model.attributes.searchMetaData.searchId==app.model.loadedSearchId)){return;}else if((!_.isEmpty(curSearch))&&(!_.isUndefined(curSearch))&&(!_.isUndefined(curSearch.SEARCHID)||!_.isUndefined(curSearch.searchid))){this.updateView($.param(curSearch)+"&isFullJsonResult=true",url);}},getSearch:function(){var search=Backbone.history.location.search.substring(1);return(search?JSON.parse('{"'+search.replace(/&/g,'","').replace(/=/g,'":"')+'"}',function(key,value){return key===""?value:decodeURIComponent(value)}):{})},updateView:function(params,url){this.$el.empty();BaseFeatureView.prototype.showhideLoading(true,$("#ev-searchhistory-container"));if(_.isEmpty(url)){this.model.url="/search/affil/submit.url";}else{this.model.url=url;}
this.model.fetch({data:params,contentType:"application/json",success:function(model,response,options){app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(xhr,status,error){BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"));var myJSON=JSON.parse(status.responseText);app.model.trigger("ev:alert",myJSON.errorType,myJSON.errorText,false);}});},changePageSizeTop:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeResultsPerPage("top");},changePageSizeBottom:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeResultsPerPage("bottom");},changeSort:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeSort();},nextPageTop:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("NEXT","top");return false;},prevPageTop:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("PREV","top");return false;},nextPageBottom:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("NEXT","bottom");return false;},prevPageBottom:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("PREV","bottom");return false;},editSearch:function(e){e.preventDefault?e.preventDefault():e.returnValue=false;var url=$(e.currentTarget).attr("href");app.router.navigate(url,true);},submitClick:function(e){e.preventDefault();url=$(e.currentTarget).attr("href");app.model.trigger("searchSubmitLink",url);return false;},isMoreThan4kRecords:function(){if((this.model.attributes.pagenav.currentindex<=4000&&this.model.attributes.pagenav.currentindex>(4000-this.model.attributes.pagenav.resultsperpage))||this.model.attributes.pagenav.currentindex>4000){app.model.trigger("ev:alert","info","You can only view the first 4000 records. Run a new search or reduce the number of results by using the Refine results panel.",false,true);return true;}else{return false;}}});var SearchResultsView=BaseFeatureView.extend({template:_.template($('#ev-searchresults-template').html()),basketMarkUrl:"/basket/mark.url",basketUnMarkUrl:"/basket/unmark.url",saveSearchAlert:"/personal/savedsearch/adddelete.url",el:'#ev-searchresults-container',replace:false,regions:{navigators:'#navigators',numericWidget:'#numericWidget',removeDups:'#removeDups',results:'#results-region'},events:{"click #next-page-top":"nextPage","click #prev-page-top":"prevPage","click #next-page-bottom":"nextPage","click #prev-page-bottom":"prevPage","click #page-select":"selectPage","click #select-max-confirm":"selectMax","click #select-page-link":"selectPageByLink","click .result-row :checkbox":"selectRecord","click #empty-basket":"emptyBasket","click #email-link":"emailModel","click #print-link":"printModel",'click .full-text-link':'openFullText','click .disabled':'disabledClick','click .refine-query-link':'refineQueryLinkHandler','click .remove-refine-query-link':'refineQueryLinkHandler',"change #results-per-page-select":"changePageSize","change #results-per-page-select-bottom":"changePageSizeBottom","show.bs.collapse .show-preview-content":"showPreview","hide.bs.collapse .show-preview-content":"hidePreview",'click .result-title':'abstractRender','click .result-detailed':'detailRender','click .authors a':'authorSearch',"click .download-link":"showDLTemplate","click .oneclick-dl":"oneDownloadClick","change #sort-on-select":"changeSort",'click a.save-search-alert':'saveSearchCreateAlert','click .rss-feed-link':'showRssFeedPopup','click #removeDupsSubmit':'removeDupsSubmit','change #numerical-fields-names':'changeNumericFieldName','change #numerical-fields-units':'changeNumericFieldUnit','change #numerical-fields-operators':'changeNumericFieldOperator','click #numeric-search-submit':'numericFilterSubmit','click #numeric-widget-helpurl':'handleNumericHelpLink','click .filterDups-link':'handleDuplicateFiltersLink','click #duplicateIcon':'showDupsPopup','click .lh-citedBy':'citedByLinkHandler','click #showMaps':'loadMaps','change input#mapsUrl':'mapSearchResults','click .result-buttons .lh-link-Internal':'showLocalHoldingsPopup','click #knovellink-searchresults.knovellink':'trackKnovelUsage','click #authorLink':'showAuthorOrAffiliationResults','click #affilLink':'showAuthorOrAffiliationResults','click .ev-left-nav-toggle':'toggleNavigator','click .ev-left-nav-toggle':'toggleNavigator','click .search-edit-link':'expertSearchEdit',},toggleNavigator:function(e){e.preventDefault();$("#collapseNav").animate({width:'toggle'});var width=$("#search-results")[0].style.width!=="100%"?'100%':'80%';$("#search-results").animate({width:width});$('#search-results .ev-left-nav-expanded').toggleClass('active');if(app.sessionSettings.attributes.isNavCollapsed){Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{"isNavCollapsed":!JSON.parse(app.sessionSettings.attributes.isNavCollapsed)});}else{Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",{"isNavCollapsed":true});}
return false;},trackKnovelUsage:function(event){Backbone.Radio.channel("usageStreamLineChannel").request("sendKnovelUsage",$(event.currentTarget),'searchresults','resultslist');},handleDuplicateFiltersLink:function(event){if($(event.currentTarget).attr('href').length>0){$(".result-row").remove();$("#loading-results").fadeIn();this.model.handleDuplicateFiltersLink($(event.currentTarget).attr('href').replace("?","?content=t&"));}
return false;},disabledClick:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;event.stopPropagation();return false;},openFullText:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;window.open($(event.target).attr("href"),"newwindow","width=600,height=500,toolbar=no,location=no,scrollbars,resizable");return false;},showPreview:function(event){var containerObj=$($(event.currentTarget).parent().find(".show-preview")[0]);var containerText=containerObj.text().trim()==='Show preview'?'Hide preview':'Show preview';containerObj.text(containerText).append('<a class="showPreview" id="showpreview" aria-label="Hide preview" href="#foo"><span class="ss-navigateup"></a></span>');var container=$(event.target);var info=container.data('info');var docId=container.data('docid');if(container.find(".abstract_content").html().trim().length>0){return;}
var prevModel=new AbstractPreviewModel({"docId":docId});prevModel.url=info+"&partial=true";var absPreview=new AbstractPreviewView({model:prevModel,id:'#'+container.attr('id'),skipFetch:this.skipFetch});if(this.previewCollection){this.previewCollection.add(prevModel);this.previewCollection.once("sync",absPreview.render,absPreview);}},hidePreview:function(event){var containerObj=$($(event.currentTarget).parent().find(".show-preview")[0]);var containerText=containerObj.text().trim()==='Show preview'?'Hide preview':'Show preview';containerObj.text(containerText).append('<a class="showPreview" id="showpreview" aria-label="Show preview" href="#foo"><span class="ss-navigateup"></a></span>');},initialize:function(){this.model=new SearchResultsModel();this.rssFeedModel=new RssFeedModel();this.listenTo(app.model,"change:selectedRecords",this.toggleOutputOptions)
this.model.on('sync',this.render,this);resultsChannel.reply('search:model',this.model);},renderNumericWidget:function(){this.showChildView("numericWidget",new NumericWidgetView({model:this.model}));$("#numerical-fields-names").select2({minimumResultsForSearch:Infinity,width:'100%',dropdownParent:$("#numeric-type-container")});$("#numerical-fields-units").select2({minimumResultsForSearch:Infinity,width:'100%',dropdownParent:$("#numeric-unit-container")});$("#numerical-fields-operators").select2({minimumResultsForSearch:Infinity,width:'100%',dropdownParent:$("#numeric-operator-container")});$("#numeric-search-submit").addClass('disabled');$("#numeric-search-submit").attr("tabindex","-1");$("#numeric-validation-error").hide();$("#numericLastVal").hide();},handleNumericHelpLink:function(event){event.stopPropagation();},changeNumericFieldName:function(){var selectedFieldName=$("#numerical-fields-names").val();var unitsDropdown=$("#numerical-fields-units");var operatorDropdown=$("#numerical-fields-operators");if(selectedFieldName!=null&&selectedFieldName!=''){var optionsList=_.filter(this.model.attributes.numericalData,function(field){return field.fieldName==selectedFieldName;});if(optionsList.length>0){unitsDropdown.empty().append('<option value="">Select unit</option>');_.each(optionsList[0].units,function(unit){unitsDropdown.append('<option value="'+unit.unitName+'">'+unit.displayName+'</option>');});}
unitsDropdown.prop('disabled',false);}else{unitsDropdown.prop('disabled','disabled');}
unitsDropdown.val('').trigger('change');operatorDropdown.val('').trigger('change');},changeNumericFieldUnit:function(){var selectedFieldUnit=$("#numerical-fields-units").val();var operatorDropdown=$("#numerical-fields-operators");if(selectedFieldUnit!=null&&selectedFieldUnit!=''){operatorDropdown.prop('disabled',false);}else{operatorDropdown.prop('disabled','disabled');}
operatorDropdown.val('').trigger('change');},changeNumericFieldOperator:function(){var selectedFieldOperator=$("#numerical-fields-operators").val();var operatorDropdown=$("#numerical-fields-operators");if(selectedFieldOperator!=null&&selectedFieldOperator!=''){$("#numericFirstVal").prop('disabled',false);if(operatorDropdown.val()=="between"){$("#numericLastVal").prop('disabled',false);$("#numericLastVal").show();}else{$("#numericLastVal").prop('disabled','disabled');$("#numericLastVal").hide();}
$("#numeric-search-submit").removeClass('disabled');$("#numeric-search-submit").attr("tabindex","0");}else{$("#numericFirstVal").prop('disabled','disabled');$("#numericLastVal").prop('disabled','disabled');$("#numericLastVal").hide();$("#numeric-search-submit").addClass('disabled');$("#numeric-search-submit").attr("tabindex","-1");}},numericFilterSubmit:function(){var numericFieldName=$("#numerical-fields-names").val();var numericFieldUnit=$("#numerical-fields-units").val();var numericFieldOperator=$("#numerical-fields-operators").val();var numericFirstVal=$("#numericFirstVal").val();var numericLastVal=$("#numericLastVal").val();if(!$.isNumeric(numericFirstVal)){$("#numeric-validation-error").show();return false;}
if(numericFieldOperator=='between'&&!$.isNumeric(numericLastVal)){$("#numeric-validation-error").show();return false;}
var query="";query+="(";if(numericFieldOperator=="between"){query+="("+numericFieldName+" GTE "+numericFirstVal+" "+numericFieldUnit+") AND ("+numericFieldName+" LTE "+numericLastVal+" "+numericFieldUnit+")";}else{query+=numericFieldName+" "+numericFieldOperator+" "+numericFirstVal+" "+numericFieldUnit;}
query+=")";$("#numericFilter").val(query);var numericFormVals=$(_.uniq($("#numericalForm input"),false,function(b){return $(b).val();})).serialize();$(".result-row").empty()
$("#loading-results").fadeIn();if(!_.isNull(document.getElementById("database-row"))){document.getElementById("database-row").scrollIntoView();}
Backbone.Radio.channel("searchResultChannel").request("navigateToExpertSubmit");this.model.fetch({url:$("#numericalForm").attr("action"),data:numericFormVals+"&isFullJsonResult=true&angularReq=true",contentType:"application/json",accept:"application/json",success:function(model,response,options){app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){console.log('refine results failed to load');$("#loading-results").fadeOut();}});return false;},showAuthorOrAffiliationResults:function(e){e.preventDefault();app.router.navigate($(e.currentTarget).attr("href"),true);},buildAuthorOrAffiliationLink:function(){$('#author-affiliation-link').hide();var documentSearchIdKey='docSearchId_'+this.model.get('searchMetaData').searchId;if(this.model.get('searchMetaData').authorSearchId!=null||this.model.get('searchMetaData').affiliationSearchId!=null){var jsonVariable={};if(this.model.get('searchMetaData').authorSearchId){jsonVariable[documentSearchIdKey]="authorSearchId_"+this.model.get('searchMetaData').authorSearchId;}else if(this.model.get('searchMetaData').affiliationSearchId){jsonVariable[documentSearchIdKey]="affiliationSearchId_"+this.model.get('searchMetaData').affiliationSearchId;}
Backbone.Radio.channel("sessionsettingschannel").request("sessionsettings:set",jsonVariable);}
if(app.sessionSettings.attributes[documentSearchIdKey]){var searchIdForAuthorOrAffiliation=app.sessionSettings.attributes[documentSearchIdKey];if(searchIdForAuthorOrAffiliation.indexOf('author')==0){var authorSearchId=searchIdForAuthorOrAffiliation.split(/[_ ]+/).pop();$('#author-affiliation-link').show();$('#author-affiliation-link #affilLink').hide();$('#author-affiliation-link #authorLink').attr('href','/search/author/author.url?searchid='+authorSearchId+'&COUNT=1&usageOrigin=searchresults&usageZone=authorsearch');$('#author-affiliation-link #authorLink').show();}else if(searchIdForAuthorOrAffiliation.indexOf('affil')==0){var affilSearchId=searchIdForAuthorOrAffiliation.split(/[_ ]+/).pop();$('#author-affiliation-link').show();$('#author-affiliation-link #authorLink').hide();$('#author-affiliation-link #affilLink').attr('href','/search/affil/affil.url?searchid='+affilSearchId+'&COUNT=1&usageOrigin=searchresults&usageZone=affiliationsearch');$('#author-affiliation-link #affilLink').show();}}},onRender:function(){var resultsView=this.getRegion("results");var navigatorView=this.getRegion("navigators");var param=this.getURLParam();if(!_.isUndefined(resultsView)&&!_.isNull(resultsView)){resultsView.empty();}
if(this.model.attributes.searchMetaData.dedup){this.model.get('searchMetaData').usageOrigin='dedupresults';}else if(this.model.attributes.searchMetaData.searchtype=='TagSearch'){this.model.get('searchMetaData').usageOrigin='tagresults';}else{this.model.get('searchMetaData').usageOrigin='searchresults';this.buildAuthorOrAffiliationLink();}
this.showChildView("results",new ResultsView({model:this.model}));if(this.model.attributes.numericalData&&!this.model.attributes.searchMetaData.dedup){this.renderNumericWidget();}
CitedByManager.init('#search-results','');if(this.model.attributes.searchMetaData.removeduplicates){var removeDupsView=this.getRegion("removeDups");this.showChildView("removeDups",new RemoveDupsWidgetView({model:this.model}));if(this.model.attributes.searchMetaData.dedup){$('#dbprefdpx').val(param.dbpref);$('#fieldprefdpx').val(param.fieldpref);}
$("#fieldprefdpx").select2({minimumResultsForSearch:Infinity,width:'100%'});$("#dbprefdpx").select2({minimumResultsForSearch:Infinity,width:'100%'});}
if(this.model.attributes.searchMetaData.searchtype=='TagSearch'){$(".navigator-Container").hide();$("#searchscopeselect").select2({minimumResultsForSearch:Infinity,width:'100%'});this.skipFetch=false;}else{$(".navigator-Container").show();}
this.$el.removeClass("ev-container");if(this.model.attributes.navigators.navigators.length>0&&!this.model.attributes.searchMetaData.dedup){if(!_.isUndefined(navigatorView)&&!_.isNull(navigatorView)){navigatorView.empty();}
this.showChildView("navigators",new RefineResultsView({model:this.model}));this.navDisableEnable();}
$('#navigators').on("input change propertychange","input",this.navDisableEnable);$("#results-per-page-select").select2({minimumResultsForSearch:Infinity,width:'20%'});$("#results-per-page-select-bottom").select2({minimumResultsForSearch:Infinity,width:'20%'});$("#sort-on-select").select2({minimumResultsForSearch:Infinity,width:'70%'});if(!this.isPageSelected()){$("#page-select").prop("checked",false);}
this.toggleOutputOptions();if(!this.model.attributes.searchMetaData.dedup&&!(this.model.attributes.searchMetaData.searchtype=='TagSearch')){var usageOrigin=this.getSearch().usageOrigin||"",usageZone=this.getSearch().usageZone||"";var routerURL=Backbone.history.location.pathname+"?SEARCHID="+this.model.attributes.searchMetaData.searchId
+"&COUNT="+this.model.attributes.pagenav.currentindex
+"&usageOrigin="+usageOrigin+"&usageZone="+usageZone;if(usageOrigin=="recordpage"||usageOrigin=="selectedrecords"||usageOrigin=="header"||usageOrigin=="savedsearch"||usageOrigin=="dedupresults"||usageOrigin=="affiliationresults"||usageOrigin=="authorresults"||usageOrigin=="morelikethis"||usageOrigin=="patentrefs"||usageOrigin=="nonpatentrefs"||usageOrigin=="compendexrefs"){app.router.navigate(routerURL,{replace:true});}else{app.router.navigate(routerURL,{replace:this.replace});this.replace=false;}
$('#ev-searchform-container').show();}
app.model.attributes.loadedSearchId=this.model.attributes.searchMetaData.searchId;var el=this.$el;BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"),function(){el.fadeIn('slow')});document.title='Engineering Village - '+this.model.attributes.searchMetaData.searchtype+' Search Results';if(!this.model.attributes.searchMetaData.dedup&&!(this.model.attributes.searchMetaData.searchtype=='TagSearch')){app.model.trigger("updateSearchEntity",this.model.attributes.searchMetaData.searchesEntity);Backbone.Radio.channel("resultHistoryChannel").request("backToResult",true);}
app.appChannel.trigger('ev:saveSearchAlerts',{statusCheck:this.model.attributes.searchMetaData.searchId});this.redirectafterLogin(param);if(app.sessionSettings.attributes.showPreview&&!(this.model.attributes.searchMetaData.searchtype=='TagSearch')){this.doPreviewAll(resultsView);}
Backbone.Radio.channel("highlightChannel").request("setStyles");if(!(this.model.attributes.searchMetaData.searchtype=='TagSearch')&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model)&&!_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.attributes)){this.highlight_CV();}
$('.autocomplete-results').hide();checkForOneClick();if(this.isMoreThan4kRecords()){$(".next-page-top").removeClass('not-active');}else{$(".next-page-top").addClass('not-active');}
app.model.attributes.searchHistoryCount.fetch();if(!(_.isUndefined(app.getRegion().currentView.searchView)||_.isUndefined(app.getRegion().currentView.searchView.searchFormView)||_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model)||_.isUndefined(app.getRegion().currentView.searchView.searchFormView.model.models))){Backbone.Radio.channel("searchResultChannel").request("savedAlertToggleOnLoad",this.model.attributes.searchMetaData.searchId);}
if(app.sessionSettings.attributes.isNavCollapsed&&this.model.attributes.searchMetaData.searchtype!='TagSearch'){var flag=JSON.parse(app.sessionSettings.attributes.isNavCollapsed);if(flag){$("#collapseNav").hide();$("#search-results").width('100%');$('#search-results .ev-left-nav-expanded').toggleClass('active');}else{$("#search-results").animate({width:'80%'});}}
return this;},navDisableEnable:function(event){$(".refineDisable").attr("disabled","disabled");var checked=$("#facetform").find("input[type='checkbox']:checked");var addTerm=$('#topappend');if(checked.length==0&&(addTerm&&$.trim(addTerm.val()).length==0)){$(".refineDisable").attr("disabled","disabled");return false;}else{$(".refineDisable").attr("disabled",false);}},highlight_CV:function(){var query=$.trim(app.getRegion().currentView.searchView.searchFormView.model.attributes.formValues.attributes.displayquery.toLowerCase());query=query.replace(/(AND|OR|NOT) /g,'');query=query.replace(/\(+|\)+|{+|}+/g,',');query=query.replace(/, +/g,',');query=query.replace(/,+/g,',');var qArray=query.split(',');var highlighted=false;if($("#nav_cv_panel")){$("#nav_cv_panel").find(".ev-checkbox-label span").each(function(){if(qArray.indexOf($.trim($(this).text().toLowerCase()))>0){if(!_.isUndefined(app.sessionSettings.attributes.highlight)){if($(".hit").length>0){$(this).addClass("hit");$(this).removeClass("bghit");}else{$(this).addClass("bghit");$(this).removeClass("hit");}}else{$(this).css('background-color','yellow');$(this).css('font-weight','bold');}
$(this).attr("title","Select term(s) to improve your results");highlighted=true;}});if(highlighted){if($('.facetbox').length>3){$('#nav_cv').insertBefore($('.facetbox')[0]);}}}
$('#nav_cv_panel').collapse("show")},doPreviewAll:function(resultsView){this.skipFetch=true;this.previewCollection=new AbstractPreviewCollection({"searchId":this.model.attributes.searchMetaData.searchId,"offset":this.model.attributes.pagenav.currentindex});$(resultsView.$el).find(".show-preview-content").each(function(){$(this).collapse("show");});this.previewCollection.fetch();},removeDupsSubmit:function(){$("#validationErrorText").css("display","none");if($("#dbprefdpx").val()=='none'){$("#errorText").html("Please select a Database Preference");$("#validationErrorText").css("display","block");return false;}else{$("#fieldpref").val($("#fieldprefdpx").val());$("#dbpref").val($("#dbprefdpx").val());app.router.navigate('/search/results/dedup.url?'+$('#dbpreferences').serialize(),false);app.appChannel.trigger("ev:sitecatalyst","newPage","/search/results/dedup.url");app.getRegion().currentView.renderRemoveDupsView();return false;}},checkForSearch:function(searchType){var curSearch=this.getSearch();if(searchType.toLowerCase()=='searchhistory'){searchType="expert";}
var url="/search/results/"+searchType+".url?"
if(!_.isEmpty(app.model.loadedSearchId)&&(this.model.attributes.searchMetaData.searchId==app.model.loadedSearchId)){return;}else if((!_.isEmpty(curSearch))&&(!_.isUndefined(curSearch))&&(!_.isUndefined(curSearch.SEARCHID)||!_.isUndefined(curSearch.searchid))){this.updateView($.param(curSearch)+"&isFullJsonResult=true&angularReq=true",url);}},changePageSize:function(e){this.model.changeResultsPerPage();},changePageSizeBottom:function(e){this.model.changeResultsPerPageBottom();},saveSearchCreateAlert:function(event){event.preventDefault?event.preventDefault():event.returnValue=false;var btn=$(event.currentTarget);var mark=btn.hasClass("saved")?"unmark":"mark";var searchId=this.model.attributes.searchMetaData.searchId;var type=btn.hasClass("EmailAlert")?"EmailAlert":"SavedSearch";var url=this.saveSearchAlert+'?selectvalue='+mark+'&option='+type+'&searchid='+searchId+'&database='+this.model.attributes.searchMetaData.database+'&backurl=SAVEDSEARCH&ajax=true';$.ajax({url:url,contentType:"application/json",success:function(data,status,xhr){btn.toggleClass("saved");if(type=='EmailAlert'&&mark=="mark"){$("#save-search-col .SavedSearch").addClass("saved");}else if(mark=="unmark"&&type=='SavedSearch'){$("#save-search-col .EmailAlert").removeClass("saved");}
app.appChannel.trigger('ev:saveSearchAlerts',(type=='EmailAlert')?{'EmailAlert':searchId}:{'SavedSearch':searchId})},error:function(xhr,status,thrown){if((xhr.responseText).indexOf('loginfull.url')!==-1){window.location.href=xhr.responseText;return;}
return;},complete:function(xhr,status){}});},refineQueryLinkHandler:function(event){var targetUrl=$(event.currentTarget).attr('href');if(targetUrl.indexOf('REMOVE=1')>-1){}else if(targetUrl.length>0){$(".result-row").remove();$("#loading-results").fadeIn();}
this.model.handleRefineQueryLink($(event.currentTarget).attr('href'));return false;},citedByLinkHandler:function(event){if($(event.currentTarget).attr('href').length>0){$(".result-row").remove();$("#loading-results").fadeIn();this.model.handleRefineQueryLink($(event.currentTarget).attr('href'));}
return false;},authorSearch:function(e){e.preventDefault();var url=$(e.currentTarget).attr('href');url+="&angularReq=true&isFullJsonResult=true";app.model.trigger("searchSubmitLink",url);return false;},updateView:function(params,url,callback){var self=this;this.$el.empty();this.renameSearchRows();BaseFeatureView.prototype.showHideCaptcha(false);BaseFeatureView.prototype.showhideLoading(true,$("#ev-searchhistory-container"));if(_.isEmpty(url)){this.model.url="/search/submit.url";}else{this.model.url=url;}
app.appChannel.request('application:setStatus','results',app.status.RESULTS_LOADING);this.callModelFetch(this.model.url,params,callback);},callModelFetch:function(url,params,callback){searchTimers.start=(new Date()).getTime();params+="&searchStartTimestamp="+searchTimers.start;this.model.fetch({cache:false,data:params,contentType:"application/json",accept:"application/json",success:function(model,response,options){searchTimers.end=(new Date()).getTime();var server_startTimestamp=model.attributes.searchMetaData.startServerTimestamp;var server_endTimestamp=model.attributes.searchMetaData.endServerTimestamp;var redirect_stopwatch=model.attributes.searchMetaData.redirectStopwatch;var server_stopwatch=server_endTimestamp-server_startTimestamp-redirect_stopwatch;app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);app.appChannel.request('application:setStatus','results',app.status.RESULTS_LOADED);if(!_.isUndefined(callback)&&_.isFunction(callback)){callback();}},error:function(xhr,status,error){app.appChannel.request('application:setStatus','results',app.status.NONE);BaseFeatureView.prototype.showhideLoading(false,$("#ev-searchhistory-container"));if(status.responseText&&status.responseText.indexOf('"error":"captcha')!=-1){BaseFeatureView.prototype.showHideCaptcha(true,status.responseJSON.imagetextenc,$("#ev-searchhistory-container"),self,self.verifyCaptchaCallback,{url:url,params:params,callback:callback});}else{if(status.status==400||status.status==500){app.model.trigger("ev:alert","error",'This search contains a syntax error.&nbsp;&nbsp;<a class="evpopup" href="'+app.model.attributes.rootApplicationProperties.HelpUrl+'#syntax_errors.htm" target="_blank" title="Learn more about search syntax (opens in a new window)">Learn more about search syntax</a>.',false);}else{Backbone.Radio.channel("globalError").request("displayErrorAlert",status);}}}});},verifyCaptchaCallback:function(callbackData){BaseFeatureView.prototype.showhideLoading(true,$("#ev-searchhistory-container"));this.callModelFetch(callbackData.url,callbackData.params,callbackData.callback);},renameSearchRows:function(){$(".search-row-copy").each(function(index){if(index>1){return false;}
$(this).find(".boolean").attr("name","boolean"+(index+1));$(this).find(".section").attr("name","section"+(index+2));$(this).find(".search-word").attr("name","searchWord"+(index+2));})},runSearch:function(params){},nextPage:function(event){if(this.isMoreThan4kRecords()){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("NEXT");}
return false;},isMoreThan4kRecords:function(){if((this.model.attributes.pagenav.currentindex<=4000&&this.model.attributes.pagenav.currentindex>(4000-this.model.attributes.pagenav.resultsperpage))||this.model.attributes.pagenav.currentindex>4000){app.model.trigger("ev:alert","info","You can only view the first 4000 records. Run a new search or reduce the number of results by using the Refine results panel.",false,true);return false;}else{return true;}},prevPage:function(event){$(".result-row").remove();$("#loading-results").fadeIn();this.model.getPage("PREV");return false;},selectPageByLink:function(e){$("#page-select").click();return false;},selectPage:function(e){var checked=$(".result-row :checkbox:checked").length;var boxes=$(".result-row :checkbox").length;var diff=boxes-checked;var params="";var url=this.basketMarkUrl;if(!$(e.target).is(":checked")){url=this.basketUnMarkUrl;$(".result-row :checkbox:checked").each(function(){params+="&docid="+$(this).attr("docid")+"&handle="+$(this).attr("handle");});}else{if(diff+app.model.attributes.selectedRecords>500){this.showSelect500Error();return false;}
$(".result-row :checkbox").each(function(){if(!$(this).is(":checked")){params+="&docid="+$(this).attr("docid")+"&handle="+$(this).attr("handle");}});}
$.post(url,params+"&searchid="+this.model.attributes.searchMetaData.searchId,function(data){app.model.attributes.selectedRecords=parseInt(data.count);app.model.trigger("change:selectedRecords");$(".result-row :checkbox").prop("checked",$(e.target).is(":checked"));});},selectMax:function(e){var url=this.basketMarkUrl;params="searchid="+this.model.attributes.searchMetaData.searchId+"&max=true";$("#select-max-modal .modal-loading").show();$("#select-max-modal .modal-footer").hide();$.post(url,params,function(data){app.model.attributes.selectedRecords=parseInt(data.count);app.model.trigger("change:selectedRecords");$(".result-row :checkbox").prop("checked",true);$("#page-select").prop("checked",true);}).always(function(){$("#select-max-modal").modal("hide");$("#select-max-modal .modal-loading").hide();setTimeout(function(){$("#select-max-modal .modal-footer").show();},500)});return false;},isPageSelected:function(){if($(".result-row :checkbox:checked").length==$(".result-row :checkbox").length){$("#page-select").prop("checked",true);return true;}
return false;},selectRecord:function(e){var self=this;if($(e.target).is(":checked")){if(app.model.attributes.selectedRecords>=500){this.showSelect500Error();return false;}
$.post(this.basketMarkUrl,"searchid="+this.model.attributes.searchMetaData.searchId+"&docid="+$(e.target).attr("docid")+"&handle="+$(e.target).attr("handle"),function(data){app.model.attributes.selectedRecords=parseInt(data.count);app.model.trigger("change:selectedRecords");self.isPageSelected();});}else{$.post(this.basketUnMarkUrl,"searchid="+this.model.attributes.searchMetaData.searchId+"&docid="+$(e.target).attr("docid")+"&handle="+$(e.target).attr("handle"),function(data){app.model.attributes.selectedRecords=parseInt(data.count);app.model.trigger("change:selectedRecords");});if($("#page-select").is(":checked")){$("#page-select").prop("checked",false);}}},emptyBasket:function(e){e.preventDefault();$.post(this.basketUnMarkUrl,"searchid="+this.model.attributes.searchMetaData.searchId+"&all=true",function(data){app.model.attributes.selectedRecords=parseInt(data.count);$(".result-row :checkbox").prop("checked",false);$("#page-select").prop("checked",false);app.model.trigger("change:selectedRecords");});},toggleOutputOptions:function(){if(app.model.attributes.selectedRecords==0){$("#email-print-dl a").addClass("disabled");$("#email-print-dl a").attr("tabindex","-1");$("#email-print-dl").addClass("button-disabled");$(".result-row :checkbox").prop("checked",false);$("#page-select").prop("checked",false);}else{$("#email-print-dl a").removeClass("disabled");$("#email-print-dl a").attr("tabindex","0");$("#email-print-dl").removeClass("button-disabled");}},showDupsPopup:function(event){event.preventDefault();if($(event.currentTarget).attr('href').length>0){var commonPopupView=new CommonPopupView({link:$(event.currentTarget).attr('href')});commonPopupView.show();}
return false;},emailModel:function(){var usageOrigin='searchresults';if(this.model.attributes.searchMetaData.dedup){usageOrigin='dedupresults';}else if(this.model.attributes.searchMetaData.searchtype=='TagSearch'){usageOrigin='tagresults';}
var DBParam='&database=';if(!(_.isUndefined(this.model.attributes.searchMetaData.searchesEntity)||_.isNull(this.model.attributes.searchMetaData.searchesEntity))){DBParam=DBParam+this.model.attributes.searchMetaData.searchesEntity.databasemask;}
var commonPopupView=new CommonPopupView({link:'/delivery/email/display.url?'+'&searchid='+encodeURIComponent(this.model.attributes.searchMetaData.searchId)+
DBParam+'&displayformat='+'citation'+'&timestamp='+new Date().getTime()+'&usageOrigin='+usageOrigin,});commonPopupView.show();return false;},printModel:function(){var usageOrigin='searchresults';if(this.model.attributes.searchMetaData.dedup){usageOrigin='dedupresults';}else if(this.model.attributes.searchMetaData.searchtype=='TagSearch'){usageOrigin='tagresults';}
var commonPopupView=new CommonPopupView({link:'/delivery/print/display.url?timestamp='+new Date().getTime()+'&displayformat='+'citation'+'&usageOrigin='+usageOrigin,});commonPopupView.show();return false;},abstractRender:function(e){var url;var target=e.target;while(target){if(target instanceof HTMLAnchorElement){url=target.getAttribute('href');break;}
target=target.parentNode;}
var alteredURL=url;if(!this.model.attributes.searchMetaData.searchtype.toLowerCase()=="tagsearch"){alteredURL=removeParam("docid",alteredURL);alteredURL=removeParam("ignore_docid",alteredURL);}
app.router.navigate(alteredURL,true);return false;},detailRender:function(e){var detailedURL=$(e.target).attr('href');app.router.navigate(detailedURL,true);return false;},oneDownloadClick:function(e){e.preventDefault();var usageOrigin='searchresults';if(this.model.attributes.searchMetaData.dedup){usageOrigin='dedupresults';}else if(this.model.attributes.searchMetaData.searchtype=='TagSearch'){usageOrigin='tagresults';}
basketDownloadSubmit(usageOrigin,this.model.attributes.searchMetaData.database,app.userSession.attributes.sessionId.id,undefined,this.model.attributes.searchMetaData.searchesEntity.sortOption.field,this.model.attributes.searchMetaData.searchesEntity.sortOption.direction);return false;},showDLTemplate:function(e){e.preventDefault();var usageOrigin='searchresults';if(this.model.attributes.searchMetaData.dedup){usageOrigin='dedupresults';}else if(this.model.attributes.searchMetaData.searchtype=='TagSearch'){usageOrigin='tagresults';}
var DBParam='&database=';if(!(_.isUndefined(this.model.attributes.searchMetaData.searchesEntity)||_.isNull(this.model.attributes.searchMetaData.searchesEntity))){DBParam=DBParam+this.model.attributes.searchMetaData.searchesEntity.databasemask;}
var commonPopupView=new CommonPopupView({link:'/delivery/download/display.url?'+'&searchid='+encodeURIComponent(this.model.attributes.searchMetaData.searchId)+
DBParam+'&displayformat='+'citation'+'&timestamp='+new Date().getTime()+'&usageOrigin='+usageOrigin});commonPopupView.show();return false;},changeSort:function(e){$(".result-row").remove();$("#loading-results").fadeIn();this.model.changeSort();},showRssFeedPopup:function(e){e.preventDefault();var url=encodeURI('/rss/feedurl.url?'+'database='+this.model.attributes.searchMetaData.database+'&term1='+this.model.attributes.searchMetaData.intermediatequery);this.rssFeedModel.fetch({url:url,contentType:"application/json",success:function(model,response,options){var rssFeedView=new RssFeedView(model),commonPopupView=new CommonPopupView({view:rssFeedView});commonPopupView.show();},error:function(){console.log("RSS feed request failed.");}});return false;},mapSearchResults:function(event){var searchUrl=$(event.currentTarget).val();$(".result-row").empty()
$("#loading-results").fadeIn();this.model.fetch({url:searchUrl,data:"isFullJsonResult=true&angularReq=true",contentType:"application/json",accept:"application/json",success:function(model,response,options){app.appChannel.trigger('ev:sitecatalyst','searchResultsUpdated',response);},error:function(){$("#loading-results").fadeOut();}});return false;},loadMaps:function(event){event.preventDefault();var id=$(event.currentTarget).attr("href");if(id!=null||id!=undefined){new MapView({"database":id});}else{console.log("there is no dabase selected");}}});var RssFeedView=Backbone.Marionette.View.extend({template:_.template($('#ev-rssFeed-template').html()),initialize:function(model){this.model=model;},render:function(){$("#common-modal-content-wrapper-id").html(this.template({rssFeedData:this.model.toJSON()}));}});function removeParam(key,sourceURL){if(_.isUndefined(sourceURL)||_.isNull(sourceURL)){return sourceURL;}
var rtn=sourceURL.split("?")[0],param,params_arr=[],queryString=(sourceURL.indexOf("?")!==-1)?sourceURL.split("?")[1]:"";if(queryString!==""){params_arr=queryString.split("&");for(var i=params_arr.length-1;i>=0;i-=1){param=params_arr[i].split("=")[0];if(param===key){params_arr.splice(i,1);}}
rtn=rtn+"?"+params_arr.join("&");}
return rtn;}